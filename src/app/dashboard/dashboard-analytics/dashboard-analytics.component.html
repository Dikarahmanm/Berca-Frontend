<!-- src/app/dashboard/dashboard-analytics/dashboard-analytics.component.html -->
<div class="dashboard-analytics">

  <!-- Header -->
  <div class="analytics-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon>analytics</mat-icon>
          Business Analytics
        </h1>
        <p class="page-subtitle">Real-time insights & performance metrics</p>
      </div>

      <div class="header-actions">
        <mat-form-field appearance="outline" class="period-selector">
          <mat-label>Period</mat-label>
          <mat-select [(value)]="selectedPeriod" (selectionChange)="onPeriodChange()">
            <mat-option value="today">Hari Ini</mat-option>
            <mat-option value="week">7 Hari Terakhir</mat-option>
            <mat-option value="month">30 Hari Terakhir</mat-option>
            <mat-option value="year">1 Tahun Terakhir</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="refreshData()" [disabled]="isLoading">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="60"></mat-spinner>
    <p>Memuat data analytics...</p>
  </div>

  <!-- Main Content -->
  <div class="analytics-content" *ngIf="!isLoading && currentKPIs">

    <!-- Quick Stats Section - Moved to top -->
    <section class="quick-stats-section" *ngIf="currentQuickStats">
      <div class="section-header">
        <h2>Quick Stats</h2>
        <p>Ringkasan performa hari ini</p>
      </div>
      
      <div class="quick-stats-grid">
        <div class="quick-stat-card revenue">
          <div class="stat-icon">
            <mat-icon>attach_money</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatCurrency(currentQuickStats.todayRevenue) }}</div>
            <div class="stat-label">Pendapatan Hari Ini</div>
            <div class="stat-change positive" *ngIf="currentQuickStats.revenueGrowthPercentage > 0">
              <mat-icon>trending_up</mat-icon>
              <span>+{{ formatNumber(currentQuickStats.revenueGrowthPercentage) }}%</span>
            </div>
          </div>
        </div>

        <div class="quick-stat-card transactions">
          <div class="stat-icon">
            <mat-icon>receipt</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatNumber(currentQuickStats.todayTransactions) }}</div>
            <div class="stat-label">Transaksi Hari Ini</div>
            <div class="stat-meta">Transaksi berhasil</div>
          </div>
        </div>

        <div class="quick-stat-card alerts">
          <div class="stat-icon">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatNumber(currentQuickStats.lowStockAlerts) }}</div>
            <div class="stat-label">Stok Menipis</div>
            <div class="stat-meta">Produk perlu restock</div>
          </div>
        </div>

        <div class="quick-stat-card members">
          <div class="stat-icon">
            <mat-icon>people</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatNumber(currentQuickStats.activeMembers) }}</div>
            <div class="stat-label">Member Aktif</div>
            <div class="stat-meta">Member terdaftar</div>
          </div>
        </div>
      </div>
    </section>

    <!-- KPI Cards -->
    <section class="kpi-section">
      <div class="section-header">
        <h2>Key Performance Indicators</h2>
        <p>Metrik performa utama bisnis</p>
      </div>
      
      <div class="kpi-grid">
        <div class="kpi-card revenue">
          <div class="kpi-icon">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-value">{{ formatCurrency(currentKPIs.todayRevenue) }}</div>
            <div class="kpi-label">Pendapatan Hari Ini</div>
            <div class="kpi-meta">{{ formatNumber(currentKPIs.todayTransactions) }} transaksi</div>
          </div>
        </div>

        <div class="kpi-card monthly">
          <div class="kpi-icon">
            <mat-icon>calendar_month</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-value">{{ formatCurrency(currentKPIs.monthlyRevenue) }}</div>
            <div class="kpi-label">Pendapatan Bulanan</div>
            <div class="kpi-meta">{{ formatNumber(currentKPIs.monthlyTransactions) }} transaksi</div>
          </div>
        </div>

        <div class="kpi-card products">
          <div class="kpi-icon">
            <mat-icon>inventory_2</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-value">{{ formatNumber(currentKPIs.totalProducts) }}</div>
            <div class="kpi-label">Total Produk</div>
            <div class="kpi-meta">{{ formatNumber(currentKPIs.lowStockProducts) }} stok rendah</div>
          </div>
        </div>

        <div class="kpi-card profit">
          <div class="kpi-icon">
            <mat-icon>savings</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-value">{{ formatCurrency(currentKPIs.totalProfit) }}</div>
            <div class="kpi-label">Total Profit</div>
            <div class="kpi-meta">Rata-rata: {{ formatCurrency(currentKPIs.averageTransactionValue) }}</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Products Analytics -->
    <section class="products-section">
      <div class="products-grid">
        
        <!-- Top Selling Products -->
        <div class="product-card top-products">
          <div class="card-header">
            <h3>
              <mat-icon>trending_up</mat-icon>
              Produk Terlaris
            </h3>
            <button mat-button color="primary" (click)="navigateToProducts()">
              Lihat Semua
            </button>
          </div>
          
          <div class="product-list" *ngIf="topProducts.length > 0; else noTopProducts">
            <div class="top-product-item" *ngFor="let product of topProducts; let i = index">
              <!-- Header with rank and weighted score -->
              <div class="product-header">
                <div class="rank-badge success">{{ i + 1 }}</div>
                <div class="product-basic-info">
                  <div class="product-name">{{ product.productName }}</div>
                  <div class="product-barcode">{{ product.productBarcode }}</div>
                </div>
                <div class="weighted-score" [ngClass]="getTopProductScoreClass(product.weightedScore)">
                  {{ formatNumber(safeValue(product.weightedScore)) }}
                </div>
              </div>

              <!-- Performance metrics section -->
              <div class="performance-section">
                <div class="profit-margin-chip" [ngClass]="getProfitMarginClass(product.profitMargin)">
                  <mat-icon>percent</mat-icon>
                  {{ formatPercentage(safeValue(product.profitMargin)) }} Margin
                </div>
              </div>

              <!-- Key metrics in compact format -->
              <div class="metrics-grid">
                <div class="metric">
                  <div class="metric-value">{{ formatNumber(safeValue(product.totalQuantitySold)) }}</div>
                  <div class="metric-label">Terjual</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{{ formatNumber(safeValue(product.transactionCount)) }}</div>
                  <div class="metric-label">Transaksi</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{{ formatNumber(safeValue(product.averageQuantityPerTransaction)) }}</div>
                  <div class="metric-label">Avg/Trx</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{{ formatCurrency(safeValue(product.totalRevenue)) }}</div>
                  <div class="metric-label">Revenue</div>
                </div>
              </div>

              <!-- Action button -->
              <div class="product-actions">
                <button mat-icon-button (click)="viewProductDetails(product.productId)" class="action-btn">
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            </div>
          </div>
          
          <ng-template #noTopProducts>
            <div class="empty-state">
              <mat-icon>inventory_2</mat-icon>
              <p>Belum ada data produk terlaris</p>
            </div>
          </ng-template>
        </div>

        <!-- Worst Performing Products -->
        <div class="product-card worst-products">
          <div class="card-header">
            <h3>
              <mat-icon>trending_down</mat-icon>
              Produk Performa Buruk
            </h3>
            <div class="header-actions">
              <mat-form-field appearance="outline" class="category-filter">
                <mat-label>Filter Kategori</mat-label>
                <mat-select [(value)]="selectedWorstCategory" (selectionChange)="onWorstCategoryChange()">
                  <mat-option value="all">Semua Kategori</mat-option>
                  <mat-option *ngFor="let category of getWorstCategories()" [value]="category">
                    {{ category }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <button mat-button color="warn" (click)="navigateToProducts()">
                Lihat Semua
              </button>
            </div>
          </div>
          
          <div class="product-list" *ngIf="getSortedWorstProducts().length > 0; else noWorstProducts">
            <div class="worst-product-item" 
                 [attr.data-category]="product.performanceCategory"
                 *ngFor="let product of getSortedWorstProducts(); let i = index">
              <!-- Header with rank and category -->
              <div class="product-header">
                <div class="rank-badge">{{ i + 1 }}</div>
                <div class="product-basic-info">
                  <div class="product-name">{{ product.productName }}</div>
                  <div class="product-barcode">{{ product.productBarcode }}</div>
                </div>
                <div class="performance-score" [ngClass]="getPerformanceScoreClass(product.performanceScore)">
                  {{ product.performanceScore }}
                </div>
              </div>

              <!-- Performance category chip -->
              <div class="category-section">
                <mat-chip 
                  [color]="getPerformanceCategoryColor(product.performanceCategory)" 
                  class="category-chip"
                  [attr.data-category]="product.performanceCategory">
                  <mat-icon>{{ getPerformanceCategoryIcon(product.performanceCategory) }}</mat-icon>
                  {{ product.performanceCategory }}
                </mat-chip>
              </div>

              <!-- Key metrics in compact format -->
              <div class="metrics-grid">
                <div class="metric">
                  <div class="metric-value">{{ formatNumber(safeValue(product.totalQuantitySold)) }}</div>
                  <div class="metric-label">Terjual</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{{ formatNumber(safeValue(product.currentStock)) }}</div>
                  <div class="metric-label">Stok</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{{ formatNumber(safeValue(product.daysWithoutSale)) }}</div>
                  <div class="metric-label">Hari</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{{ formatCurrency(safeValue(product.totalRevenue)) }}</div>
                  <div class="metric-label">Revenue</div>
                </div>
              </div>

              <!-- Action button -->
              <div class="product-actions">
                <button mat-icon-button (click)="viewProductDetails(product.productId)" class="action-btn">
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            </div>
          </div>
          
          <ng-template #noWorstProducts>
            <div class="empty-state">
              <mat-icon>trending_down</mat-icon>
              <p>Belum ada data produk performa buruk</p>
            </div>
          </ng-template>
        </div>
      </div>
    </section>

    <!-- Revenue by Category -->
    <section class="category-revenue-section">
      <div class="card-header">
        <h3>
          <mat-icon>pie_chart</mat-icon>
          Pendapatan per Kategori
        </h3>
        <button mat-button color="primary" (click)="navigateToReports()">
          Lihat Detail
        </button>
      </div>
      
      <div class="category-grid" *ngIf="categorySales.length > 0; else noCategoryData">
        <div class="category-item" *ngFor="let category of categorySales">
          <div class="category-color" [style.background-color]="category.categoryColor"></div>
          <div class="category-info">
            <div class="category-name">{{ category.categoryName }}</div>
            <div class="category-stats">
              <span>{{ formatNumber(category.productCount) }} produk</span>
              <span>â€¢</span>
              <span>{{ formatNumber(category.totalQuantitySold) }} terjual</span>
            </div>
          </div>
          <div class="category-revenue">
            <div class="revenue-amount">{{ formatCurrency(category.totalRevenue) }}</div>
            <div class="transaction-count">{{ formatNumber(category.transactionCount) }} transaksi</div>
          </div>
        </div>
      </div>
      
      <ng-template #noCategoryData>
        <div class="empty-state">
          <mat-icon>category</mat-icon>
          <p>Belum ada data penjualan per kategori</p>
        </div>
      </ng-template>
    </section>

    <!-- Recent Transactions -->
    <section class="transactions-section">
      <div class="card-header">
        <h3>
          <mat-icon>receipt_long</mat-icon>
          Transaksi Terbaru
        </h3>
        <button mat-button color="primary" (click)="navigateToTransactions()">
          Lihat Semua
        </button>
      </div>
      
      <div class="transactions-list" *ngIf="recentTransactions.length > 0; else noTransactions">
        <div class="transaction-item" *ngFor="let transaction of recentTransactions">
          <div class="transaction-id">
            <mat-icon>receipt</mat-icon>
            <span>{{ transaction.saleNumber }}</span>
          </div>
          <div class="transaction-info">
            <div class="transaction-customer">{{ transaction.customerName || 'Customer' }}</div>
            <div class="transaction-cashier">Kasir: {{ transaction.cashierName || 'Unknown' }}</div>
            <div class="transaction-date">{{ transaction.saleDate | date:'dd/MM/yyyy HH:mm' }}</div>
          </div>
          <div class="transaction-details">
            <div class="transaction-amount">{{ formatCurrency(transaction.total) }}</div>
            <div class="transaction-items">{{ formatNumber(transaction.itemCount) }} item</div>
            <div class="transaction-method">{{ transaction.paymentMethod }}</div>
          </div>
          <button mat-icon-button (click)="viewTransactionDetails(transaction)">
            <mat-icon>visibility</mat-icon>
          </button>
        </div>
      </div>
      
      <ng-template #noTransactions>
        <div class="empty-state">
          <mat-icon>receipt_long</mat-icon>
          <p>Belum ada transaksi terbaru</p>
        </div>
      </ng-template>
    </section>

    <!-- Low Stock Alerts -->
    <section class="low-stock-section">
      <div class="card-header">
        <h3>
          <mat-icon>warning</mat-icon>
          Peringatan Stok Menipis
          <mat-chip-set>
            <mat-chip color="warn">{{ lowStockAlerts.length }} items</mat-chip>
          </mat-chip-set>
        </h3>
        <button mat-button color="warn" (click)="navigateToInventory()">
          Kelola Stok
        </button>
      </div>
      
      <div class="low-stock-list" *ngIf="lowStockAlerts.length > 0; else noLowStock">
        <div class="low-stock-item" *ngFor="let item of lowStockAlerts">
          <div class="stock-status" [ngClass]="item.isOutOfStock ? 'out-of-stock' : 'low-stock'">
            <mat-icon>{{ item.isOutOfStock ? 'block' : 'warning' }}</mat-icon>
          </div>
          <div class="item-info">
            <div class="item-name">{{ item.name }}</div>
            <div class="item-category">{{ item.categoryName }}</div>
            <div class="item-barcode">{{ item.barcode }}</div>
          </div>
          <div class="stock-info">
            <div class="current-stock" [ngClass]="item.isOutOfStock ? 'danger' : 'warning'">
              {{ formatNumber(item.stock) }} {{ item.unit }}
            </div>
            <div class="min-stock">Min: {{ formatNumber(item.minimumStock) }}</div>
            <div class="stock-status-text">
              {{ item.isOutOfStock ? 'Habis' : 'Stok Rendah' }}
            </div>
          </div>
          <div class="item-actions">
            <button mat-raised-button color="{{ item.isOutOfStock ? 'warn' : 'accent' }}" size="small" (click)="viewProductDetails(item.id)">
              {{ item.isOutOfStock ? 'Restock Sekarang' : 'Lihat Detail' }}
            </button>
          </div>
        </div>
      </div>
      
      <ng-template #noLowStock>
        <div class="empty-state success">
          <mat-icon>check_circle</mat-icon>
          <p>Semua produk memiliki stok yang mencukupi</p>
        </div>
      </ng-template>
    </section>

  </div>

  <!-- Empty State -->
  <div class="empty-dashboard" *ngIf="!isLoading && !currentKPIs">
    <mat-icon>analytics</mat-icon>
    <h2>Belum Ada Data Analytics</h2>
    <p>Data analytics akan muncul setelah ada transaksi dan aktivitas bisnis</p>
    <button mat-raised-button color="primary" (click)="refreshData()">
      <mat-icon>refresh</mat-icon>
      Muat Ulang Data
    </button>
  </div>

</div>