<!-- src/app/dashboard/dashboard-analytics/dashboard-analytics.component.html -->
<div class="dashboard-analytics">

    <!-- Header -->
    <div class="analytics-header glass-card">
        <div class="header-content">
            <div class="title-section">
                <h1 class="page-title">
                    <mat-icon>analytics</mat-icon>
                    Dashboard Analytics
                </h1>
                <p class="page-subtitle">Real-time business insights & performance metrics</p>
            </div>

            <div class="header-actions">
                <mat-form-field appearance="outline" class="period-selector">
                    <mat-label>Period</mat-label>
                    <mat-select [(value)]="selectedPeriod" (selectionChange)="onPeriodChange()">
                        <mat-option value="today">Today</mat-option>
                        <mat-option value="week">Last Week</mat-option>
                        <mat-option value="month">Last Month</mat-option>
                        <mat-option value="year">Last Year</mat-option>
                    </mat-select>
                </mat-form-field>

                <button mat-raised-button color="primary" (click)="refreshData()" [disabled]="isLoading">
                    <mat-icon>refresh</mat-icon>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="isLoading">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading analytics data...</p>
    </div>

    <!-- Main Content & Empty State -->
    <ng-container *ngIf="!isLoading">
        <ng-container *ngIf="kpis$ | async as kpis; else emptyState">
            <div class="analytics-content">

                <!-- KPI Cards -->
                <section class="kpi-section">
                    <div class="kpi-grid">

                        <!-- Today Sales -->
                        <div class="kpi-card glass-card sales">
                            <div class="kpi-icon">
                                <mat-icon>trending_up</mat-icon>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">{{ formatCurrency(kpis.todaySales) }}</div>
                                <div class="kpi-label">Today's Sales</div>
                                <div class="kpi-growth growth-positive">
                                    <mat-icon>trending_up</mat-icon>
                                    <span>+12.5%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Sales -->
                        <div class="kpi-card glass-card revenue">
                            <div class="kpi-icon">
                                <mat-icon>calendar_month</mat-icon>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">{{ formatCurrency(kpis.monthlySales) }}</div>
                                <div class="kpi-label">Monthly Sales</div>
                                <div class="kpi-growth growth-positive">
                                    <mat-icon>trending_up</mat-icon>
                                    <span>+8.3%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Total Orders -->
                        <div class="kpi-card glass-card orders">
                            <div class="kpi-icon">
                                <mat-icon>shopping_cart</mat-icon>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">{{ formatNumber(kpis.totalOrders) }}</div>
                                <div class="kpi-label">Total Orders</div>
                                <div class="kpi-growth growth-positive">
                                    <mat-icon>trending_up</mat-icon>
                                    <span>+15.2%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Average Order Value -->
                        <div class="kpi-card glass-card aov">
                            <div class="kpi-icon">
                                <mat-icon>attach_money</mat-icon>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">{{ formatCurrency(kpis.averageOrderValue) }}</div>
                                <div class="kpi-label">Avg Order Value</div>
                                <div class="kpi-growth growth-negative">
                                    <mat-icon>trending_down</mat-icon>
                                    <span>-2.1%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Total Profit -->
                        <div class="kpi-card glass-card profit">
                            <div class="kpi-icon">
                                <mat-icon>account_balance_wallet</mat-icon>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">{{ formatCurrency(kpis.totalProfit) }}</div>
                                <div class="kpi-label">Total Profit</div>
                                <div class="kpi-growth growth-positive">
                                    <mat-icon>trending_up</mat-icon>
                                    <span>+18.7%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Low Stock Alert -->
                        <div class="kpi-card glass-card stock-alert" [class.warning]="kpis.lowStockProducts > 0">
                            <div class="kpi-icon">
                                <mat-icon>warning</mat-icon>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">{{ formatNumber(kpis.lowStockProducts) }}</div>
                                <div class="kpi-label">Low Stock Items</div>
                                <div class="kpi-action" *ngIf="kpis.lowStockProducts > 0">
                                    <button mat-button color="warn" (click)="navigateToInventory()">
                                        View Items
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </section>

        <!-- Charts Section -->
        <section class="charts-section">
            <div class="charts-grid">

                <!-- Sales Trend Chart -->
                <div class="chart-card glass-card sales-chart">
                    <div class="chart-header">
                        <h3>Sales Trend</h3>
                        <mat-form-field appearance="outline" class="chart-period-selector">
                            <mat-select [(value)]="selectedChartPeriod" (selectionChange)="onChartPeriodChange()">
                                <mat-option value="daily">Daily</mat-option>
                                <mat-option value="weekly">Weekly</mat-option>
                                <mat-option value="monthly">Monthly</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>

                    <div class="chart-container">
                        <div class="chart-placeholder">
                            <mat-icon>trending_up</mat-icon>
                            <p>Chart implementation coming soon</p>
                        </div>
                    </div>
                </div>

                <!-- Revenue by Category Pie Chart -->
                <div class="chart-card glass-card category-chart">
                    <div class="chart-header">
                        <h3>Revenue by Category</h3>
                    </div>

                    <div class="chart-container">
                        <div class="chart-placeholder">
                            <mat-icon>pie_chart</mat-icon>
                            <p>Chart implementation coming soon</p>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Data Tables Section -->
        <section class="tables-section">
            <div class="tables-grid">

                <!-- Top Products -->
                <div class="table-card glass-card top-products">
                    <div class="table-header">
                        <h3>Top Selling Products</h3>
                        <button mat-button color="primary" (click)="navigateToProducts()">
                            View All
                        </button>
                    </div>

                    <div class="table-container">
                        <table mat-table [dataSource]="topProducts" class="products-table">

                            <ng-container matColumnDef="product">
                                <th mat-header-cell *matHeaderCellDef>Product</th>
                                <td mat-cell *matCellDef="let product">
                                    <div class="product-info">
                                        <div class="product-name">{{ product.productName }}</div>
                                        <div class="product-category">{{ product.category }}</div>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="quantity">
                                <th mat-header-cell *matHeaderCellDef>Qty Sold</th>
                                <td mat-cell *matCellDef="let product">
                                    <span class="quantity-badge">{{ formatNumber(product.quantitySold) }}</span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="revenue">
                                <th mat-header-cell *matHeaderCellDef>Revenue</th>
                                <td mat-cell *matCellDef="let product">
                                    <span class="revenue-value">{{ formatCurrency(product.totalRevenue) }}</span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="margin">
                                <th mat-header-cell *matHeaderCellDef>Margin</th>
                                <td mat-cell *matCellDef="let product">
                                    <mat-chip class="margin-chip" [class.high-margin]="product.profitMargin >= 30"
                                        [class.low-margin]="product.profitMargin < 15">
                                        {{ formatPercentage(product.profitMargin) }}
                                    </mat-chip>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="['product', 'quantity', 'revenue', 'margin']"></tr>
                            <tr mat-row *matRowDef="let row; columns: ['product', 'quantity', 'revenue', 'margin']">
                            </tr>

                        </table>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="table-card glass-card recent-transactions">
                    <div class="table-header">
                        <h3>Recent Transactions</h3>
                        <button mat-button color="primary" (click)="navigateToReports()">
                            View All
                        </button>
                    </div>

                    <div class="table-container">
                        <table mat-table [dataSource]="recentTransactions" class="transactions-table">

                            <ng-container matColumnDef="transaction">
                                <th mat-header-cell *matHeaderCellDef>Transaction</th>
                                <td mat-cell *matCellDef="let txn">
                                    <div class="transaction-info">
                                        <div class="transaction-number">{{ txn.saleNumber }}</div>
                                        <div class="transaction-date">{{ txn.saleDate | date:'dd/MM HH:mm' }}</div>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="customer">
                                <th mat-header-cell *matHeaderCellDef>Customer</th>
                                <td mat-cell *matCellDef="let txn">
                                    <div class="customer-info">
                                        <div class="customer-name" *ngIf="txn.memberName; else guestCustomer">
                                            {{ txn.memberName }}
                                            <mat-icon class="member-icon">card_membership</mat-icon>
                                        </div>
                                        <ng-template #guestCustomer>
                                            <span class="guest-label">Guest</span>
                                        </ng-template>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="items">
                                <th mat-header-cell *matHeaderCellDef>Items</th>
                                <td mat-cell *matCellDef="let txn">
                                    <span class="items-count">{{ txn.itemCount }} items</span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="total">
                                <th mat-header-cell *matHeaderCellDef>Total</th>
                                <td mat-cell *matCellDef="let txn">
                                    <span class="transaction-total">{{ formatCurrency(txn.total) }}</span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef>Status</th>
                                <td mat-cell *matCellDef="let txn">
                                    <mat-chip [class]="'status-' + getStatusColor(txn.status)">
                                        {{ txn.status }}
                                    </mat-chip>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef></th>
                                <td mat-cell *matCellDef="let txn">
                                    <button mat-icon-button (click)="viewTransactionDetails(txn)" title="View Details">
                                        <mat-icon>visibility</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row
                                *matHeaderRowDef="['transaction', 'customer', 'items', 'total', 'status', 'actions']">
                            </tr>
                            <tr mat-row
                                *matRowDef="let row; columns: ['transaction', 'customer', 'items', 'total', 'status', 'actions']"
                                class="clickable-row" (click)="viewTransactionDetails(row)"></tr>

                        </table>
                    </div>
                </div>

            </div>
        </section>

        <!-- Alerts & Quick Stats -->
        <section class="alerts-section" *ngIf="lowStockAlerts.length > 0 || (quickStats$ | async) as quickStats">
            <div class="alerts-grid">

                <!-- Low Stock Alerts -->
                <div class="alert-card glass-card low-stock-alerts" *ngIf="lowStockAlerts.length > 0">
                    <div class="alert-header">
                        <h3>
                            <mat-icon class="warning-icon">warning</mat-icon>
                            Low Stock Alerts
                        </h3>
                        <mat-chip [matBadge]="lowStockAlerts.length" matBadgeColor="warn">
                            {{ lowStockAlerts.length }} items
                        </mat-chip>
                    </div>

                    <div class="alert-content">
                        <div class="stock-alert-item" *ngFor="let item of lowStockAlerts.slice(0, 5)">
                            <div class="alert-product-info">
                                <div class="product-name">{{ item.productName }}</div>
                                <div class="product-category">{{ item.categoryName }}</div>
                            </div>
                            <div class="stock-info">
                                <span class="current-stock"
                                    [class]="getStockStatusColor(item.currentStock, item.minimumStock)">
                                    {{ item.currentStock }}
                                </span>
                                <span class="stock-separator">/</span>
                                <span class="min-stock">{{ item.minimumStock }}</span>
                            </div>
                        </div>

                        <button mat-button color="warn" class="view-all-alerts" (click)="navigateToInventory()"
                            *ngIf="lowStockAlerts.length > 5">
                            View All {{ lowStockAlerts.length }} Alerts
                        </button>
                    </div>
                </div>

                <!-- Quick Stats Summary -->
                <div class="alert-card glass-card quick-stats" *ngIf="quickStats$ | async as quickStats">
                    <div class="alert-header">
                        <h3>
                            <mat-icon>speed</mat-icon>
                            Quick Stats
                        </h3>
                    </div>

                    <div class="quick-stats-grid">

                        <div class="quick-stat-item">
                            <div class="stat-icon transactions">
                                <mat-icon>receipt</mat-icon>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">{{ formatNumber(quickStats.todayTransactions) }}</div>
                                <div class="stat-label">Today's Transactions</div>
                            </div>
                        </div>

                        <div class="quick-stat-item">
                            <div class="stat-icon revenue">
                                <mat-icon>monetization_on</mat-icon>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">{{ formatCurrency(quickStats.todayRevenue) }}</div>
                                <div class="stat-label">Today's Revenue</div>
                            </div>
                        </div>

                        <div class="quick-stat-item">
                            <div class="stat-icon avg-transaction">
                                <mat-icon>trending_up</mat-icon>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">{{ formatCurrency(quickStats.averageTransactionValue) }}</div>
                                <div class="stat-label">Avg Transaction</div>
                            </div>
                        </div>

                        <div class="quick-stat-item">
                            <div class="stat-icon top-product">
                                <mat-icon>star</mat-icon>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">{{ quickStats.topSellingProduct }}</div>
                                <div class="stat-label">Top Product</div>
                            </div>
                        </div>

                        <div class="quick-stat-item">
                            <div class="stat-icon members">
                                <mat-icon>people</mat-icon>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">{{ formatNumber(quickStats.activeMembers) }}</div>
                                <div class="stat-label">Active Members</div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </section>

            </div>
        </ng-container>
        
        <ng-template #emptyState>
            <div class="empty-state">
                <div class="empty-icon">
                    <mat-icon>analytics</mat-icon>
                </div>
                <h3>No Analytics Data Available</h3>
                <p>Start making sales to see your business analytics here.</p>
                <button mat-raised-button color="primary" routerLink="/pos">
                    Start Selling
                </button>
            </div>
        </ng-template>
    </ng-container>

</div>