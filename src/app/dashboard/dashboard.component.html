<!-- src/app/dashboard/dashboard.component.html -->
<!-- âœ… REDESIGNED: Dashboard Template menggunakan Base Layout yang konsisten -->

<app-base-layout pageTitle="Dashboard" pageSubtitle="Sistem Point of Sale Toko Eniwan"
  [showPageHeader]="isDashboardHome" [showHeaderActions]="isDashboardHome" [isLoading]="isLoadingStats"
  loadingMessage="Loading dashboard data..." [errorMessage]="error || undefined" (retryClicked)="handleRetry()">

  <!-- Header Actions Slot -->
  <div slot="header-actions" *ngIf="isDashboardHome">
    <button class="action-btn primary-btn" (click)="navigateTo('/pos')">
      <mat-icon>point_of_sale</mat-icon>
      Mulai Transaksi
    </button>
    <button class="action-btn secondary-btn" (click)="navigateTo('/dashboard/inventory')">
      <mat-icon>inventory_2</mat-icon>
      Kelola Stok
    </button>
  </div>

  <!-- Main Dashboard Content (only when at /dashboard route) -->
  <div class="dashboard-home" *ngIf="isDashboardHome">

    <!-- Welcome Section -->
    <section class="welcome-section">
      <div class="welcome-card glass-card">
        <div class="welcome-content">
          <div class="welcome-text">
            <h2>{{ getGreeting() }}, {{ username }}! ðŸ‘‹</h2>
            <p class="welcome-date">{{ getCurrentDate() }}</p>
            <p class="welcome-subtitle">Selamat datang di sistem POS Toko Eniwan</p>
          </div>

          <div class="welcome-stats">
            <div class="stat-item">
              <div class="stat-value">{{ formatCurrency(dashboardStats.dailySales) }}</div>
              <div class="stat-label">Penjualan Hari Ini</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ formatNumber(dashboardStats.totalProducts) }}</div>
              <div class="stat-label">Total Produk</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Stats Grid -->
    <section class="stats-section">
      <div class="section-header">
        <h2>Statistik Sistem</h2>
        <p>Overview performa bisnis Anda</p>
      </div>

      <div class="stats-grid">
        <!-- Total Users -->
        <div class="stat-card glass-card">
          <div class="stat-icon users">
            <mat-icon>people</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatNumber(userStats.total) }}</div>
            <div class="stat-label">Total Users</div>
            <div class="stat-meta">
              <span class="stat-detail active">{{ userStats.active }} active</span>
            </div>
          </div>
        </div>

        <!-- Categories -->
        <div class="stat-card glass-card">
          <div class="stat-icon categories">
            <mat-icon>category</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatNumber(totalCategories) }}</div>
            <div class="stat-label">Categories</div>
            <div class="stat-meta">
              <span class="stat-detail">Produk dikategorikan</span>
            </div>
          </div>
        </div>

        <!-- Products -->
        <div class="stat-card glass-card">
          <div class="stat-icon products">
            <mat-icon>inventory_2</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatNumber(totalProducts) }}</div>
            <div class="stat-label">Total Products</div>
            <div class="stat-meta">
              <span class="stat-detail warning" *ngIf="lowStockCount > 0">
                {{ lowStockCount }} stok rendah
              </span>
              <span class="stat-detail positive" *ngIf="lowStockCount === 0">
                Stok mencukupi
              </span>
            </div>
          </div>
        </div>

        <!-- Daily Sales -->
        <div class="stat-card glass-card">
          <div class="stat-icon sales">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatCurrency(dashboardStats.dailySales) }}</div>
            <div class="stat-label">Penjualan Hari Ini</div>
            <div class="stat-meta">
              <span class="stat-detail positive">Target tercapai</span>
            </div>
          </div>
        </div>

        <!-- Monthly Sales -->
        <div class="stat-card glass-card">
          <div class="stat-icon monthly">
            <mat-icon>calendar_month</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatCurrency(dashboardStats.monthlySales) }}</div>
            <div class="stat-label">Penjualan Bulan Ini</div>
            <div class="stat-meta">
              <span class="stat-detail">Performa bulanan</span>
            </div>
          </div>
        </div>

        <!-- Notifications -->
        <div class="stat-card glass-card clickable" (click)="openNotifications()">
          <div class="stat-icon notifications">
            <mat-icon>notifications</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ formatNumber(recentNotifications.length) }}</div>
            <div class="stat-label">Notifikasi</div>
            <div class="stat-meta">
              <span class="stat-detail">Lihat semua</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions-section">
      <div class="section-header">
        <h2>Quick Actions</h2>
        <p>Akses cepat ke fitur utama sistem</p>
      </div>

      <div class="quick-actions-grid">
        <div class="quick-action-card glass-card" *ngFor="let action of quickActions; trackBy: trackByQuickActionId"
          [class.disabled]="!action.enabled" (click)="executeQuickAction(action)">

          <div class="action-icon" [ngClass]="action.color">
            <mat-icon>{{ action.icon }}</mat-icon>
          </div>

          <div class="action-content">
            <h3>{{ action.title }}</h3>
            <p>{{ action.description }}</p>
          </div>

          <div class="action-arrow">
            <mat-icon>arrow_forward</mat-icon>
          </div>
        </div>
      </div>
    </section>

    <!-- Content Grid: Recent Activity & Notifications -->
    <section class="content-grid-section">

      <!-- Recent Activity -->
      <div class="content-card">
        <div class="card-header">
          <h2>Aktivitas Terbaru</h2>
          <button class="view-all-btn" (click)="navigateTo('/dashboard/logs')">
            <span>Lihat Semua</span>
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>

        <div class="activity-list glass-card">
          <div class="activity-item" *ngFor="let activity of recentActivities; trackBy: trackByActivityId"
            (click)="navigateTo('/dashboard/logs')">

            <div class="activity-icon" [ngClass]="activity.type">
              <mat-icon>{{ activity.icon }}</mat-icon>
            </div>

            <div class="activity-content">
              <div class="activity-text">{{ activity.description }}</div>
              <div class="activity-time">{{ activity.time }}</div>
            </div>
          </div>

          <div class="activity-empty" *ngIf="recentActivities.length === 0">
            <mat-icon>history</mat-icon>
            <p>Belum ada aktivitas</p>
          </div>
        </div>
      </div>

      <!-- Recent Notifications -->
      <div class="content-card">
        <div class="card-header">
          <h2>Notifikasi Terbaru</h2>
          <button class="view-all-btn" (click)="navigateTo('/notifications')">
            <span>Lihat Semua</span>
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>

        <div class="notification-list glass-card">
          <div class="notification-item"
            *ngFor="let notification of recentNotifications; trackBy: trackByNotificationId"
            [class.unread]="!notification.isRead" (click)="navigateTo('/notifications')">

            <div class="notification-icon" [ngClass]="notification.type">
              <mat-icon>
                {{ notification.type === 'LOW_STOCK' ? 'warning' :
                notification.type === 'SALE_COMPLETED' ? 'point_of_sale' :
                notification.type === 'SYSTEM_MAINTENANCE' ? 'build' :
                notification.type === 'ERROR' ? 'error' : 'info' }}
              </mat-icon>
            </div>

            <div class="notification-content">
              <div class="notification-title">{{ notification.title }}</div>
              <div class="notification-message">{{ notification.message }}</div>
              <div class="notification-time">{{ getRelativeTime(notification.createdAt) }}</div>
            </div>

            <div class="unread-indicator" *ngIf="!notification.isRead"></div>
          </div>

          <div class="notification-empty" *ngIf="recentNotifications.length === 0">
            <mat-icon>notifications_none</mat-icon>
            <p>Belum ada notifikasi</p>
          </div>
        </div>
      </div>

    </section>

  </div>

  <!-- Router Outlet for Child Routes (ketika bukan /dashboard) -->
  <div class="child-content" *ngIf="!isDashboardHome">
    <router-outlet></router-outlet>
  </div>

</app-base-layout>