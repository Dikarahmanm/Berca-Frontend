<!-- src/app/modules/category-management/category-form-modal/category-form-modal.component.html -->
<!-- âœ… FIXED - Event handlers corrected -->

<div class="modal-overlay" *ngIf="isOpen" (click)="onBackdropClick($event)" (keydown)="onKeydown($event)" tabindex="0">

    <div class="category-modal" (click)="$event.stopPropagation()">

        <!-- Modal Header -->
        <div class="modal-header">
            <div class="header-content">
                <div class="modal-icon" [style.background-color]="currentColorPreview">
                    <svg viewBox="0 0 24 24" fill="currentColor"
                        [style.color]="getContrastTextColor(currentColorPreview)">
                        <path
                            d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z" />
                    </svg>
                </div>

                <div class="header-text">
                    <h2 class="modal-title">{{ modalTitle }}</h2>
                    <p class="modal-subtitle">
                        {{ mode === 'create' ? 'Create a new category for your products' : 'Update category information'
                        }}
                    </p>
                </div>
            </div>

            <button class="close-btn" (click)="closeModal()" [disabled]="isSubmitting">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
            <form [formGroup]="categoryForm" (ngSubmit)="onSubmit()" class="category-form">

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button type="button" class="quick-action-btn suggestions-btn" (click)="toggleSuggestions()"
                        [class.active]="showSuggestions">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z" />
                        </svg>
                        Suggestions
                    </button>

                    <button type="button" class="quick-action-btn random-btn" (click)="getRandomSuggestion()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                        </svg>
                        Random
                    </button>
                </div>

                <!-- Suggestions Panel -->
                <div class="suggestions-panel" [class.show]="showSuggestions">
                    <div class="suggestions-header">
                        <h4>Category Suggestions</h4>
                        <p>Choose from popular category templates</p>
                    </div>

                    <div class="suggestions-grid">
                        <button type="button" class="suggestion-card" *ngFor="let suggestion of suggestions"
                            (click)="applySuggestion(suggestion)">
                            <div class="suggestion-color" [style.background-color]="suggestion.color"></div>
                            <div class="suggestion-info">
                                <span class="suggestion-name">{{ suggestion.name }}</span>
                                <span class="suggestion-description">{{ suggestion.description }}</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Category Name -->
                <div class="form-group">
                    <label for="categoryName" class="form-label required">
                        Category Name
                        <span class="char-counter" [class.warning]="nameCharCount > maxNameLength * 0.8">
                            {{ nameCharCount }}/{{ maxNameLength }}
                        </span>
                    </label>

                    <div class="input-wrapper">
                        <input #nameInput id="categoryName" type="text" formControlName="name" class="form-input"
                            [class.error]="isFieldInvalid('name') || nameExists" [class.checking]="isCheckingName"
                            placeholder="e.g., Electronics, Food & Beverages" maxlength="{{ maxNameLength }}">

                        <!-- Loading indicator for name checking -->
                        <div class="input-icon checking-icon" *ngIf="isCheckingName">
                            <svg class="spinner" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-dasharray="32" stroke-dashoffset="32">
                                    <animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32"
                                        repeatCount="indefinite" />
                                    <animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32"
                                        repeatCount="indefinite" />
                                </circle>
                            </svg>
                        </div>

                        <!-- Success/Error icons -->
                        <div class="input-icon success-icon"
                            *ngIf="categoryForm.get('name')?.valid && !nameExists && !isCheckingName && categoryForm.get('name')?.value">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                            </svg>
                        </div>

                        <div class="input-icon error-icon" *ngIf="isFieldInvalid('name') || nameExists">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg>
                        </div>
                    </div>

                    <div class="field-error" *ngIf="isFieldInvalid('name') || nameExists">
                        {{ nameExists ? validationMessages.name.nameExists : getFieldError('name') }}
                    </div>
                </div>

                <!-- Color Selection -->
                <div class="form-group">
                    <label class="form-label required">
                        Category Color
                        <button type="button" class="color-toggle-btn" (click)="toggleColorPicker()"
                            [class.active]="showColorPicker">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z" />
                            </svg>
                            {{ showColorPicker ? 'Hide' : 'Show' }} Color Picker
                        </button>
                    </label>

                    <!-- Color Preview -->
                    <div class="color-preview-section">
                        <div class="color-preview" [style.background-color]="currentColorPreview">
                            <span class="color-code" [style.color]="getContrastTextColor(currentColorPreview)">
                                {{ currentColorPreview }}
                            </span>
                        </div>

                        <div class="color-input-wrapper">
                            <input #colorInput id="categoryColor" type="text" formControlName="color"
                                class="color-input" [class.error]="isFieldInvalid('color')" placeholder="#FF914D"
                                maxlength="7">

                            <input type="color" [value]="customColor" (input)="onCustomColorInput($event)"
                                (change)="onCustomColorChange($event)" class="native-color-picker">
                        </div>

                        <button type="button" class="random-color-btn" (click)="generateRandomColor()"
                            title="Generate random color">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg>
                        </button>
                    </div>

                    <div class="field-error" *ngIf="isFieldInvalid('color')">
                        {{ getFieldError('color') }}
                    </div>
                </div>

                <!-- Color Picker Panel -->
                <div class="color-picker-panel" [class.show]="showColorPicker">

                    <!-- Color Picker Tabs -->
                    <div class="color-picker-tabs">
                        <button type="button" class="tab-btn" [class.active]="selectedColorTab === 'predefined'"
                            (click)="setColorTab('predefined')">
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                            Predefined
                        </button>

                        <button type="button" class="tab-btn" [class.active]="selectedColorTab === 'custom'"
                            (click)="setColorTab('custom')">
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z" />
                            </svg>
                            Custom
                        </button>

                        <button type="button" class="tab-btn" [class.active]="selectedColorTab === 'suggestions'"
                            (click)="setColorTab('suggestions')" *ngIf="recentColors.length > 0">
                            <svg class="tab-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z" />
                            </svg>
                            Recent
                        </button>
                    </div>

                    <!-- Predefined Colors -->
                    <div class="color-tab-content" *ngIf="selectedColorTab === 'predefined'">
                        <div class="predefined-colors-grid">
                            <button type="button" class="color-option" *ngFor="let color of defaultColors"
                                [style.background-color]="color" [class.active]="currentColorPreview === color"
                                (click)="onColorSelect(color)" [title]="color">
                                <svg *ngIf="currentColorPreview === color" class="check-icon" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Custom Color -->
                    <div class="color-tab-content" *ngIf="selectedColorTab === 'custom'">
                        <div class="custom-color-section">
                            <div class="custom-color-controls">
                                <label class="custom-color-label">
                                    Custom Hex Color:
                                    <input type="text" [value]="customColor" (input)="onCustomColorInput($event)"
                                        (change)="onCustomColorChange($event)" class="custom-color-input"
                                        placeholder="#FF914D" pattern="^#[A-Fa-f0-9]{6}$">
                                </label>

                                <div class="custom-color-picker-wrapper">
                                    <input type="color" [value]="customColor" (input)="onCustomColorInput($event)"
                                        (change)="onCustomColorChange($event)" class="custom-color-picker">
                                </div>
                            </div>

                            <div class="color-variations" *ngIf="isValidHexColor(customColor)">
                                <h5>Color Variations:</h5>
                                <div class="variations-grid">
                                    <button type="button" class="variation-btn"
                                        [style.background-color]="getLighterColor(customColor)"
                                        (click)="onColorSelect(getLighterColor(customColor))" title="Lighter">
                                        Light
                                    </button>

                                    <button type="button" class="variation-btn current"
                                        [style.background-color]="customColor" (click)="onColorSelect(customColor)"
                                        title="Current">
                                        Current
                                    </button>

                                    <button type="button" class="variation-btn"
                                        [style.background-color]="getDarkerColor(customColor)"
                                        (click)="onColorSelect(getDarkerColor(customColor))" title="Darker">
                                        Dark
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Colors -->
                    <div class="color-tab-content"
                        *ngIf="selectedColorTab === 'suggestions' && recentColors.length > 0">
                        <div class="recent-colors-section">
                            <h5>Recently Used Colors:</h5>
                            <div class="recent-colors-grid">
                                <button type="button" class="color-option recent-color"
                                    *ngFor="let color of recentColors" [style.background-color]="color"
                                    [class.active]="currentColorPreview === color" (click)="onColorSelect(color)"
                                    [title]="color">
                                    <svg *ngIf="currentColorPreview === color" class="check-icon" viewBox="0 0 24 24"
                                        fill="currentColor">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="categoryDescription" class="form-label">
                        Description (Optional)
                        <span class="char-counter" [class.warning]="descriptionCharCount > maxDescriptionLength * 0.8">
                            {{ descriptionCharCount }}/{{ maxDescriptionLength }}
                        </span>
                    </label>

                    <textarea id="categoryDescription" formControlName="description" class="form-textarea"
                        [class.error]="isFieldInvalid('description')"
                        placeholder="Brief description of this category..." rows="3"
                        maxlength="{{ maxDescriptionLength }}"></textarea>

                    <div class="field-error" *ngIf="isFieldInvalid('description')">
                        {{ getFieldError('description') }}
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="cancel-btn" (click)="closeModal()" [disabled]="isSubmitting">
                        Cancel
                    </button>

                    <button type="submit" class="submit-btn" [disabled]="!isFormValid || isSubmitting"
                        [class.loading]="isSubmitting">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor" *ngIf="!isSubmitting">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" *ngIf="mode === 'create'" />
                            <path
                                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
                                *ngIf="mode === 'edit'" />
                        </svg>

                        <div class="loading-spinner" *ngIf="isSubmitting">
                            <svg class="spinner" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-dasharray="32" stroke-dashoffset="32">
                                    <animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32"
                                        repeatCount="indefinite" />
                                    <animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32"
                                        repeatCount="indefinite" />
                                </circle>
                            </svg>
                        </div>

                        <span class="btn-text">{{ submitButtonText }}</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>