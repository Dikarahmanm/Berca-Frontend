<!-- ===== FIXED: INVENTORY LIST TEMPLATE WITH RESPONSIVE COLUMNS ===== -->
<!-- src/app/modules/inventory/components/inventory-list/inventory-list.component.html -->

<div class="inventory-container">
  <!-- ===== HEADER SECTION ===== -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon>inventory_2</mat-icon>
          Inventory Management
        </h1>
        <p class="page-subtitle">Manage products, stock levels, and inventory operations</p>
      </div>

      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="addProduct()" class="add-btn">
          <mat-icon>add</mat-icon>
          Add Product
        </button>

        <!-- ‚úÖ NEW: Toggle Batch View Button -->
        <button mat-raised-button 
          [color]="batchViewMode() ? 'accent' : 'basic'" 
          (click)="toggleBatchView()" 
          class="batch-toggle-btn"
          [class.active]="batchViewMode()"
          matTooltip="{{ batchViewMode() ? 'Switch to Product View' : 'Switch to Batch View' }}">
          <mat-icon>{{ batchViewMode() ? 'inventory_2' : 'layers' }}</mat-icon>
          {{ batchViewMode() ? 'Product View' : 'Batch View' }}
          <span class="loading-indicator" *ngIf="loadingBatchDetails()">
            <mat-spinner diameter="16"></mat-spinner>
          </span>
        </button>

        <button mat-icon-button (click)="refreshData()" matTooltip="Refresh Data">
          <mat-icon>refresh</mat-icon>
        </button>

        <button mat-icon-button (click)="exportData()" matTooltip="Export Data">
          <mat-icon>download</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- ===== ENHANCED QUICK STATS CARDS WITH EXPIRY DATA ===== -->
  <div class="stats-cards">
    <mat-card class="stat-card total-products">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>inventory_2</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ formatNumber(comprehensiveStats.totalProducts) }}</div>
          <div class="stat-label">Total Products</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card low-stock" *ngIf="comprehensiveStats.lowStockCount > 0">
      <mat-card-content>
        <div class="stat-icon warning">
          <mat-icon>warning</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ comprehensiveStats.lowStockCount }}</div>
          <div class="stat-label">Low Stock Items</div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ NEW: Expiry Tracking Card -->
    <mat-card class="stat-card expiry-tracked" *ngIf="comprehensiveStats.expiryTrackedProducts > 0">
      <mat-card-content>
        <div class="stat-icon expiry">
          <mat-icon>schedule</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ comprehensiveStats.expiryTrackedProducts }}</div>
          <div class="stat-label">Expiry Tracked</div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ NEW: Expiring Products Card -->
    <mat-card class="stat-card expiring-products" *ngIf="comprehensiveStats.expiringProducts > 0">
      <mat-card-content>
        <div class="stat-icon critical">
          <mat-icon>schedule_alert</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ comprehensiveStats.expiringProducts }}</div>
          <div class="stat-label">Expiring Soon</div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ NEW: FIFO Recommendations Card -->
    <mat-card class="stat-card fifo-recommendations" *ngIf="comprehensiveStats.fifoRecommendations > 0">
      <mat-card-content>
        <div class="stat-icon fifo">
          <mat-icon>trending_down</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ comprehensiveStats.fifoRecommendations }}</div>
          <div class="stat-label">FIFO Actions</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card value-card">
      <mat-card-content>
        <div class="stat-icon">
          <mat-icon>trending_up</mat-icon>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ formatPercentage(comprehensiveStats.averageMargin) }}</div>
          <div class="stat-label">Avg. Margin</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- ‚úÖ NEW: Expiry Analytics Toggle -->
  <div class="expiry-analytics-toggle" *ngIf="expiryAnalytics()">
    <button mat-button (click)="toggleExpiryAnalytics()" class="analytics-toggle-btn">
      <mat-icon>{{ showExpiryAnalytics() ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</mat-icon>
      {{ showExpiryAnalytics() ? 'Hide' : 'Show' }} Expiry Analytics
    </button>
  </div>

  <!-- ‚úÖ NEW: Expiry Analytics Panel -->
  <mat-card class="expiry-analytics-panel" *ngIf="showExpiryAnalytics() && expiryAnalytics()">
    <mat-card-header>
      <mat-card-title>Expiry Analytics Overview</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="analytics-grid">
        <div class="analytics-item">
          <div class="analytics-label">Total Stock Value</div>
          <div class="analytics-value">{{ formatIDRCurrency(expiryAnalytics()!.totalStockValue) }}</div>
        </div>
        <div class="analytics-item">
          <div class="analytics-label">Expiring Stock Value</div>
          <div class="analytics-value warning">{{ formatIDRCurrency(expiryAnalytics()!.expiringStockValue) }}</div>
        </div>
        <div class="analytics-item">
          <div class="analytics-label">Potential Loss</div>
          <div class="analytics-value critical">{{ formatIDRCurrency(expiryAnalytics()!.potentialLossValue) }}</div>
        </div>
        <div class="analytics-item">
          <div class="analytics-label">Waste Percentage</div>
          <div class="analytics-value">{{ formatPercentage(expiryAnalytics()!.wastePercentage) }}</div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- ===== FILTERS SECTION ===== -->
  <mat-card class="filters-card">
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-form">
        <div class="filter-row">
          <!-- Search -->
          <mat-form-field class="search-field" appearance="outline">
            <mat-label>Search products...</mat-label>
            <input matInput formControlName="search" placeholder="Name, barcode, or description"
              (keyup.enter)="loadProducts()">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Category Filter -->
          <mat-form-field class="category-filter" appearance="outline">
            <mat-label>Category</mat-label>
            <mat-select formControlName="categoryId" (click)="$event.stopPropagation()"
              (selectionChange)="onCategoryFilterChange($event)">
              <mat-option value="">All Categories</mat-option>
              <mat-option *ngFor="let category of categories(); trackBy: trackCategoryById" [value]="category.id">
                <span class="category-option">
                  <span class="category-color" [style.background-color]="category.color"></span>
                  {{ category.name }}
                </span>
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- ‚úÖ FIXED: Stock Filter with proper enum values -->
          <mat-form-field class="stock-filter" appearance="outline">
            <mat-label>Stock Status</mat-label>
            <mat-select formControlName="stockFilter">
              <mat-option *ngFor="let option of stockFilterOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- ‚úÖ NEW: Expiry Filter -->
          <mat-form-field class="expiry-filter" appearance="outline">
            <mat-label>Expiry Status</mat-label>
            <mat-select formControlName="expiryFilter">
              <mat-option *ngFor="let option of expiryFilterOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Active Filter -->
          <mat-form-field class="status-filter" appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select formControlName="isActive">
              <mat-option [value]="true">Active Only</mat-option>
              <mat-option [value]="false">Inactive Only</mat-option>
              <mat-option value="">All Products</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Clear Filters -->
          <button mat-icon-button (click)="clearFilters()" matTooltip="Clear Filters" class="clear-filters-btn">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- ===== RESPONSIVE INFO BAR ===== -->
  <div class="responsive-info" *ngIf="!isDesktopView">
    <mat-icon>info</mat-icon>
    <span *ngIf="isMobileView">Mobile view: Essential columns only</span>
    <span *ngIf="isTabletView">Tablet view: Core columns shown</span>
    <small>Switch to desktop for full table view</small>
  </div>

  <!-- ‚úÖ NEW: Expiry Status Filter Buttons -->
  <div class="expiry-filters">
    <div class="filter-header">
      <h3>üïí Expiry Status Filters</h3>
      <span class="filter-info">Filter products by expiry status to manage inventory effectively</span>
    </div>
    <div class="filter-buttons">
      <button 
        *ngFor="let option of expiryFilterOptions"
        class="filter-btn"
        [class.active]="expiryFilter() === option.value"
        [class]="option.value"
        (click)="onExpiryFilterChange(option.value)">
        <span class="icon">{{ option.icon }}</span>
        <span class="label">{{ option.label.split('(')[0].trim() }}</span>
        <span class="count" *ngIf="option.count > 0">({{ option.count }})</span>
      </button>
    </div>
  </div>

  <!-- ‚úÖ NEW: Detailed Batch View Mode -->
  <div class="detailed-batch-view" *ngIf="batchViewMode()">
    
    <!-- Batch View Header -->
    <div class="batch-view-header">
      <mat-card>
        <mat-card-content>
          <div class="header-content">
            <div class="view-info">
              <mat-icon>layers</mat-icon>
              <div class="info-text">
                <h3>Detailed Batch Inventory View</h3>
                <p>Showing individual batches with FIFO ordering, expiry tracking, and detailed batch information.</p>
              </div>
            </div>
            <div class="batch-stats" *ngIf="productsWithDetailedBatches().length > 0">
              <div class="stat-item">
                <span class="stat-value">{{ productsWithDetailedBatches().length }}</span>
                <span class="stat-label">Products</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ getTotalBatchCount() }}</span>
                <span class="stat-label">Batches</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ getCriticalBatchCount() }}</span>
                <span class="stat-label">Critical</span>
              </div>
              <div class="stat-item" *ngIf="getStockDiscrepancyCount() > 0">
                <span class="stat-value warning">{{ getStockDiscrepancyCount() }}</span>
                <span class="stat-label">Discrepancies</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Loading State -->
    <div class="batch-loading" *ngIf="loadingBatchDetails()">
      <mat-card>
        <mat-card-content>
          <div class="loading-content">
            <mat-spinner diameter="40"></mat-spinner>
            <h4>Loading Batch Details...</h4>
            <p>Fetching detailed batch information for all products</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Batch Cards Grid -->
    <div class="batch-cards-container" *ngIf="!loadingBatchDetails() && productsWithDetailedBatches().length > 0">
      
      <!-- ‚úÖ FLEXIBLE: Product Batch Groups with Compact Headers -->
      <div class="product-batch-group" *ngFor="let productGroup of productsWithDetailedBatches(); trackBy: trackByProductGroup">
        
        <!-- ‚úÖ COMPACT: Redesigned Product Header for Space Efficiency -->
        <div class="product-header-compact">
          <div class="product-main-info">
            <h4 class="product-name">{{ productGroup.productName }}</h4>
            <div class="product-meta">
              <span class="product-barcode">{{ productGroup.barcode }}</span>
              <span class="product-category" [style.background-color]="productGroup.categoryColor">
                {{ productGroup.categoryName }}
              </span>
            </div>
          </div>
          
          <div class="product-summary-compact">
            <div class="summary-item">
              <span class="summary-label">Stock</span>
              <span class="summary-value" 
                    [class.stock-discrepancy]="productGroup.hasStockDiscrepancy">
                {{ formatSafeStock(productGroup.totalStock, productGroup.unit) }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Batches</span>
              <span class="summary-value">{{ productGroup.batches.length }}</span>
            </div>
            
            <!-- ‚úÖ Warnings & Alerts in Compact Form -->
            <div class="summary-item" *ngIf="productGroup.isLowStock || productGroup.hasStockDiscrepancy">
              <div class="stock-warning"
                   [matTooltip]="productGroup.hasStockDiscrepancy ? 'Stock discrepancy detected. Database: ' + productGroup.databaseStock + ', Batches: ' + productGroup.totalStock : 'Low stock warning'">
                <mat-icon>{{ productGroup.hasStockDiscrepancy ? 'warning' : 'inventory_2' }}</mat-icon>
              </div>
            </div>
          </div>
        </div>

          <!-- ‚úÖ HORIZONTAL: Batch Cards Layout -->
          <div class="batch-cards-horizontal">
              
              <!-- Batch Card -->
              <div class="batch-card" 
                   *ngFor="let batch of productGroup.batches; trackBy: trackByBatch"
                   [ngClass]="getBatchCardClasses(batch)">
                
                <!-- Batch Header -->
                <div class="batch-header">
                  <div class="batch-identity">
                    <h5 class="batch-number">{{ batch.batchNumber }}</h5>
                    <span class="batch-id">#{{ batch.id }}</span>
                  </div>
                  <div class="batch-priority">
                    <span class="fifo-order" [ngClass]="getFifoOrderClass(batch)">
                      {{ getFifoOrderText(batch) }}
                    </span>
                  </div>
                </div>

                <!-- Batch Stock Info -->
                <div class="batch-stock-grid">
                  <div class="stock-item">
                    <span class="stock-label">Current</span>
                    <span class="stock-value current">{{ formatSafeStock(batch.currentStock, productGroup.unit) }}</span>
                  </div>
                  <div class="stock-item">
                    <span class="stock-label">Initial</span>
                    <span class="stock-value initial">{{ formatSafeStock(batch.initialStock, productGroup.unit) }}</span>
                  </div>
                  <div class="stock-item">
                    <span class="stock-label">Cost/Unit</span>
                    <span class="stock-value cost">{{ formatSafeCurrency(batch.costPerUnit) }}</span>
                  </div>
                  <div class="stock-item">
                    <span class="stock-label">Total Value</span>
                    <span class="stock-value total">{{ formatSafeCurrency(batch.currentStock * batch.costPerUnit) }}</span>
                  </div>
                </div>

                <!-- Batch Dates -->
                <div class="batch-dates-section">
                  <div class="date-item" *ngIf="batch.productionDate">
                    <mat-icon class="date-icon">calendar_today</mat-icon>
                    <div class="date-content">
                      <span class="date-label">Production</span>
                      <span class="date-value">{{ formatSafeDate(batch.productionDate) }}</span>
                    </div>
                  </div>
                  
                  <div class="date-item expiry-item" *ngIf="batch.expiryDate">
                    <mat-icon [ngClass]="getExpiryIconClass(batch)">{{ getExpiryIcon(batch) }}</mat-icon>
                    <div class="date-content">
                      <span class="date-label">Expiry</span>
                      <span class="date-value" [ngClass]="getExpiryDateClass(batch)">
                        {{ formatSafeDate(batch.expiryDate) }}
                      </span>
                      <span class="days-left" [ngClass]="getDaysLeftClass(batch)">
                        {{ getDaysLeftText(batch) }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Batch Details -->
                <div class="batch-details-section" *ngIf="batch.supplierName || batch.purchaseOrderNumber">
                  <div class="detail-item" *ngIf="batch.supplierName">
                    <mat-icon>business</mat-icon>
                    <span>{{ batch.supplierName }}</span>
                  </div>
                  <div class="detail-item" *ngIf="batch.purchaseOrderNumber">
                    <mat-icon>receipt</mat-icon>
                    <span>PO: {{ batch.purchaseOrderNumber }}</span>
                  </div>
                </div>

                <!-- Batch Status -->
                <div class="batch-status-section">
                  <div class="status-indicator">
                    <mat-icon>{{ getBatchStatusIcon(batch) }}</mat-icon>
                    <span>{{ getBatchStatusText(batch) }}</span>
                  </div>
                </div>

                <!-- Batch Actions -->
                <div class="batch-actions">
                  <button mat-stroked-button size="small" 
                          (click)="editBatch(batch)" 
                          class="action-btn edit-batch-btn">
                    <mat-icon>edit</mat-icon>
                    Edit
                  </button>
                  <button mat-stroked-button size="small" 
                          (click)="addStockToBatch(batch)" 
                          [disabled]="batch.isExpired || batch.isDisposed"
                          class="action-btn add-stock-btn">
                    <mat-icon>add</mat-icon>
                    Add Stock
                  </button>
                  <button mat-icon-button [matMenuTriggerFor]="batchMenu" class="action-menu batch-menu-btn">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  
                  <mat-menu #batchMenu="matMenu">
                    <button mat-menu-item (click)="viewBatchHistory(batch)">
                      <mat-icon>history</mat-icon>
                      View History
                    </button>
                    <button mat-menu-item (click)="transferBatch(batch)" 
                            [disabled]="batch.currentStock === 0">
                      <mat-icon>swap_horiz</mat-icon>
                      Transfer Stock
                    </button>
                    <button mat-menu-item (click)="disposeBatch(batch)" 
                            *ngIf="batch.isExpired && !batch.isDisposed">
                      <mat-icon>delete_sweep</mat-icon>
                      Dispose Expired
                    </button>
                  </mat-menu>
                </div>
              </div>

              <!-- No Batches State for Product -->
              <div class="no-batches-card" *ngIf="productGroup.batches.length === 0">
                <mat-icon>info</mat-icon>
                <h5>No Batches Found</h5>
                <p>This product doesn't have any batch tracking enabled yet.</p>
                <button mat-stroked-button (click)="createFirstBatch(productGroup)">
                  <mat-icon>add</mat-icon>
                  Create First Batch
                </button>
              </div>
          </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="batch-view-empty" *ngIf="!loadingBatchDetails() && productsWithDetailedBatches().length === 0">
      <mat-card>
        <mat-card-content>
          <div class="empty-content">
            <mat-icon class="empty-icon">layers_clear</mat-icon>
            <h3>No Batch Data Available</h3>
            <p>No products with batch tracking found. Create products with expiry date tracking to see detailed batch information here.</p>
            <button mat-raised-button color="primary" (click)="addProduct()">
              <mat-icon>add</mat-icon>
              Add Product with Batch Tracking
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- ===== PRODUCTS TABLE (Hidden in Batch View Mode) ===== -->
  <mat-card class="table-card" *ngIf="!batchViewMode()">
    <mat-card-content>
      <div class="table-container">
        <!-- ‚úÖ FIXED: Dynamic columns based on screen size -->
        <table mat-table [dataSource]="products" matSort (matSortChange)="onSortChange($event)" class="products-table">

          <!-- Image Column - Desktop Only -->
          <ng-container matColumnDef="image">
            <th mat-header-cell *matHeaderCellDef class="image-col">Image</th>
            <td mat-cell *matCellDef="let product" class="image-col">
              <div class="product-image">
                <img [src]="product.imageUrl || '/assets/images/placeholder-product.png'" [alt]="product.name"
                  onerror="this.src='/assets/images/placeholder-product.png'">
              </div>
            </td>
          </ng-container>

          <!-- Product Info Column - Always Visible -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Product</th>
            <td mat-cell *matCellDef="let product" class="product-info">
              <div class="product-details">
                <div class="product-name">{{ product.name }}</div>
                <div class="product-meta">
                  <span class="barcode">{{ product.barcode }}</span>
                  <span class="unit">{{ product.unit }}</span>
                </div>
                <div class="product-description" *ngIf="product.description">
                  {{ product.description }}
                </div>

                <!-- ‚úÖ ENHANCED: Mobile additional info with expiry data -->
                <div class="mobile-additional-info" *ngIf="isMobileView">
                  <div class="mobile-info-row">
                    <span class="mobile-label">Category:</span>
                    <mat-chip class="mobile-category-chip"
                      [style.background-color]="getCategoryColor(product.categoryId)">
                      {{ getCategoryName(product.categoryId) }}
                    </mat-chip>
                  </div>
                  <div class="mobile-info-row" *ngIf="isColumnVisible('buyPrice')">
                    <span class="mobile-label">Buy:</span>
                    <span class="mobile-value">{{ formatCurrency(product.buyPrice) }}</span>
                  </div>
                  <div class="mobile-info-row" *ngIf="isColumnVisible('sellPrice')">
                    <span class="mobile-label">Sell:</span>
                    <span class="mobile-value">{{ formatCurrency(product.sellPrice) }}</span>
                  </div>
                  <!-- ‚úÖ NEW: Mobile expiry info -->
                  <div class="mobile-info-row" *ngIf="hasExpiryDate(product)">
                    <span class="mobile-label">Expiry:</span>
                    <div class="mobile-expiry-info">
                      <span class="mobile-expiry-status" [style.color]="getExpiryStatusColor(product)">
                        {{ getExpiryStatusIcon(product) }} {{ getExpiryStatusText(product) }}
                      </span>
                    </div>
                  </div>
                  <!-- ‚úÖ NEW: Mobile FIFO recommendation -->
                  <div class="mobile-info-row" *ngIf="getFifoRecommendation(product) as recommendation">
                    <span class="mobile-label">FIFO:</span>
                    <mat-chip class="mobile-fifo-chip"
                      [style.background-color]="getFifoRecommendationColor(recommendation)"
                      [style.color]="'white'"
                      (click)="applyFifoRecommendation(recommendation)">
                      {{ getFifoActionText(recommendation) }}
                    </mat-chip>
                  </div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Barcode Column - Tablet+ -->
          <ng-container matColumnDef="barcode">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Barcode</th>
            <td mat-cell *matCellDef="let product">
              <span class="barcode-value">{{ product.barcode }}</span>
            </td>
          </ng-container>

          <!-- ‚úÖ FIXED: Category Column - Add mat-sort-header -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="categoryName">Category</th>
            <td mat-cell *matCellDef="let product" class="category-info">
              <mat-chip class="category-chip" [style.background-color]="getCategoryColor(product.categoryId)"
                [style.color]="'white'">
                {{ getCategoryName(product.categoryId) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Stock Column - Always Visible -->
          <ng-container matColumnDef="stock">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Stock</th>
            <td mat-cell *matCellDef="let product" class="stock-info">
              <div class="stock-main">
                <span class="stock-value" [style.color]="getStockStatusColor(product)">
                  {{ formatNumber(product.stock) }}
                </span>
                <span class="stock-unit">{{ product.unit }}</span>
              </div>
              <div class="stock-status">
                <mat-chip class="status-chip" [style.background-color]="getStockStatusColor(product)"
                  [style.color]="'white'">
                  {{ getStockStatusLabel(product) }}
                </mat-chip>
              </div>

              <!-- ‚úÖ ENHANCED: Mobile minimum stock and expiry info -->
              <div class="mobile-minimum-info" *ngIf="isMobileView && product.stock <= product.minimumStock">
                <mat-icon class="warning-icon" color="warn">warning</mat-icon>
                <span class="warning-text">Min: {{ formatNumber(product.minimumStock) }}</span>
              </div>
              
              <!-- ‚úÖ NEW: Mobile expiry alert -->
              <div class="mobile-expiry-alert" *ngIf="isMobileView && hasExpiryDate(product) && getDaysUntilExpiry(product) !== null && getDaysUntilExpiry(product)! <= 7">
                <mat-icon class="alert-icon" [color]="getDaysUntilExpiry(product)! < 0 ? 'warn' : 'accent'">schedule</mat-icon>
                <span class="alert-text" [style.color]="getExpiryStatusColor(product)">{{ getExpiryStatusText(product) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Minimum Stock Column - Desktop Only -->
          <ng-container matColumnDef="minimumStock">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Min. Stock</th>
            <td mat-cell *matCellDef="let product" class="minimum-stock-info">
              <div class="minimum-stock-main">
                <span class="minimum-value">{{ formatNumber(product.minimumStock || 0) }}</span>
                <span class="minimum-unit">{{ product.unit }}</span>
              </div>
              <div class="minimum-status" *ngIf="product.stock <= product.minimumStock">
                <mat-icon class="warning-icon" color="warn">warning</mat-icon>
                <span class="warning-text">Below minimum</span>
              </div>
            </td>
          </ng-container>

          <!-- Buy Price Column - Desktop Only -->
          <ng-container matColumnDef="buyPrice">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Buy Price</th>
            <td mat-cell *matCellDef="let product" class="price-info">
              <span class="price-value">{{ formatCurrency(product.buyPrice) }}</span>
            </td>
          </ng-container>

          <!-- Sell Price Column - Tablet+ -->
          <ng-container matColumnDef="sellPrice">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Sell Price</th>
            <td mat-cell *matCellDef="let product" class="price-info">
              <span class="price-value">{{ formatCurrency(product.sellPrice) }}</span>
            </td>
          </ng-container>

          <!-- Margin Column - Desktop Only -->
          <ng-container matColumnDef="margin">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="profitMargin">Margin</th>
            <td mat-cell *matCellDef="let product" class="margin-info">
              <div class="margin-details">
                <div class="margin-percentage" [class.positive]="getMarginPercentage(product) > 0"
                  [class.negative]="getMarginPercentage(product) < 0">
                  {{ formatPercentage(getMarginPercentage(product)) }}
                </div>
                <div class="margin-amount">
                  {{ formatCurrency(getMarginAmount(product)) }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- ‚úÖ ENHANCED: Expiry Date Column - Always Visible -->
          <ng-container matColumnDef="expiry">
            <th mat-header-cell *matHeaderCellDef class="expiry-col">üìÖ Expiry Date</th>
            <td mat-cell *matCellDef="let product" class="expiry-date-cell">
              <div class="expiry-date" [class]="product.expiryStatus">
                {{ formatExpiryDisplay(product) }}
              </div>
              <div *ngIf="product.needsExpiryData" class="add-expiry-action">
                <button class="add-expiry-btn" (click)="addExpiryDate(product)">
                  üìù Add Expiry
                </button>
              </div>
            </td>
          </ng-container>

          <!-- ‚úÖ ENHANCED: Expiry Status Column - Tablet+ -->
          <ng-container matColumnDef="expiryStatus">
            <th mat-header-cell *matHeaderCellDef class="expiry-status-col">üö¶ Status</th>
            <td mat-cell *matCellDef="let product" class="status-cell">
              <span 
                class="status-badge" 
                [class]="product.expiryStatus"
                [style.background-color]="getExpiryStatusColor(product.expiryStatus)">
                {{ getExpiryStatusIcon(product.expiryStatus) }} 
                {{ product.expiryStatus | titlecase }}
              </span>
            </td>
          </ng-container>

          <!-- ‚úÖ NEW: Days Until Expiry Column - Desktop Only -->
          <ng-container matColumnDef="daysLeft">
            <th mat-header-cell *matHeaderCellDef class="days-left-col">‚è∞ Days Left</th>
            <td mat-cell *matCellDef="let product" class="days-left-cell">
              <div class="days-left" [style.color]="getExpiryStatusColor(product.expiryStatus)">
                {{ formatDaysUntilExpiry(product) }}
              </div>
            </td>
          </ng-container>

          <!-- ‚úÖ NEW: Batches Column - Desktop Only -->
          <ng-container matColumnDef="batches">
            <th mat-header-cell *matHeaderCellDef class="batches-col">Batches</th>
            <td mat-cell *matCellDef="let product" class="batches-column">
              <div *ngIf="supportsBatchManagement(product)" class="batch-info">
                <button mat-button class="batch-btn" (click)="loadProductBatches(product)">
                  <mat-icon>layers</mat-icon>
                  <span>{{ getProductBatchCount(product) || 'View' }}</span>
                </button>
              </div>
              <div *ngIf="!supportsBatchManagement(product)" class="no-batches">
                <span class="no-batches-text">N/A</span>
              </div>
            </td>
          </ng-container>

          <!-- ‚úÖ NEW: Batch Summary Column - Enhanced batch information display -->
          <ng-container matColumnDef="batchSummary">
            <th mat-header-cell *matHeaderCellDef class="batch-summary-col">Batch Summary</th>
            <td mat-cell *matCellDef="let product" class="batch-summary-column">
              <div *ngIf="product.totalBatches > 0" class="batch-summary-info">
                <div class="batch-counts">
                  <span class="total-batches">{{ product.totalBatches }} batch{{ product.totalBatches > 1 ? 'es' : '' }}</span>
                </div>
                
                <div class="batch-status-breakdown">
                  <span *ngIf="product.batchesGood > 0" class="status-count good" 
                    matTooltip="{{ product.batchesGood }} good batches">
                    ‚úÖ {{ product.batchesGood }}
                  </span>
                  <span *ngIf="product.batchesWarning > 0" class="status-count warning"
                    matTooltip="{{ product.batchesWarning }} batches expiring soon">
                    ‚ö†Ô∏è {{ product.batchesWarning }}
                  </span>
                  <span *ngIf="product.batchesCritical > 0" class="status-count critical"
                    matTooltip="{{ product.batchesCritical }} batches expiring very soon">
                    üö® {{ product.batchesCritical }}
                  </span>
                  <span *ngIf="product.batchesExpired > 0" class="status-count expired"
                    matTooltip="{{ product.batchesExpired }} expired batches">
                    ‚ùå {{ product.batchesExpired }}
                  </span>
                </div>

                <div *ngIf="product.nearestExpiryDate" class="nearest-expiry">
                  <span class="expiry-info" [class]="'expiry-' + product.expiryStatus">
                    Next: {{ formatDate(product.nearestExpiryDate) }}
                    <span class="days-left">({{ formatDaysToExpiry(product.daysToNearestExpiry) }})</span>
                  </span>
                </div>

                <div *ngIf="product.latestBatch" class="latest-batch">
                  <span class="batch-code">Latest: {{ product.latestBatch.batchNumber }}</span>
                  <span class="batch-qty">({{ product.latestBatch.quantity }})</span>
                </div>
              </div>
              
              <div *ngIf="!product.totalBatches || product.totalBatches === 0" class="no-batch-summary">
                <span class="no-batches-text">No batches</span>
                <button mat-button size="small" class="add-batch-btn" 
                  (click)="addNewBatch(product)"
                  matTooltip="Add first batch">
                  <mat-icon>add</mat-icon>
                  Add Batch
                </button>
              </div>
            </td>
          </ng-container>

          <!-- ‚úÖ NEW: FIFO Recommendation Column - Desktop Only -->
          <ng-container matColumnDef="fifoRecommendation">
            <th mat-header-cell *matHeaderCellDef class="fifo-col">FIFO</th>
            <td mat-cell *matCellDef="let product" class="fifo-column">
              <div *ngIf="getFifoRecommendation(product) as recommendation" class="fifo-recommendation">
                <mat-chip class="fifo-chip"
                  [style.background-color]="getFifoRecommendationColor(recommendation)"
                  [style.color]="'white'"
                  (click)="applyFifoRecommendation(recommendation)">
                  {{ getFifoActionText(recommendation) }}
                </mat-chip>
              </div>
              <div *ngIf="!getFifoRecommendation(product)" class="no-fifo">
                <span class="no-fifo-text">OK</span>
              </div>
            </td>
          </ng-container>

          <!-- Status Column - Tablet+ -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="isActive">Status</th>
            <td mat-cell *matCellDef="let product" class="status-info">
              <mat-slide-toggle [checked]="product.isActive" (change)="toggleProductStatus(product)" [color]="'primary'">
                {{ product.isActive ? 'Active' : 'Inactive' }}
              </mat-slide-toggle>
            </td>
          </ng-container>

          <!-- Actions Column - Always Visible -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let product" class="actions-info">
              <div class="action-buttons">
                <!-- ‚úÖ Mobile: Show essential actions only -->
                <div class="mobile-actions" *ngIf="isMobileView">
                  <button mat-icon-button (click)="editProduct(product)" matTooltip="Edit" color="primary">
                    <mat-icon>edit</mat-icon>
                  </button>

                  <button mat-icon-button [matMenuTriggerFor]="mobileActionsMenu" matTooltip="More">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #mobileActionsMenu="matMenu">
                    <button mat-menu-item (click)="manageStock(product)">
                      <mat-icon>inventory</mat-icon>
                      <span>Manage Stock</span>
                    </button>

                    <!-- ‚úÖ NEW: Expiry Management -->
                    <button mat-menu-item (click)="manageProductExpiry(product)" *ngIf="hasExpiryDate(product)">
                      <mat-icon>schedule</mat-icon>
                      <span>Manage Expiry</span>
                    </button>

                    <!-- ‚úÖ NEW: Batch Management -->
                    <button mat-menu-item (click)="manageBatches(product)" *ngIf="supportsBatchManagement(product)">
                      <mat-icon>layers</mat-icon>
                      <span>Manage Batches</span>
                    </button>

                    <mat-divider *ngIf="hasExpiryDate(product) || supportsBatchManagement(product)"></mat-divider>

                    <button mat-menu-item (click)="toggleProductStatus(product)" [class.activate]="!product.isActive"
                      [class.deactivate]="product.isActive">
                      <mat-icon>{{ product.isActive ? 'visibility_off' : 'visibility' }}</mat-icon>
                      <span>{{ product.isActive ? 'Deactivate' : 'Activate' }}</span>
                    </button>

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="deleteProduct(product)" class="delete-action">
                      <mat-icon color="warn">delete</mat-icon>
                      <span>Delete Product</span>
                    </button>
                  </mat-menu>
                </div>

                <!-- ‚úÖ Tablet/Desktop: Show all actions -->
                <div class="desktop-actions" *ngIf="!isMobileView">
                  <!-- Quick Stock Management -->
                  <button mat-icon-button (click)="manageStock(product)" matTooltip="Manage Stock" color="primary">
                    <mat-icon>inventory</mat-icon>
                  </button>

                  <!-- Edit Product -->
                  <button mat-icon-button (click)="editProduct(product)" matTooltip="Edit Product" color="accent">
                    <mat-icon>edit</mat-icon>
                  </button>

                  <!-- More Actions Menu -->
                  <button mat-icon-button [matMenuTriggerFor]="desktopActionsMenu" matTooltip="More Actions">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #desktopActionsMenu="matMenu">
                    <button mat-menu-item (click)="editProduct(product)">
                      <mat-icon>edit</mat-icon>
                      <span>Edit Product</span>
                    </button>

                    <button mat-menu-item (click)="manageStock(product)">
                      <mat-icon>inventory</mat-icon>
                      <span>Manage Stock</span>
                    </button>

                    <!-- ‚úÖ NEW: Expiry & Batch Management Section -->
                    <mat-divider *ngIf="hasExpiryDate(product) || supportsBatchManagement(product)"></mat-divider>
                    
                    <button mat-menu-item (click)="manageProductExpiry(product)" *ngIf="hasExpiryDate(product)">
                      <mat-icon>schedule</mat-icon>
                      <span>Manage Expiry</span>
                    </button>

                    <button mat-menu-item (click)="manageBatches(product)" *ngIf="supportsBatchManagement(product)">
                      <mat-icon>layers</mat-icon>
                      <span>Manage Batches</span>
                    </button>

                    <!-- ‚úÖ NEW: FIFO Actions -->
                    <button mat-menu-item (click)="applyFifoRecommendation(recommendation!)" 
                      *ngIf="getFifoRecommendation(product) as recommendation"
                      [style.color]="getFifoRecommendationColor(recommendation)">
                      <mat-icon>trending_down</mat-icon>
                      <span>{{ getFifoActionText(recommendation) }}</span>
                    </button>

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="toggleProductStatus(product)" [class.activate]="!product.isActive"
                      [class.deactivate]="product.isActive">
                      <mat-icon>{{ product.isActive ? 'visibility_off' : 'visibility' }}</mat-icon>
                      <span>{{ product.isActive ? 'Deactivate' : 'Activate' }}</span>
                    </button>

                    <button mat-menu-item (click)="deleteProduct(product)" class="delete-action">
                      <mat-icon color="warn">delete</mat-icon>
                      <span>Delete Product</span>
                    </button>
                  </mat-menu>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- ‚úÖ FIXED: Dynamic table header and rows based on responsive columns -->
          <tr mat-header-row *matHeaderRowDef="currentDisplayedColumns(); sticky: true"></tr>
          <tr mat-row *matRowDef="let product; columns: currentDisplayedColumns();"
            [class.low-stock-row]="product.isLowStock" [class.out-of-stock-row]="product.isOutOfStock"
            [class.inactive-row]="!product.isActive">
          </tr>
        </table>

        <!-- ===== LOADING STATE ===== -->
        <div class="loading-container" *ngIf="loading()">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading products...</p>
        </div>

        <!-- ===== EMPTY STATE ===== -->
        <div class="empty-state" *ngIf="!loading() && products.data.length === 0">
          <mat-icon class="empty-icon">inventory_2</mat-icon>
          <h3>No products found</h3>
          <p>Try adjusting your search criteria or add a new product.</p>
          <button mat-raised-button color="primary" (click)="addProduct()">
            <mat-icon>add</mat-icon>
            Add First Product
          </button>
        </div>
      </div>

      <!-- ===== PAGINATION ===== -->
      <mat-paginator [length]="totalItems()" [pageSize]="pageSize()" [pageSizeOptions]="[10, 25, 50, 100]"
        (page)="onPageChange($event)" showFirstLastButtons>
      </mat-paginator>
    </mat-card-content>
  </mat-card>

  <!-- ===== DEBUG INFO (Development Only) ===== -->
  <div class="debug-info" *ngIf="false">
    <mat-card>
      <mat-card-content>
        <h4>Debug Info</h4>
        <p><strong>Screen Width:</strong> {{ screenWidth() }}px</p>
        <p><strong>View Type:</strong>
          <span *ngIf="isMobileView">Mobile</span>
          <span *ngIf="isTabletView">Tablet</span>
          <span *ngIf="isDesktopView">Desktop</span>
        </p>
        <p><strong>Displayed Columns:</strong> {{ currentDisplayedColumns().join(', ') }}</p>
        <p><strong>Total Products:</strong> {{ totalItems() }}</p>
        <p><strong>Low Stock Count:</strong> {{ statsData.lowStockCount }}</p>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- ===== BATCH MANAGEMENT MODAL ===== -->
  <div class="batch-management-modal" *ngIf="selectedProductForBatches">
    <mat-card class="batch-modal-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>layers</mat-icon>
          Batch Management: {{ selectedProductForBatches.name }}
        </mat-card-title>
        <button mat-icon-button (click)="selectedProductForBatches = null" class="close-modal-btn">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>
      
      <mat-card-content>
        <div class="batch-list" *ngIf="productBatches().length > 0; else noBatches">
          <div class="batch-item" *ngFor="let batch of productBatches()" 
               [class.batch-expired]="batch.status === 'EXPIRED'"
               [class.batch-blocked]="batch.isBlocked"
               [class.batch-active]="batch.status === 'ACTIVE'">
            <div class="batch-header">
              <div class="batch-info">
                <h4 class="batch-number">{{ batch.batchNumber }}</h4>
                <div class="batch-meta">
                  <span class="batch-stock">Stock: {{ batch.currentStock }}</span>
                  <span class="batch-status" [style.color]="getBatchStatusColorByStatus(batch.status)">
                    {{ batch.status }}
                  </span>
                </div>
              </div>
              <div class="batch-actions">
                <button mat-button color="primary" size="small">
                  <mat-icon>edit</mat-icon>
                  Edit
                </button>
              </div>
            </div>
            
            <div class="batch-details">
              <div class="batch-detail-row" *ngIf="batch.expiryDate">
                <span class="detail-label">Expiry:</span>
                <span class="detail-value" [style.color]="getExpiryStatusColor(batch)">
                  {{ formatExpiryDate(batch) }}
                  ({{ getDaysUntilExpiry(batch) }} days)
                </span>
              </div>
              
              <div class="batch-detail-row" *ngIf="batch.productionDate">
                <span class="detail-label">Production:</span>
                <span class="detail-value">{{ batch.productionDate | date:'mediumDate' }}</span>
              </div>
              
              <div class="batch-detail-row">
                <span class="detail-label">Cost/Unit:</span>
                <span class="detail-value">{{ formatIDRCurrency(batch.costPerUnit) }}</span>
              </div>
              
              <div class="batch-detail-row" *ngIf="batch.supplierName">
                <span class="detail-label">Supplier:</span>
                <span class="detail-value">{{ batch.supplierName }}</span>
              </div>
              
              <div class="batch-detail-row" *ngIf="batch.notes">
                <span class="detail-label">Notes:</span>
                <span class="detail-value">{{ batch.notes }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <ng-template #noBatches>
          <div class="no-batches-state">
            <mat-icon class="no-batches-icon">layers</mat-icon>
            <h3>No batches found</h3>
            <p>This product doesn't have any batch records yet.</p>
            <button mat-raised-button color="primary" (click)="manageBatches(selectedProductForBatches!)">
              <mat-icon>add</mat-icon>
              Create First Batch
            </button>
          </div>
        </ng-template>
      </mat-card-content>
      
      <mat-card-actions>
        <button mat-button (click)="manageBatches(selectedProductForBatches!)">
          <mat-icon>settings</mat-icon>
          Manage Batches
        </button>
        <button mat-button (click)="selectedProductForBatches = null">
          Close
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop" *ngIf="selectedProductForBatches" (click)="selectedProductForBatches = null"></div>
</div>