<!-- ‚úÖ REDESIGNED: Progressive Disclosure Product Form -->
<!-- Multi-step workflow with context-aware fields and mobile-first design -->

<div class="product-form-container">

    <!-- ‚úÖ STEP PROGRESS INDICATOR -->
    <div class="step-progress">
        <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="stepProgress()"></div>
        </div>
        <div class="step-info">
            <span class="step-title">{{ currentStepTitle() }}</span>
            <span class="step-description">{{ currentStepDescription() }}</span>
        </div>
    </div>

    <!-- ‚úÖ STEP-BASED FORM CONTENT -->
    <div class="form-content" *ngIf="!loading()">
        
        <!-- ===== STEP 1: BASIC PRODUCT INFO (ALWAYS SHOWN) ===== -->
        <div class="form-step" *ngIf="currentStep() === 'basic'" [@slideIn]>
            <div class="step-header">
                <div class="step-icon">üìù</div>
                <div class="step-content">
                    <h2>Basic Product Information</h2>
                    <p>Enter essential product details to get started</p>
                </div>
            </div>

            <form [formGroup]="productForm" class="step-form">
                <!-- Product Name -->
                <div class="form-field">
                    <label for="name" class="field-label">
                        Product Name <span class="required">*</span>
                    </label>
                    <input 
                        id="name" 
                        type="text" 
                        formControlName="name"
                        class="form-input"
                        [class.error]="isFieldInvalid('name')"
                        placeholder="Enter product name"
                        maxlength="100">
                    <div class="field-footer">
                        <span class="char-count">{{productForm.get('name')?.value?.length || 0}}/100</span>
                    </div>
                    <div *ngIf="isFieldInvalid('name')" class="error-message">
                        {{ getFieldError('name') }}
                    </div>
                </div>

                <!-- Barcode with Scanner -->
                <div class="form-field">
                    <label for="barcode" class="field-label">
                        Barcode <span class="required">*</span>
                    </label>
                    <div class="input-group">
                        <input 
                            id="barcode" 
                            type="text" 
                            formControlName="barcode"
                            class="form-input"
                            [class.error]="isFieldInvalid('barcode')"
                            placeholder="Scan or enter barcode">
                        <button type="button" class="input-addon-btn" (click)="startBarcodeScanner()" [disabled]="scannerActive()">
                            üì∑ {{ scannerActive() ? 'Scanning...' : 'Scan' }}
                        </button>
                        <button type="button" class="input-addon-btn secondary" (click)="generateBarcode()">
                            üé≤ Generate
                        </button>
                    </div>
                    <div *ngIf="isFieldInvalid('barcode')" class="error-message">
                        {{ getFieldError('barcode') }}
                    </div>
                </div>

                <!-- Scanner Video Container -->
                <div id="barcode-scanner" *ngIf="scannerActive()" class="scanner-container">
                    <video autoplay playsinline></video>
                    <div class="scanner-overlay">
                        <div class="scan-line"></div>
                        <p>Position barcode within the frame</p>
                        <button type="button" class="btn btn-secondary" (click)="stopBarcodeScanner()">Cancel Scan</button>
                    </div>
                </div>

                <!-- Category Selection -->
                <div class="form-field">
                    <label for="category" class="field-label">
                        Category <span class="required">*</span>
                    </label>
                    <select 
                        id="category" 
                        formControlName="categoryId"
                        class="form-select"
                        [class.error]="isFieldInvalid('categoryId')">
                        <option value="" disabled>Choose product category</option>
                        <option *ngFor="let category of categories()" [value]="category.id">
                            {{ category.name }}
                        </option>
                    </select>
                    <div *ngIf="isFieldInvalid('categoryId')" class="error-message">
                        {{ getFieldError('categoryId') }}
                    </div>
                    <div *ngIf="expiryValidating()" class="field-info">
                        <span class="spinner small"></span>
                        Checking category requirements...
                    </div>
                </div>

                <!-- Pricing Grid -->
                <div class="form-grid two-columns">
                    <div class="form-field">
                        <label for="buyPrice" class="field-label">
                            Buy Price <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-addon">Rp</span>
                            <input 
                                id="buyPrice" 
                                type="number" 
                                formControlName="buyPrice"
                                class="form-input"
                                [class.error]="isFieldInvalid('buyPrice')"
                                placeholder="0"
                                min="0"
                                step="100">
                        </div>
                        <div *ngIf="isFieldInvalid('buyPrice')" class="error-message">
                            {{ getFieldError('buyPrice') }}
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="sellPrice" class="field-label">
                            Sell Price <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-addon">Rp</span>
                            <input 
                                id="sellPrice" 
                                type="number" 
                                formControlName="sellPrice"
                                class="form-input"
                                [class.error]="isFieldInvalid('sellPrice')"
                                placeholder="0"
                                min="0"
                                step="100">
                        </div>
                        <div *ngIf="isFieldInvalid('sellPrice')" class="error-message">
                            {{ getFieldError('sellPrice') }}
                        </div>
                    </div>
                </div>

                <!-- Margin Display -->
                <div class="margin-display" *ngIf="productForm.get('buyPrice')?.value > 0 && productForm.get('sellPrice')?.value > 0">
                    <div class="margin-info">
                        <span class="margin-label">Margin:</span>
                        <span class="margin-value" [class.negative]="getMarginAmount() < 0">
                            {{ formatCurrency(getMarginAmount()) }} ({{ getMarginPercentage().toFixed(1) }}%)
                        </span>
                    </div>
                </div>

                <!-- ‚úÖ NEW: Branch-Specific Inventory Toggle -->
                <div class="branch-inventory-toggle">
                    <div class="toggle-section">
                        <div class="toggle-header">
                            <div class="toggle-info">
                                <h3 class="toggle-title">üìç Inventory Management Mode</h3>
                                <p class="toggle-description">
                                    Choose how to manage stock for this product across branches
                                </p>
                            </div>
                            <label class="toggle-switch">
                                <input
                                    type="checkbox"
                                    [checked]="enableBranchSpecificInventory()"
                                    (change)="toggleBranchSpecificInventory()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="mode-indicator">
                            <div class="mode-badge" [class.active]="!enableBranchSpecificInventory()">
                                üåê Global Mode
                                <span class="mode-desc">Same stock across all branches</span>
                            </div>
                            <div class="mode-badge" [class.active]="enableBranchSpecificInventory()">
                                üè¢ Branch-Specific Mode
                                <span class="mode-desc">Independent stock per branch</span>
                            </div>
                        </div>

                        <div class="branch-loading" *ngIf="branchesLoading()">
                            <div class="loading-spinner"></div>
                            <span>Loading branches...</span>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ CONDITIONAL: Global Stock (when branch-specific is disabled) -->
                <div *ngIf="!enableBranchSpecificInventory()" class="stock-section global-stock">
                    <h4 class="section-title">üì¶ Global Stock Settings</h4>

                    <!-- Stock and Unit -->
                    <div class="form-grid two-columns">
                    <div class="form-field">
                        <label for="stock" class="field-label">
                            Initial Stock <span class="required">*</span>
                        </label>
                        <input 
                            id="stock" 
                            type="number" 
                            formControlName="stock"
                            class="form-input"
                            [class.error]="isFieldInvalid('stock')"
                            placeholder="0"
                            min="0"
                            step="1">
                        <div *ngIf="isFieldInvalid('stock')" class="error-message">
                            {{ getFieldError('stock') }}
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="unit" class="field-label">
                            Unit <span class="required">*</span>
                        </label>
                        <select 
                            id="unit" 
                            formControlName="unit"
                            class="form-select"
                            [class.error]="isFieldInvalid('unit')">
                            <option value="pcs">Pieces (pcs)</option>
                            <option value="kg">Kilogram (kg)</option>
                            <option value="ltr">Liter (ltr)</option>
                            <option value="box">Box</option>
                            <option value="pack">Pack</option>
                            <option value="bottle">Bottle</option>
                            <option value="meter">Meter (m)</option>
                        </select>
                        <div *ngIf="isFieldInvalid('unit')" class="error-message">
                            {{ getFieldError('unit') }}
                        </div>
                    </div>
                </div>

                <!-- Minimum Stock -->
                <div class="form-field">
                    <label for="minimumStock" class="field-label">
                        Minimum Stock Alert
                    </label>
                    <input 
                        id="minimumStock" 
                        type="number" 
                        formControlName="minimumStock"
                        class="form-input"
                        placeholder="5"
                        min="0"
                        step="1">
                    <div class="field-hint">
                        You'll be notified when stock falls below this level
                    </div>
                </div>
                </div> <!-- End Global Stock Section -->

                <!-- ‚úÖ CONDITIONAL: Branch-Specific Inventory (when enabled) -->
                <div *ngIf="enableBranchSpecificInventory()" class="branch-inventory-section">
                    <h4 class="section-title">üè¢ Branch-Specific Inventory</h4>
                    <p class="section-description">
                        Choose which branches will carry this product, then configure stock and pricing.
                    </p>

                    <!-- ‚úÖ STEP 1: Branch Selection -->
                    <div class="branch-selection-step">
                        <h5 class="step-title">Step 1: Select Target Branches</h5>

                        <!-- Bulk Selection Controls -->
                        <div class="bulk-controls">
                            <button type="button" class="btn btn-sm btn-outline" (click)="selectAllBranches()">
                                ‚úì Select All ({{ branches().length }})
                            </button>
                            <button type="button" class="btn btn-sm btn-outline" (click)="clearAllBranches()">
                                ‚úó Clear All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline" (click)="selectMainBranchesOnly()">
                                üè¢ Main Branches Only
                            </button>
                        </div>

                        <!-- Branch Selection Grid -->
                        <div class="branch-selection-grid">
                            <div class="branch-selector" *ngFor="let branch of branches(); trackBy: trackByBranchDtoId"
                                 [class.selected]="isBranchSelected(branch.id)">
                                <label class="branch-checkbox">
                                    <input type="checkbox"
                                           [checked]="isBranchSelected(branch.id)"
                                           (change)="toggleBranchSelection(branch.id)">
                                    <div class="branch-info">
                                        <span class="branch-name">{{ branch.branchName }}</span>
                                        <span class="branch-id">ID: {{ branch.id }}</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="selection-summary">
                            <span class="selected-count">{{ getActiveBranchCount() }} branches selected</span>
                        </div>
                    </div>

                    <!-- ‚úÖ STEP 2: Bulk Configuration (only if branches selected) -->
                    <div class="bulk-config-step" *ngIf="getActiveBranchCount() > 0">
                        <h5 class="step-title">Step 2: Configure Stock & Pricing</h5>

                        <!-- Bulk Input Controls -->
                        <div class="bulk-input-section">
                            <div class="bulk-input-header">
                                <h6>üöÄ Quick Fill - Apply to Selected Branches</h6>
                                <p>Set common values for all selected branches. Use <strong>Stock Amount</strong> with <strong>Smart Distribution</strong> buttons for automatic distribution.</p>
                            </div>


                            <div class="bulk-input-grid">
                                <!-- Row 1: Stock Amount & Min Stock -->
                                <div class="bulk-field">
                                    <label>Stock Amount</label>
                                    <div class="input-with-action">
                                        <input type="number"
                                               [value]="bulkStock() || productForm.get('stock')?.value || 0"
                                               (input)="bulkStock.set(toNumber($any($event.target).value))"
                                               class="form-input"
                                               [placeholder]="productForm.get('stock')?.value || '100'"
                                               min="0">
                                        <button type="button" class="apply-btn" (click)="applyBulkStock()">
                                            Apply to {{ getSelectedBranchCount() }}
                                        </button>
                                    </div>
                                </div>

                                <div class="bulk-field">
                                    <label>Min Stock</label>
                                    <div class="input-with-action">
                                        <input type="number"
                                               [value]="bulkMinStock() || productForm.get('minimumStock')?.value || 5"
                                               (input)="bulkMinStock.set(toNumber($any($event.target).value))"
                                               class="form-input"
                                               [placeholder]="productForm.get('minimumStock')?.value || '5'"
                                               min="0">
                                        <button type="button" class="apply-btn" (click)="applyBulkMinStock()">
                                            Apply to {{ getSelectedBranchCount() }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Row 2: Buy Price & Sell Price -->
                                <div class="bulk-field">
                                    <label>Buy Price</label>
                                    <div class="input-with-action">
                                        <input type="number"
                                               [value]="bulkBuyPrice() || productForm.get('buyPrice')?.value || 0"
                                               (input)="bulkBuyPrice.set(toNumber($any($event.target).value))"
                                               class="form-input"
                                               [placeholder]="productForm.get('buyPrice')?.value || '5000'"
                                               min="0" step="0.01">
                                        <button type="button" class="apply-btn" (click)="applyBulkBuyPrice()">
                                            Apply to {{ getSelectedBranchCount() }}
                                        </button>
                                    </div>
                                </div>

                                <div class="bulk-field">
                                    <label>Sell Price</label>
                                    <div class="input-with-action">
                                        <input type="number"
                                               [value]="bulkSellPrice() || productForm.get('sellPrice')?.value || 0"
                                               (input)="bulkSellPrice.set(toNumber($any($event.target).value))"
                                               class="form-input"
                                               [placeholder]="productForm.get('sellPrice')?.value || '7500'"
                                               min="0" step="0.01">
                                        <button type="button" class="apply-btn" (click)="applyBulkSellPrice()">
                                            Apply to {{ getSelectedBranchCount() }}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Distribution Options -->
                            <div class="distribution-options">
                                <h6>üìä Smart Distribution</h6>
                                <div class="distribution-buttons">
                                    <button type="button" class="btn btn-sm btn-outline" (click)="distributeStockEvenly()">
                                        ‚öñÔ∏è Distribute Total Stock Evenly
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline" (click)="setStockByBranchSize()">
                                        üìà Set by Branch Size
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Individual Branch Configuration -->
                        <div class="individual-config">
                            <h6>üéØ Individual Branch Settings</h6>
                            <p>Fine-tune settings for specific branches:</p>

                            <div class="branch-config-list">
                                <div class="branch-config-item" *ngFor="let branchInv of getActiveBranchInventories(); trackBy: trackByBranchId">
                                    <div class="branch-config-header">
                                        <span class="branch-name">{{ branchInv.branchName }}</span>
                                        <button type="button" class="remove-branch-btn" (click)="removeBranchFromSelection(branchInv.branchId)">
                                            ‚úó
                                        </button>
                                    </div>

                                    <div class="branch-config-fields">
                                        <div class="config-field">
                                            <label>Stock</label>
                                            <input type="number"
                                                   [value]="branchInv.stock"
                                                   (input)="updateBranchInventory(branchInv.branchId, 'stock', toNumber($any($event.target).value))"
                                                   class="form-input compact"
                                                   min="0">
                                        </div>
                                        <div class="config-field">
                                            <label>Min</label>
                                            <input type="number"
                                                   [value]="branchInv.minimumStock"
                                                   (input)="updateBranchInventory(branchInv.branchId, 'minimumStock', toNumber($any($event.target).value))"
                                                   class="form-input compact"
                                                   min="0">
                                        </div>
                                        <div class="config-field">
                                            <label>Buy Price</label>
                                            <input type="number"
                                                   [value]="branchInv.buyPrice"
                                                   (input)="updateBranchInventory(branchInv.branchId, 'buyPrice', toNumber($any($event.target).value))"
                                                   class="form-input compact"
                                                   min="0" step="0.01">
                                        </div>
                                        <div class="config-field">
                                            <label>Sell Price</label>
                                            <input type="number"
                                                   [value]="branchInv.sellPrice"
                                                   (input)="updateBranchInventory(branchInv.branchId, 'sellPrice', toNumber($any($event.target).value))"
                                                   class="form-input compact"
                                                   min="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="branch-summary">
                            <div class="summary-card">
                                <h6>üìä Final Summary</h6>
                                <div class="summary-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">Total Stock:</span>
                                        <span class="stat-value">{{ getTotalBranchStock() }}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Selected Branches:</span>
                                        <span class="stat-value">{{ getActiveBranchCount() }}/{{ branches().length }}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Avg Price:</span>
                                        <span class="stat-value">{{ getAverageSellPrice() | currency:'IDR':'symbol':'1.0-0' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Optional Description -->
                <div class="form-field">
                    <label for="description" class="field-label">Description (Optional)</label>
                    <textarea 
                        id="description" 
                        formControlName="description"
                        class="form-textarea"
                        placeholder="Enter product description..."
                        rows="3"
                        maxlength="500"></textarea>
                    <div class="field-footer">
                        <span class="char-count">{{productForm.get('description')?.value?.length || 0}}/500</span>
                    </div>
                </div>
            </form>

            <!-- Validation Feedback -->
            <div class="validation-feedback" *ngIf="!canContinueToNextStep() && getMissingRequiredFields().length > 0">
                <div class="feedback-card">
                    <div class="feedback-icon">‚ö†Ô∏è</div>
                    <div class="feedback-content">
                        <h4>Please complete required fields:</h4>
                        <ul class="missing-fields">
                            <li *ngFor="let field of getMissingRequiredFields()">{{ field }}</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Step Actions -->
            <div class="step-actions">
                <button type="button" class="btn btn-secondary" (click)="goBack()">
                    Cancel
                </button>
                <button 
                    type="button" 
                    class="btn btn-primary" 
                    (click)="goToNextStep()"
                    [disabled]="!canContinueToNextStep()">
                    Continue
                    <span class="btn-icon">‚Üí</span>
                </button>
            </div>
        </div>

        <!-- ===== STEP 2: CATEGORY CHECK & BATCH DECISION ===== -->
        <div class="form-step" *ngIf="currentStep() === 'category-check'" [@slideIn]>
            <div class="step-header">
                <div class="step-icon">üéØ</div>
                <div class="step-content">
                    <h2>Batch Tracking Option</h2>
                    <p *ngIf="categoryRequiresExpiry()">
                        This category requires expiry date tracking. Would you like to create a batch?
                    </p>
                    <p *ngIf="!categoryRequiresExpiry()">
                        Would you like to add batch tracking to this product?
                    </p>
                </div>
            </div>

            <!-- Category Info Display -->
            <div class="category-info" *ngIf="selectedCategory()">
                <div class="info-card">
                    <div class="category-color" [style.background-color]="selectedCategory()?.color"></div>
                    <div class="category-details">
                        <h3>{{ selectedCategory()?.name }}</h3>
                        <p class="category-requirement" *ngIf="categoryRequiresExpiry()">
                            ‚ö†Ô∏è This category requires expiry date tracking
                        </p>
                        <p class="category-requirement" *ngIf="!categoryRequiresExpiry()">
                            ‚úÖ Expiry tracking is optional for this category
                        </p>
                    </div>
                </div>
            </div>

            <!-- Batch Decision Cards -->
            <div class="decision-cards">
                <div class="decision-card" 
                     [class.selected]="!skipBatchCreation()"
                     [class.recommended]="categoryRequiresExpiry()"
                     (click)="chooseBatchCreation(true)">
                    <div class="card-icon">üì¶</div>
                    <div class="card-content">
                        <h3>Create Batch</h3>
                        <p>Track expiry dates, production dates, and batch numbers</p>
                        <ul class="benefits">
                            <li>FIFO inventory management</li>
                            <li>Expiry date monitoring</li>
                            <li>Batch-specific operations</li>
                        </ul>
                    </div>
                    <div class="card-action">
                        <span class="action-text" [class.required]="categoryRequiresExpiry()">
                            {{ categoryRequiresExpiry() ? 'Required' : 'Recommended' }}
                        </span>
                    </div>
                    <div class="selection-indicator" *ngIf="!skipBatchCreation()">
                        <span class="checkmark">‚úì</span>
                        <span class="selection-text">Selected</span>
                    </div>
                </div>

                <div class="decision-card" 
                     [class.selected]="skipBatchCreation()"
                     [class.disabled]="categoryRequiresExpiry()"
                     (click)="categoryRequiresExpiry() ? null : chooseBatchCreation(false)">
                    <div class="card-icon">üìã</div>
                    <div class="card-content">
                        <h3>Simple Product</h3>
                        <p>Basic inventory tracking without batches</p>
                        <ul class="benefits">
                            <li>Faster product creation</li>
                            <li>Simpler stock management</li>
                            <li>No expiry tracking</li>
                        </ul>
                        <div *ngIf="categoryRequiresExpiry()" class="disabled-reason">
                            <p class="reason-text">‚ùå Not available for "{{ selectedCategory()?.name }}" category</p>
                            <p class="reason-explanation">This category requires expiry date tracking</p>
                        </div>
                    </div>
                    <div class="card-action">
                        <span class="action-text" *ngIf="!categoryRequiresExpiry()">Skip Batch</span>
                        <span class="action-text disabled" *ngIf="categoryRequiresExpiry()">Not Available</span>
                    </div>
                    <div class="selection-indicator" *ngIf="skipBatchCreation() && !categoryRequiresExpiry()">
                        <span class="checkmark">‚úì</span>
                        <span class="selection-text">Selected</span>
                    </div>
                </div>
            </div>

            <!-- Selection Summary -->
            <div class="selection-summary" *ngIf="!skipBatchCreation() || (skipBatchCreation() && !categoryRequiresExpiry())">
                <div class="summary-card" [class.batch-selected]="!skipBatchCreation()" [class.simple-selected]="skipBatchCreation()">
                    <div class="summary-icon">
                        {{ !skipBatchCreation() ? 'üì¶' : 'üìã' }}
                    </div>
                    <div class="summary-content">
                        <h4>{{ !skipBatchCreation() ? 'Batch Tracking Enabled' : 'Simple Product Mode' }}</h4>
                        <p *ngIf="!skipBatchCreation()">Next step: Configure batch details and expiry date</p>
                        <p *ngIf="skipBatchCreation()">Product will be saved without batch tracking</p>
                    </div>
                </div>
            </div>

            <!-- Step Actions -->
            <div class="step-actions">
                <button type="button" class="btn btn-secondary" (click)="goToPreviousStep()">
                    <span class="btn-icon">‚Üê</span>
                    Back
                </button>
                <button 
                    type="button" 
                    class="btn btn-primary" 
                    (click)="goToNextStep()"
                    [disabled]="!canContinueToNextStep()">
                    {{ skipBatchCreation() ? 'Save Product' : 'Configure Batch' }}
                    <span class="btn-icon">‚Üí</span>
                </button>
            </div>
        </div>

        <!-- ===== STEP 3: BATCH CREATION (CONDITIONAL) ===== -->
        <div class="form-step" *ngIf="currentStep() === 'batch-creation'" [@slideIn]>
            <div class="step-header">
                <div class="step-icon">üì¶</div>
                <div class="step-content">
                    <h2>Batch Details</h2>
                    <p>Set up batch tracking with expiry date and batch information</p>
                </div>
            </div>

            <form [formGroup]="productForm" class="step-form">
                <!-- Batch Number -->
                <div class="form-field">
                    <label for="batchNumber" class="field-label">
                        Batch Number <span class="required">*</span>
                    </label>
                    <div class="input-group">
                        <input 
                            id="batchNumber" 
                            type="text" 
                            formControlName="batchNumber"
                            class="form-input"
                            [class.error]="isFieldInvalid('batchNumber')"
                            placeholder="Enter batch number">
                        <button type="button" class="input-addon-btn" (click)="generateBatchNumber()">
                            üé≤ Generate
                        </button>
                    </div>
                    <div *ngIf="isFieldInvalid('batchNumber')" class="error-message">
                        {{ getFieldError('batchNumber') }}
                    </div>
                </div>

                <!-- Expiry Date -->
                <div class="form-field">
                    <label for="expiryDate" class="field-label">
                        Expiry Date <span class="required">*</span>
                    </label>
                    <input 
                        id="expiryDate" 
                        type="date" 
                        formControlName="expiryDate"
                        class="form-input"
                        [class.error]="isFieldInvalid('expiryDate')"
                        [min]="getMinExpiryDate()">
                    <div *ngIf="isFieldInvalid('expiryDate')" class="error-message">
                        {{ getFieldError('expiryDate') }}
                    </div>
                    
                    <!-- Expiry Status Preview -->
                    <div class="expiry-preview" *ngIf="productForm.get('expiryDate')?.value">
                        <div class="expiry-status" [class]="currentExpiryStatus()">
                            <span class="status-icon">{{ currentExpiryStatus() === 'good' ? '‚úÖ' : currentExpiryStatus() === 'warning' ? '‚ö†Ô∏è' : 'üö®' }}</span>
                            <span class="status-text">{{ expiryStatusText() }}</span>
                        </div>
                    </div>
                </div>

                <!-- Production Date (Optional) -->
                <div class="form-field">
                    <label for="productionDate" class="field-label">Production Date (Optional)</label>
                    <input 
                        id="productionDate" 
                        type="date" 
                        formControlName="productionDate"
                        class="form-input"
                        [max]="getMinExpiryDate()">
                    <div class="field-hint">
                        When was this batch produced or manufactured?
                    </div>
                </div>

                <!-- Supplier Information (Optional) -->
                <div class="form-field">
                    <label for="supplierName" class="field-label">Supplier (Optional)</label>
                    <input 
                        id="supplierName" 
                        type="text" 
                        formControlName="supplierName"
                        class="form-input"
                        placeholder="Enter supplier name">
                </div>

                <!-- Purchase Order (Optional) -->
                <div class="form-field">
                    <label for="purchaseOrderNumber" class="field-label">Purchase Order (Optional)</label>
                    <input 
                        id="purchaseOrderNumber" 
                        type="text" 
                        formControlName="purchaseOrderNumber"
                        class="form-input"
                        placeholder="Enter PO number">
                </div>

                <!-- Batch Notes (Optional) -->
                <div class="form-field">
                    <label for="batchNotes" class="field-label">Batch Notes (Optional)</label>
                    <textarea 
                        id="batchNotes" 
                        formControlName="batchNotes"
                        class="form-textarea"
                        placeholder="Any additional notes about this batch..."
                        rows="3"></textarea>
                </div>
            </form>

            <!-- Step Actions -->
            <div class="step-actions">
                <button type="button" class="btn btn-secondary" (click)="goToPreviousStep()">
                    <span class="btn-icon">‚Üê</span>
                    Back
                </button>
                <button 
                    type="button" 
                    class="btn btn-primary" 
                    (click)="goToNextStep()"
                    [disabled]="!canContinueToNextStep() || saving()">
                    <span *ngIf="saving()" class="spinner small"></span>
                    <span *ngIf="!saving()">Save Product</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ‚úÖ LOADING STATE -->
    <div *ngIf="loading()" class="loading-container">
        <div class="spinner large"></div>
        <h3>Loading Product Details...</h3>
        <p>Please wait while we prepare the form</p>
    </div>

    <!-- ‚úÖ MOBILE HELP BUTTON -->
    <button class="help-button" type="button" (click)="showHelpModal = true">
        <span class="help-icon">?</span>
    </button>
</div>

<!-- ‚úÖ HELP MODAL (Mobile-friendly) -->
<div class="modal-overlay" *ngIf="showHelpModal" (click)="showHelpModal = false">
    <div class="help-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Product Form Help</h3>
            <button type="button" class="close-button" (click)="showHelpModal = false">√ó</button>
        </div>
        <div class="modal-content">
            <div class="help-section">
                <h4>Step 1: Basic Information</h4>
                <p>Enter essential product details like name, barcode, category, and pricing.</p>
            </div>
            <div class="help-section">
                <h4>Step 2: Batch Decision</h4>
                <p>Choose whether to enable batch tracking for expiry management.</p>
            </div>
            <div class="help-section">
                <h4>Step 3: Batch Details</h4>
                <p>Configure batch number, expiry date, and additional batch information.</p>
            </div>
        </div>
    </div>
</div>