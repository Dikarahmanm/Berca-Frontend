<!-- ‚úÖ REDESIGNED: Product Form Template - Clean Simple Design -->
<!-- Following Toko Eniwan POS Design Guidelines: No transparency, high contrast, light theme only -->

<div class="product-form-container">

    <!-- Header Section - Simplified -->
    <div class="form-header">
        <div class="header-content">
            <div class="title-section">
                <button class="back-button" (click)="goBack()">
                    <span class="icon">‚Üê</span>
                </button>
                <div class="title-content">
                    <h1 class="page-title">{{ pageTitle() }}</h1>
                    <p class="page-subtitle">{{ pageSubtitle() }}</p>
                </div>
            </div>

            <div class="header-actions">
                <button class="btn btn-secondary" type="button" (click)="goBack()" [disabled]="saving">
                    Cancel
                </button>
                <button class="btn btn-primary" type="submit" form="productForm" [disabled]="!canSubmit()">
                    <span *ngIf="saving" class="spinner"></span>
                    <span *ngIf="!saving">{{ submitButtonText() }}</span>
                </button>
            </div>
        </div>

        <!-- Unsaved Changes Warning -->
        <div *ngIf="hasUnsavedChanges() && !saving" class="unsaved-warning">
            <span class="icon">‚Ñπ</span>
            <span>You have unsaved changes</span>
        </div>
    </div>


    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-container">
        <div class="spinner large"></div>
        <p>Loading product details...</p>
    </div>

    <!-- Product Form -->
    <form *ngIf="!loading()" id="productForm" [formGroup]="productForm" (ngSubmit)="onSubmit()" class="product-form">

        <!-- Basic Information Section -->
        <div class="form-section">
            <div class="section-header">
                <h2>
                    <span class="icon">üìù</span>
                    Basic Information
                </h2>
                <p>Enter the main product details</p>
            </div>

            <div class="form-grid">
                <!-- Product Name -->
                <div class="form-field full-width">
                    <label for="name">Product Name *</label>
                    <input id="name" type="text" formControlName="name" placeholder="Enter product name" maxlength="100"
                        [class.error]="isFieldInvalid('name')">
                    <div class="field-footer">
                        <span class="hint">{{productForm.get('name')?.value?.length || 0}}/100</span>
                    </div>
                    <div *ngIf="isFieldInvalid('name')" class="error-message">
                        {{ getFieldError('name') }}
                    </div>
                </div>

                <!-- Description -->
                <div class="form-field full-width">
                    <label for="description">Description</label>
                    <textarea id="description" formControlName="description"
                        placeholder="Enter product description (optional)" rows="3" maxlength="500"
                        [class.error]="isFieldInvalid('description')"></textarea>
                    <div class="field-footer">
                        <span class="hint">{{productForm.get('description')?.value?.length || 0}}/500</span>
                    </div>
                    <div *ngIf="isFieldInvalid('description')" class="error-message">
                        {{ getFieldError('description') }}
                    </div>
                </div>

                <!-- Category -->
                <div class="form-field">
                    <label for="category">üìÇ Category *</label>
                    <select id="category" formControlName="categoryId" [class.error]="isFieldInvalid('categoryId')">
                        <option value="" disabled>Select category</option>
                        <option *ngFor="let category of categories()" [value]="category.id">
                            <div class="category-option">
                                <span class="category-color" [style.background-color]="category.color"></span>
                                {{ category.name }}
                            </div>
                        </option>
                    </select>
                    <div *ngIf="isFieldInvalid('categoryId')" class="error-message">
                        {{ getFieldError('categoryId') }}
                    </div>
                </div>

                <!-- ‚úÖ ENHANCED: Category Information Panel with Clearer Messaging -->
                @if (selectedCategory() && !showExpiryField()) {
                    <div class="info-message success">
                        <span class="icon">‚úÖ</span>
                        <div class="message-content">
                            <p><strong>{{ selectedCategory()?.name }}</strong> - Tidak memerlukan tanggal kadaluarsa</p>
                            <p class="small">Produk dalam kategori ini dapat disimpan tanpa perlu melacak masa kadaluarsa.</p>
                        </div>
                    </div>
                }

                @if (selectedCategory() && showExpiryField()) {
                    <div class="info-message warning">
                        <span class="icon">‚ö†Ô∏è</span>
                        <div class="message-content">
                            <p><strong>{{ selectedCategory()?.name }}</strong> - Wajib mencantumkan tanggal kadaluarsa</p>
                            <p class="small">
                                Produk dalam kategori ini harus dilengkapi dengan:
                                <br>‚Ä¢ Tanggal kadaluarsa untuk monitoring masa simpan
                                <br>‚Ä¢ Informasi batch untuk pelacakan yang akurat
                            </p>
                        </div>
                    </div>
                }

                <!-- Unit -->
                <div class="form-field">
                    <label for="unit">Unit *</label>
                    <select id="unit" formControlName="unit" [class.error]="isFieldInvalid('unit')">
                        <option value="pcs">Pieces (pcs)</option>
                        <option value="kg">Kilogram (kg)</option>
                        <option value="gram">Gram (g)</option>
                        <option value="liter">Liter (L)</option>
                        <option value="ml">Milliliter (mL)</option>
                        <option value="meter">Meter (m)</option>
                        <option value="cm">Centimeter (cm)</option>
                        <option value="box">Box</option>
                        <option value="pack">Pack</option>
                        <option value="bottle">Bottle</option>
                    </select>
                    <div class="field-footer">
                        <span class="hint">Unit of measurement</span>
                    </div>
                    <div *ngIf="isFieldInvalid('unit')" class="error-message">
                        {{ getFieldError('unit') }}
                    </div>
                </div>

                <!-- ‚úÖ ENHANCED: Simplified Expiry Date Field with Batch Modal -->
                <div *ngIf="showExpiryField()" class="form-field full-width">
                    <label for="expiryDate">
                        üìÖ Tanggal Kadaluarsa {{ expiryFieldRequired() ? '*' : '' }}
                        <span *ngIf="expiryValidating()" class="validating-spinner">‚è≥</span>
                    </label>
                    
                    <div class="expiry-input-group">
                        <input 
                            id="expiryDate" 
                            type="date" 
                            formControlName="expiryDate" 
                            [min]="getMinExpiryDate()"
                            [class.error]="isFieldInvalid('expiryDate')"
                            [class.validating]="expiryValidating()"
                            placeholder="Pilih tanggal kadaluarsa">
                        
                        <button type="button" class="btn btn-outline" 
                                [disabled]="!productForm.get('expiryDate')?.value"
                                (click)="openBatchManagementModal()">
                            <span class="icon">üì¶</span>
                            {{ productForm.get('batchNumber')?.value ? 'Edit Batch' : 'Atur Batch' }}
                        </button>
                    </div>
                    
                    <!-- Enhanced Expiry Status Preview -->
                    <div *ngIf="productForm.get('expiryDate')?.value" class="expiry-status-preview">
                        <div class="status-indicator" [ngClass]="'status-' + currentExpiryStatus()">
                            <span class="status-icon">
                                {{ currentExpiryStatus() === 'expired' ? '‚ùå' : 
                                   currentExpiryStatus() === 'critical' ? 'üö®' : 
                                   currentExpiryStatus() === 'warning' ? '‚ö†Ô∏è' : '‚úÖ' }}
                            </span>
                            <span class="status-text">{{ expiryStatusText() }}</span>
                            <span *ngIf="productForm.get('batchNumber')?.value" class="batch-info">
                                ‚Ä¢ Batch: {{ productForm.get('batchNumber')?.value }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="field-footer">
                        <span class="hint">
                            {{ expiryFieldRequired() ? 'Wajib untuk kategori ini' : 'Opsional' }} - 
                            Setelah mengisi tanggal, klik "Atur Batch" untuk melengkapi informasi batch
                        </span>
                    </div>
                    
                    <!-- Enhanced Expiry Validation Errors -->
                    <div *ngIf="expiryValidationErrors().length > 0" class="error-message">
                        <div *ngFor="let error of expiryValidationErrors()">
                            {{ error }}
                        </div>
                    </div>
                    
                    <div *ngIf="isFieldInvalid('expiryDate')" class="error-message">
                        {{ getFieldError('expiryDate') }}
                    </div>
                </div>


                <!-- Barcode Section -->
                <div class="form-field full-width">
                    <label for="barcode">Barcode *</label>
                    <div class="barcode-input-group">
                        <input id="barcode" type="text" formControlName="barcode" placeholder="Enter or scan barcode"
                            maxlength="50" [class.error]="isFieldInvalid('barcode')">

                        <button type="button" class="btn btn-outline" (click)="startBarcodeScanner()"
                            [disabled]="scannerActive()">
                            <span class="icon">üì∑</span>
                            {{ scannerActive() ? 'Scanning...' : 'Scan' }}
                        </button>

                        <button type="button" class="btn btn-outline" (click)="generateBarcode()">
                            <span class="icon">‚ú®</span>
                            Generate
                        </button>
                    </div>

                    <div *ngIf="barcodeError()" class="error-message">
                        <span class="icon">‚ö†</span>
                        {{ barcodeError() }}
                    </div>
                    <div *ngIf="isFieldInvalid('barcode')" class="error-message">
                        {{ getFieldError('barcode') }}
                    </div>
                </div>

                <!-- Product Status -->
                <div class="form-field full-width">
                    <div class="toggle-field">
                        <input type="checkbox" id="isActive" formControlName="isActive" class="toggle-input">
                        <label for="isActive" class="toggle-label">
                            <span class="toggle-switch"></span>
                            <span class="toggle-text">
                                <span class="icon">{{ productForm.get('isActive')?.value ? 'üëÅ' : 'üëÅ‚Äçüó®' }}</span>
                                {{ productForm.get('isActive')?.value ? 'Active' : 'Inactive' }}
                            </span>
                        </label>
                    </div>
                    <div class="field-footer">
                        <span class="hint">
                            {{ productForm.get('isActive')?.value ? 'Product is available for sale' : 'Product is hidden
                            from sales' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Information Section -->
        <div class="form-section">
            <div class="section-header">
                <h2>
                    <span class="icon">üì¶</span>
                    Stock Information
                </h2>
                <p>Configure stock levels and alerts</p>
            </div>

            <div class="form-grid">
                <!-- Current Stock -->
                <div class="form-field">
                    <label for="stock">Current Stock *</label>
                    <div class="input-with-suffix">
                        <input id="stock" type="number" formControlName="stock" placeholder="0" min="0"
                            [class.error]="isFieldInvalid('stock')">
                        <span class="suffix">{{ productForm.get('unit')?.value || 'pcs' }}</span>
                    </div>
                    <div class="field-footer">
                        <span class="hint">Available quantity in inventory</span>
                    </div>
                    <div *ngIf="isFieldInvalid('stock')" class="error-message">
                        {{ getFieldError('stock') }}
                    </div>
                </div>

                <!-- Minimum Stock -->
                <div class="form-field">
                    <label for="minimumStock">Minimum Stock *</label>
                    <div class="input-with-suffix">
                        <input id="minimumStock" type="number" formControlName="minimumStock" placeholder="5" min="0"
                            [class.error]="isFieldInvalid('minimumStock')">
                        <span class="suffix">{{ productForm.get('unit')?.value || 'pcs' }}</span>
                    </div>
                    <div class="field-footer">
                        <span class="hint">Alert when stock reaches this level</span>
                    </div>
                    <div *ngIf="isFieldInvalid('minimumStock')" class="error-message">
                        {{ getFieldError('minimumStock') }}
                    </div>
                </div>

                <!-- Stock Status Preview -->
                <div class="form-field full-width">
                    <div class="preview-card">
                        <div class="preview-header">
                            <span class="icon"
                                [style.color]="productForm.get('stock')?.value <= productForm.get('minimumStock')?.value ? '#FF914D' : '#4BBF7B'">
                                {{ productForm.get('stock')?.value <= productForm.get('minimumStock')?.value ? '‚ö†' : '‚úì'
                                    }} </span>
                                    <span>Stock Status Preview</span>
                        </div>
                        <div class="preview-content">
                            <div class="stock-info">
                                <span class="stock-amount">{{ productForm.get('stock')?.value || 0 }}</span>
                                <span class="stock-label">Available</span>
                            </div>
                            <div class="stock-info">
                                <span class="stock-amount">{{ productForm.get('minimumStock')?.value || 0 }}</span>
                                <span class="stock-label">Minimum</span>
                            </div>
                            <div class="stock-status"
                                [class.warning]="productForm.get('stock')?.value <= productForm.get('minimumStock')?.value">
                                {{ productForm.get('stock')?.value <= productForm.get('minimumStock')?.value
                                    ? 'Low Stock Alert' : 'Stock OK' }} </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Information Section -->
            <div class="form-section">
                <div class="section-header">
                    <h2>
                        <span class="icon">üí∞</span>
                        Pricing Information
                    </h2>
                    <p>Set buy and sell prices for profit calculation</p>
                </div>

                <div class="form-grid">
                    <!-- Buy Price -->
                    <div class="form-field">
                        <label for="buyPrice">Buy Price *</label>
                        <div class="input-with-prefix">
                            <span class="prefix">Rp</span>
                            <input id="buyPrice" type="number" formControlName="buyPrice" placeholder="0" min="0"
                                step="1000" [class.error]="isFieldInvalid('buyPrice')">
                        </div>
                        <div class="field-footer">
                            <span class="hint">Cost price from supplier per {{ productForm.get('unit')?.value || 'unit'
                                }}</span>
                        </div>
                        <div *ngIf="isFieldInvalid('buyPrice')" class="error-message">
                            {{ getFieldError('buyPrice') }}
                        </div>
                    </div>

                    <!-- Sell Price -->
                    <div class="form-field">
                        <label for="sellPrice">Sell Price *</label>
                        <div class="input-with-prefix">
                            <span class="prefix">Rp</span>
                            <input id="sellPrice" type="number" formControlName="sellPrice" placeholder="0" min="0"
                                step="1000" [class.error]="isFieldInvalid('sellPrice')">
                        </div>
                        <div class="field-footer">
                            <span class="hint">Customer selling price per {{ productForm.get('unit')?.value || 'unit'
                                }}</span>
                        </div>
                        <div *ngIf="isFieldInvalid('sellPrice')" class="error-message">
                            {{ getFieldError('sellPrice') }}
                        </div>
                    </div>

                    <!-- Profit Calculation Preview -->
                    <div class="form-field full-width">
                        <div class="preview-card">
                            <div class="preview-header">
                                <span class="icon" [style.color]="getMarginPercentage() > 0 ? '#4BBF7B' : '#E15A4F'">
                                    {{ getMarginPercentage() > 0 ? 'üìà' : 'üìâ' }}
                                </span>
                                <span>Profit Analysis</span>
                            </div>
                            <div class="preview-content pricing-grid">
                                <div class="price-info">
                                    <span class="price-label">Buy Price</span>
                                    <span class="price-amount">{{ formatCurrency(productForm.get('buyPrice')?.value ||
                                        0) }}</span>
                                </div>
                                <div class="price-info">
                                    <span class="price-label">Sell Price</span>
                                    <span class="price-amount">{{ formatCurrency(productForm.get('sellPrice')?.value ||
                                        0) }}</span>
                                </div>
                                <div class="price-info">
                                    <span class="price-label">Profit per {{ productForm.get('unit')?.value || 'Unit'
                                        }}</span>
                                    <span class="price-amount" [class.positive]="getMarginAmount() > 0"
                                        [class.negative]="getMarginAmount() <= 0">
                                        {{ formatCurrency(getMarginAmount()) }}
                                    </span>
                                </div>
                                <div class="price-info">
                                    <span class="price-label">Margin</span>
                                    <span class="price-amount" [class.positive]="getMarginPercentage() > 0"
                                        [class.negative]="getMarginPercentage() <= 0">
                                        {{ getMarginPercentage().toFixed(1) }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <div class="actions-content">
                    <div class="form-summary">
                        <span class="icon">‚Ñπ</span>
                        <div class="summary-text">
                            <span class="summary-title">Form Summary</span>
                            <span class="summary-details">
                                {{ productForm.valid ? 'All fields are valid' : 'Please complete required fields' }}
                            </span>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" type="button" (click)="goBack()" [disabled]="saving">
                            Cancel
                        </button>
                        <button class="btn btn-primary" type="submit" [disabled]="!canSubmit()">
                            <span *ngIf="saving" class="spinner"></span>
                            <span *ngIf="!saving">{{ submitButtonText() }}</span>
                        </button>
                    </div>
                </div>
            </div>
    </form>

    <!-- ‚úÖ NEW: Batch Management Modal -->
    <div *ngIf="batchModalActive()" class="batch-modal">
        <div class="modal-backdrop" (click)="closeBatchManagementModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì¶ Batch Management</h3>
                <p class="modal-subtitle">Kelola informasi batch untuk produk dengan tanggal kadaluarsa</p>
                <button class="close-button" (click)="closeBatchManagementModal()">√ó</button>
            </div>

            <div class="modal-body">
                <!-- Batch Information Form -->
                <div class="batch-form">
                    <!-- Batch Number -->
                    <div class="form-field">
                        <label for="modalBatchNumber">Nomor Batch *</label>
                        <div class="input-group">
                            <input id="modalBatchNumber" type="text" formControlName="batchNumber" 
                                   placeholder="Contoh: B20240315001" maxlength="50"
                                   [class.error]="isFieldInvalid('batchNumber')">
                            <button type="button" class="btn btn-outline" (click)="generateBatchNumber()">
                                <span class="icon">‚ú®</span>
                                Generate
                            </button>
                        </div>
                        <div class="field-footer">
                            <span class="hint">Identifier unik untuk batch produk ini</span>
                        </div>
                        <div *ngIf="isFieldInvalid('batchNumber')" class="error-message">
                            {{ getFieldError('batchNumber') }}
                        </div>
                    </div>

                    <!-- Production Date -->
                    <div class="form-field">
                        <label for="modalProductionDate">Tanggal Produksi</label>
                        <input id="modalProductionDate" type="date" formControlName="productionDate"
                               [max]="getMinExpiryDate()"
                               [class.error]="isFieldInvalid('productionDate')">
                        <div class="field-footer">
                            <span class="hint">Opsional - Kapan batch ini diproduksi</span>
                        </div>
                    </div>

                    <!-- Supplier Name -->
                    <div class="form-field">
                        <label for="modalSupplierName">Supplier</label>
                        <input id="modalSupplierName" type="text" formControlName="supplierName" 
                               placeholder="Nama supplier" maxlength="200"
                               [class.error]="isFieldInvalid('supplierName')">
                        <div class="field-footer">
                            <span class="hint">Opsional - Supplier untuk batch ini</span>
                        </div>
                    </div>

                    <!-- Purchase Order Number -->
                    <div class="form-field">
                        <label for="modalPurchaseOrderNumber">Nomor PO</label>
                        <input id="modalPurchaseOrderNumber" type="text" formControlName="purchaseOrderNumber" 
                               placeholder="Nomor purchase order" maxlength="50"
                               [class.error]="isFieldInvalid('purchaseOrderNumber')">
                        <div class="field-footer">
                            <span class="hint">Opsional - Referensi purchase order</span>
                        </div>
                    </div>

                    <!-- Batch Notes -->
                    <div class="form-field">
                        <label for="modalBatchNotes">Catatan Batch</label>
                        <textarea id="modalBatchNotes" formControlName="batchNotes" 
                                  placeholder="Catatan tambahan untuk batch ini..." 
                                  rows="3" maxlength="500"
                                  [class.error]="isFieldInvalid('batchNotes')"></textarea>
                        <div class="field-footer">
                            <span class="hint">{{productForm.get('batchNotes')?.value?.length || 0}}/500 - Informasi tambahan tentang batch</span>
                        </div>
                    </div>
                </div>

                <!-- Batch Summary -->
                <div class="batch-summary">
                    <div class="summary-header">
                        <span class="icon">üìã</span>
                        <span>Ringkasan Batch</span>
                    </div>
                    <div class="summary-content">
                        <div class="summary-item">
                            <span class="label">Tanggal Kadaluarsa:</span>
                            <span class="value">{{ (productForm.get('expiryDate')?.value | date:'mediumDate') || 'Belum diatur' }}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Nomor Batch:</span>
                            <span class="value">{{ productForm.get('batchNumber')?.value || 'Belum diatur' }}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Status:</span>
                            <span class="value" [ngClass]="getBatchValidationStatus()">
                                {{ getBatchValidationMessage() }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Batch Validation Errors -->
                <div *ngIf="batchValidationErrors().length > 0" class="error-message">
                    <div *ngFor="let error of batchValidationErrors()">
                        <span class="icon">‚ö†</span>
                        {{ error }}
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" (click)="closeBatchManagementModal()">
                    Batal
                </button>
                <button class="btn btn-primary" 
                        [disabled]="!isBatchFormValid()"
                        (click)="saveBatchInformation()">
                    <span class="icon">‚úÖ</span>
                    Simpan Batch
                </button>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div *ngIf="scannerActive()" class="scanner-modal">
        <div class="scanner-backdrop" (click)="stopBarcodeScanner()"></div>
        <div class="scanner-content">
            <div class="scanner-header">
                <h3>Scan Product Barcode</h3>
                <button class="close-button" (click)="stopBarcodeScanner()">√ó</button>
            </div>

            <div class="scanner-body">
                <div id="barcode-scanner" class="scanner-target" [style.display]="scannerActive() ? 'block' : 'none'">
                </div>

                <div class="scanner-placeholder" [style.display]="scannerActive() ? 'none' : 'flex'">
                    <span class="icon">üì∑</span>
                    <p>Position barcode within the frame</p>
                    <div class="spinner"></div>
                </div>
            </div>

            <div class="scanner-actions">
                <button class="btn btn-secondary" (click)="stopBarcodeScanner()">
                    Cancel Scanning
                </button>
            </div>
        </div>
    </div>
</div>