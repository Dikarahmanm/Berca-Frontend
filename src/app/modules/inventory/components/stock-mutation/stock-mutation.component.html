<!-- ‚úÖ REDESIGNED: Unified Batch-Aware Stock Mutation Interface -->
<!-- Phase 3: Batch Selection First ‚Üí Context-Aware Operations ‚Üí Operation Details -->

<div class="batch-mutation-container">
  <!-- ‚úÖ HEADER: Product Context & Navigation -->
  <div class="mutation-header">
    <div class="header-content">
      <button 
        class="back-button" 
        (click)="goBack()"
        [disabled]="loading() || saving()"
        matTooltip="Back to Inventory">
        <span class="back-icon">‚Üê</span>
        <span class="back-text">Inventory</span>
      </button>

      <div class="product-context" *ngIf="product()">
        <div class="product-main">
          <h1 class="product-name">{{ product()?.name }}</h1>
          <p class="product-details">
            {{ product()?.categoryName }} ‚Ä¢ {{ product()?.unit }}
            <span class="total-stock">{{ formatStock(product()?.stock, product()?.unit) }}</span>
          </p>
        </div>

        <div class="header-actions">
          <button 
            class="btn btn-outline"
            (click)="editProduct()"
            [disabled]="loading() || saving()">
            <span class="btn-icon">‚úèÔ∏è</span>
            Edit Product
          </button>
        </div>
      </div>
    </div>

    <!-- Step Progress Indicator -->
    <div class="step-progress">
      <div class="step-item" [class.active]="!selectedBatch()" [class.completed]="selectedBatch()">
        <span class="step-number">1</span>
        <span class="step-label">Select Batch</span>
      </div>
      <div class="step-connector" [class.active]="selectedBatch()"></div>
      <div class="step-item" [class.active]="selectedBatch() && !operationType()" [class.completed]="operationType()">
        <span class="step-number">2</span>
        <span class="step-label">Choose Operation</span>
      </div>
      <div class="step-connector" [class.active]="operationType()"></div>
      <div class="step-item" [class.active]="selectedBatch() && operationType()">
        <span class="step-number">3</span>
        <span class="step-label">Execute</span>
      </div>
    </div>
  </div>

  <!-- ‚úÖ LOADING STATE -->
  <div *ngIf="loading()" class="loading-container">
    <div class="loading-content">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="loading-text">Loading product and batch data...</p>
    </div>
  </div>

  <!-- ‚úÖ MAIN CONTENT: Unified Workflow -->
  <div *ngIf="!loading()" class="mutation-content">
    
    <!-- ‚úÖ STEP 1: BATCH SELECTION (Always Visible) -->
    <div class="workflow-section batch-selection">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üì¶</span>
          Available Batches
        </h2>
        <p class="section-subtitle">Select the batch you want to operate on</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="productBatches().length === 0" class="empty-batches">
        <div class="empty-content">
          <span class="empty-icon">üì¶</span>
          <h3 class="empty-title">No Batches Available</h3>
          <p class="empty-text">This product doesn't have any batches yet.</p>
          <button class="btn btn-primary" (click)="editProduct()">
            <span class="btn-icon">‚ûï</span>
            Create First Batch
          </button>
        </div>
      </div>

      <!-- Batch Cards Grid -->
      <div *ngIf="productBatches().length > 0" class="batch-grid">
        <div 
          *ngFor="let batch of productBatches(); let i = index; trackBy: trackByBatch"
          class="batch-card"
          [class.selected]="selectedBatch()?.id === batch.id"
          [class.recommended]="recommendedBatch()?.id === batch.id"
          (click)="selectBatch(batch)"
          [@slideIn]>
          
          <!-- Batch Header -->
          <div class="batch-header">
            <div class="batch-identity">
              <h3 class="batch-number">{{ batch.batchNumber }}</h3>
              <div class="batch-status">
                <span class="status-indicator" [class]="getBatchStatusClass(batch)">
                  <span class="status-icon">{{ getBatchStatusIcon(batch) }}</span>
                  <span class="status-text">{{ batch.status }}</span>
                </span>
              </div>
            </div>
            
            <div class="batch-selection">
              <div class="selection-indicator" [class.selected]="selectedBatch()?.id === batch.id">
                <span class="selection-checkmark">‚úì</span>
              </div>
            </div>
          </div>

          <!-- Batch Details -->
          <div class="batch-details">
            <div class="detail-row">
              <span class="detail-label">Current Stock</span>
              <span class="detail-value stock">{{ formatStock(batch.currentQuantity, product()?.unit) }}</span>
            </div>
            
            <div class="detail-row" *ngIf="batch.expiryDate">
              <span class="detail-label">Expiry</span>
              <span class="detail-value expiry" [class]="getBatchStatusClass(batch)">
                {{ formatExpiryInfo(batch) }}
              </span>
            </div>
            
            <div class="detail-row">
              <span class="detail-label">Unit Cost</span>
              <span class="detail-value cost">{{ formatCurrency(batch.unitCost) }}</span>
            </div>
          </div>

          <!-- Recommendation Badge -->
          <div *ngIf="recommendedBatch()?.id === batch.id" class="recommendation-badge">
            <span class="badge-icon">‚≠ê</span>
            <span class="badge-text">Recommended</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ STEP 2: OPERATION SELECTION (Context-Aware) -->
    <div *ngIf="selectedBatch()" class="workflow-section operation-selection" [@fadeIn]>
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">‚öôÔ∏è</span>
          Choose Operation
        </h2>
        <p class="section-subtitle">
          What would you like to do with batch <strong>{{ selectedBatch()?.batchNumber }}</strong>?
        </p>
      </div>

      <!-- Smart Recommendations -->
      <div *ngIf="batchRecommendations().length > 0" class="recommendations-section">
        <h3 class="recommendations-title">
          <span class="recommendations-icon">üí°</span>
          Smart Recommendations
        </h3>
        
        <div class="recommendations-grid">
          <div 
            *ngFor="let recommendation of batchRecommendations().slice(0, 2)"
            class="recommendation-card"
            [class]="'priority-' + recommendation.priority"
            (click)="selectRecommendedBatch(recommendation)">
            
            <div class="recommendation-content">
              <div class="recommendation-header">
                <span class="recommendation-batch">{{ recommendation.batch.batchNumber }}</span>
                <span class="recommendation-priority">{{ recommendation.priority.toUpperCase() }}</span>
              </div>
              <p class="recommendation-reason">{{ recommendation.reason }}</p>
              <p class="recommendation-action">{{ recommendation.action }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Operation Type Cards -->
      <div class="operation-grid">
        <div 
          *ngFor="let operation of batchOperations"
          class="operation-card"
          [class.selected]="operationType() === operation.type"
          [class.fifo-recommended]="operation.fifoRecommended"
          (click)="selectOperation(operation.type)"
          [@slideIn]>
          
          <div class="operation-header">
            <span class="operation-icon" [style.color]="operation.color">{{ operation.icon }}</span>
            <h3 class="operation-label">{{ operation.label }}</h3>
          </div>
          
          <p class="operation-description">{{ operation.description }}</p>
          
          <!-- FIFO Badge -->
          <div *ngIf="operation.fifoRecommended" class="fifo-badge">
            <span class="fifo-text">FIFO Recommended</span>
          </div>
          
          <!-- Selection Indicator -->
          <div class="operation-selection" [class.selected]="operationType() === operation.type">
            <span class="selection-checkmark">‚úì</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ STEP 3: OPERATION DETAILS & EXECUTION -->
    <div *ngIf="selectedBatch() && operationType()" class="workflow-section operation-details" [@fadeIn]>
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üìù</span>
          Operation Details
        </h2>
        <p class="section-subtitle">
          Configure your <strong>{{ operationType() }}</strong> operation for batch 
          <strong>{{ selectedBatch()?.batchNumber }}</strong>
        </p>
      </div>

      <!-- Current Context Summary -->
      <div class="context-summary">
        <div class="context-item">
          <span class="context-label">Selected Batch:</span>
          <span class="context-value">{{ selectedBatch()?.batchNumber }}</span>
        </div>
        <div class="context-item">
          <span class="context-label">Current Stock:</span>
          <span class="context-value">{{ formatStock(selectedBatch()?.currentQuantity, product()?.unit) }}</span>
        </div>
        <div class="context-item">
          <span class="context-label">Operation:</span>
          <span class="context-value">{{ getOperationLabel() }}</span>
        </div>
      </div>

      <!-- Operation Form -->
      <form [formGroup]="operationForm" class="operation-form">
        
        <!-- Quantity Input -->
        <div class="form-field">
          <label class="field-label">
            Quantity 
            <span class="required-indicator">*</span>
          </label>
          <div class="quantity-input-group">
            <input 
              type="number" 
              formControlName="quantity"
              class="quantity-input"
              [class.error]="isFieldInvalid('quantity')"
              placeholder="Enter quantity"
              min="1"
              step="1">
            <span class="quantity-unit">{{ product()?.unit }}</span>
          </div>
          <div *ngIf="isFieldInvalid('quantity')" class="field-error">
            {{ getFieldError('quantity') }}
          </div>
          <div *ngIf="operationType() === 'remove-stock'" class="field-hint">
            Maximum available: {{ formatStock(selectedBatch()?.currentQuantity, product()?.unit) }}
          </div>
        </div>

        <!-- Target Batch (for transfers) -->
        <div *ngIf="operationType() === 'transfer'" class="form-field">
          <label class="field-label">Target Batch</label>
          <select formControlName="targetBatchId" class="form-select">
            <option value="">Select target batch</option>
            <option 
              *ngFor="let batch of productBatches()" 
              [value]="batch.id"
              [disabled]="batch.id === selectedBatch()?.id">
              {{ batch.batchNumber }} ({{ formatStock(batch.currentQuantity, product()?.unit) }})
            </option>
          </select>
          <div class="field-hint">Choose which batch to transfer stock to</div>
        </div>

        <!-- Unit Cost (for add-stock) -->
        <div *ngIf="operationType() === 'add-stock'" class="form-field">
          <label class="field-label">Unit Cost</label>
          <div class="currency-input-group">
            <span class="currency-prefix">Rp</span>
            <input 
              type="number" 
              formControlName="unitCost"
              class="currency-input"
              placeholder="0"
              min="0"
              step="100">
          </div>
          <div class="field-hint">Leave blank to use existing cost ({{ formatCurrency(selectedBatch()?.unitCost) }})</div>
        </div>

        <!-- Reference Number -->
        <div class="form-field">
          <label class="field-label">Reference Number</label>
          <input 
            type="text" 
            formControlName="referenceNumber"
            class="form-input"
            placeholder="PO number, invoice, etc.">
          <div class="field-hint">Optional reference for tracking</div>
        </div>

        <!-- Notes -->
        <div class="form-field">
          <label class="field-label">
            Notes 
            <span class="required-indicator">*</span>
          </label>
          <textarea 
            formControlName="notes"
            class="form-textarea"
            [class.error]="isFieldInvalid('notes')"
            placeholder="Reason for this operation..."
            rows="3"></textarea>
          <div *ngIf="isFieldInvalid('notes')" class="field-error">
            {{ getFieldError('notes') }}
          </div>
          <div class="field-hint">Describe the reason for this stock operation</div>
        </div>
      </form>

      <!-- Operation Preview -->
      <div *ngIf="operationForm.valid" class="operation-preview" [@slideIn]>
        <h3 class="preview-title">Operation Preview</h3>
        <div class="preview-content">
          <div class="preview-row">
            <span class="preview-label">Operation:</span>
            <span class="preview-value">{{ getOperationLabel() }}</span>
          </div>
          <div class="preview-row">
            <span class="preview-label">Batch:</span>
            <span class="preview-value">{{ selectedBatch()?.batchNumber }}</span>
          </div>
          <div class="preview-row">
            <span class="preview-label">Quantity:</span>
            <span class="preview-value">{{ formatStock(operationForm.get('quantity')?.value, product()?.unit) }}</span>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="resetOperation()"
          [disabled]="saving()">
          <span class="btn-icon">‚Ü∂</span>
          Reset
        </button>
        
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="executeOperation()"
          [disabled]="!canProceedWithOperation()"
          [class.loading]="saving()">
          <mat-spinner *ngIf="saving()" diameter="20"></mat-spinner>
          <span *ngIf="!saving()" class="btn-icon">{{ getOperationIcon() }}</span>
          <span>{{ saving() ? 'Processing...' : 'Execute Operation' }}</span>
        </button>
      </div>
    </div>

    <!-- ‚úÖ RECENT MUTATIONS: Inline History Context -->
    <div *ngIf="recentMutations().length > 0" class="workflow-section recent-mutations">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üìä</span>
          Recent Activity
        </h2>
        <p class="section-subtitle">Latest stock movements for this product</p>
      </div>

      <div class="mutations-list">
        <div 
          *ngFor="let mutation of recentMutations()"
          class="mutation-item"
          [@slideIn]>
          
          <div class="mutation-header">
            <span class="mutation-type" [class]="'type-' + (mutation.mutationType || mutation.type || 'unknown').toLowerCase()">
              {{ mutation.mutationType || mutation.type || 'Unknown' }}
            </span>
            <span class="mutation-date">{{ (mutation.mutationDate || mutation.createdAt) | date:'short' }}</span>
          </div>
          
          <div class="mutation-details">
            <span class="mutation-quantity" 
                  [class.positive]="mutation.quantityChange > 0"
                  [class.negative]="mutation.quantityChange < 0">
              {{ mutation.quantityChange > 0 ? '+' : '' }}{{ formatStock(mutation.quantityChange, product()?.unit) }}
            </span>
            <span class="mutation-notes">{{ mutation.notes }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>