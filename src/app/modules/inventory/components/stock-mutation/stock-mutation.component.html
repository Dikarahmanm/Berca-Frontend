<!-- âœ… REDESIGNED: Stock Mutation Template - Clean Simple Design (PROPER) -->
<!-- Following Toko Eniwan POS Design Guidelines: Professional, Clean, High Contrast -->

<div class="stock-mutation-container">

    <!-- Header Section -->
    <div class="mutation-header">
        <div class="header-content">
            <div class="title-section">
                <button class="back-button" (click)="goBack()">
                    <mat-icon>arrow_back</mat-icon>
                </button>
                <div class="title-content">
                    <h1 class="page-title">
                        <mat-icon class="title-icon">swap_vert</mat-icon>
                        Stock Management
                    </h1>
                    <p class="page-subtitle" *ngIf="product">{{ product.name }}</p>
                </div>
            </div>

            <div class="header-actions" *ngIf="product">
                <div class="product-info-chip">
                    <mat-icon>inventory_2</mat-icon>
                    <span>ID: {{ product.id }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading product details...</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading && product" class="main-content">

        <!-- Product Summary Card -->
        <div class="product-summary card">
            <div class="card-header">
                <h2>
                    <mat-icon>info</mat-icon>
                    Product Information
                </h2>
            </div>

            <div class="card-content">
                <div class="product-details">
                    <div class="detail-item">
                        <span class="detail-label">Product Name</span>
                        <span class="detail-value">{{ product.name }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Barcode</span>
                        <span class="detail-value">{{ product.barcode }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Category</span>
                        <span class="detail-value">{{ product.categoryName }}</span>
                    </div>
                </div>

                <div class="stock-overview">
                    <div class="stock-card current">
                        <div class="stock-icon" [style.background-color]="getStockStatusColor(product)">
                            <mat-icon>inventory</mat-icon>
                        </div>
                        <div class="stock-info">
                            <div class="stock-amount">{{ formatNumber(product.stock) }}</div>
                            <div class="stock-label">Current Stock</div>
                            <div class="stock-status">{{ currentStockStatus }}</div>
                        </div>
                    </div>

                    <div class="stock-card minimum">
                        <div class="stock-icon warning">
                            <mat-icon>warning</mat-icon>
                        </div>
                        <div class="stock-info">
                            <div class="stock-amount">{{ formatNumber(product.minimumStock) }}</div>
                            <div class="stock-label">Minimum Stock</div>
                            <div class="stock-status">Alert Level</div>
                        </div>
                    </div>

                    <div class="stock-card value">
                        <div class="stock-icon value">
                            <mat-icon>attach_money</mat-icon>
                        </div>
                        <div class="stock-info">
                            <div class="stock-amount">{{ formatCurrency(product.stock * product.buyPrice) }}</div>
                            <div class="stock-label">Stock Value</div>
                            <div class="stock-status">Current Worth</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Tabs Card -->
        <div class="content-tabs card">
            <mat-tab-group (selectedTabChange)="onTabChange($event)" class="mutation-tabs">

                <!-- Stock Update Tab -->
                <mat-tab label="Stock Update">
                    <ng-template mat-tab-label>
                        <mat-icon>add_box</mat-icon>
                        Stock Update
                    </ng-template>

                    <div class="tab-content">

                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <h3>Quick Actions</h3>
                            <div class="action-grid">
                                <button mat-stroked-button (click)="quickStockIn(10)" class="quick-btn stock-in">
                                    <mat-icon>add_circle</mat-icon>
                                    <span>+10 Stock In</span>
                                </button>

                                <button mat-stroked-button (click)="quickStockIn(50)" class="quick-btn stock-in">
                                    <mat-icon>add_circle</mat-icon>
                                    <span>+50 Stock In</span>
                                </button>

                                <button mat-stroked-button (click)="quickStockOut(5)" class="quick-btn stock-out"
                                    [disabled]="product.stock < 5">
                                    <mat-icon>remove_circle</mat-icon>
                                    <span>-5 Stock Out</span>
                                </button>

                                <button mat-stroked-button (click)="quickAdjustment()" class="quick-btn adjustment">
                                    <mat-icon>tune</mat-icon>
                                    <span>Adjustment</span>
                                </button>
                            </div>
                        </div>

                        <mat-divider class="section-divider"></mat-divider>

                        <!-- Stock Update Form -->
                        <form [formGroup]="stockForm" (ngSubmit)="onSubmitStockUpdate()" class="stock-form">

                            <div class="form-section">
                                <h3>Stock Mutation Details</h3>

                                <div class="form-grid">

                                    <!-- Mutation Type -->
                                    <mat-form-field appearance="outline">
                                        <mat-label>Mutation Type *</mat-label>
                                        <mat-select formControlName="type">
                                            <mat-option *ngFor="let type of mutationTypes" [value]="type.value">
                                                <div class="mutation-option">
                                                    <mat-icon [style.color]="type.color">{{ type.icon }}</mat-icon>
                                                    <span>{{ type.label }}</span>
                                                </div>
                                            </mat-option>
                                        </mat-select>
                                        <mat-error *ngIf="isFieldInvalid('type')">
                                            {{ getFieldError('type') }}
                                        </mat-error>
                                    </mat-form-field>

                                    <!-- Quantity -->
                                    <mat-form-field appearance="outline">
                                        <mat-label>Quantity *</mat-label>
                                        <input matInput type="number" formControlName="quantity"
                                            placeholder="Enter quantity (use - for reduction)">
                                        <mat-hint>
                                            Use positive numbers to add stock, negative numbers to reduce stock.
                                            Max reduction: {{ product.stock }}
                                        </mat-hint>
                                        <mat-error *ngIf="isFieldInvalid('quantity')">
                                            {{ getFieldError('quantity') }}
                                        </mat-error>
                                    </mat-form-field>

                                    <!-- Unit Cost (for Stock In) -->
                                    <mat-form-field appearance="outline"
                                        *ngIf="stockForm.get('type')?.value === 'StockIn'">
                                        <mat-label>Unit Cost</mat-label>
                                        <input matInput type="number" formControlName="unitCost" min="0" step="1000"
                                            placeholder="Cost per unit">
                                        <span matTextPrefix>Rp&nbsp;</span>
                                        <mat-hint>Cost from supplier</mat-hint>
                                        <mat-error *ngIf="isFieldInvalid('unitCost')">
                                            {{ getFieldError('unitCost') }}
                                        </mat-error>
                                    </mat-form-field>

                                    <!-- Reference Number -->
                                    <mat-form-field appearance="outline">
                                        <mat-label>Reference Number</mat-label>
                                        <input matInput formControlName="referenceNumber"
                                            placeholder="Invoice, PO, etc.">
                                        <mat-hint>Optional reference</mat-hint>
                                    </mat-form-field>

                                    <!-- Notes -->
                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Notes *</mat-label>
                                        <textarea matInput formControlName="notes" rows="3" maxlength="500"
                                            placeholder="Describe the reason for this mutation"></textarea>
                                        <mat-hint align="end">
                                            {{ stockForm.get('notes')?.value?.length || 0 }}/500
                                        </mat-hint>
                                        <mat-error *ngIf="isFieldInvalid('notes')">
                                            {{ getFieldError('notes') }}
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </div>

                            <!-- Preview Section -->
                            <div class="preview-section"
                                *ngIf="stockForm.valid && stockForm.get('quantity')?.value !== null && stockForm.get('quantity')?.value !== ''">
                                <div class="preview-card">
                                    <div class="preview-header">
                                        <mat-icon [style.color]="selectedMutationType.color">{{
                                            selectedMutationType.icon }}</mat-icon>
                                        <span>Mutation Preview</span>
                                    </div>

                                    <div class="preview-content">
                                        <div class="preview-grid">
                                            <div class="preview-item">
                                                <span class="preview-label">Current Stock</span>
                                                <span class="preview-value current">{{ formatNumber(product.stock)
                                                    }}</span>
                                            </div>

                                            <div class="preview-item">
                                                <span class="preview-label">Change</span>
                                                <span class="preview-value"
                                                    [style.color]="stockForm.get('quantity')?.value < 0 ? '#E15A4F' : '#4BBF7B'">
                                                    {{ stockForm.get('quantity')?.value > 0 ? '+' : '' }}{{
                                                    formatNumber(stockForm.get('quantity')?.value || 0) }}
                                                </span>
                                            </div>

                                            <div class="preview-item">
                                                <span class="preview-label">New Stock</span>
                                                <span class="preview-value new" [style.color]="getNewStockColor()">
                                                    {{ formatNumber(getNewStockPreview()) }}
                                                </span>
                                            </div>

                                            <div class="preview-item"
                                                *ngIf="stockForm.get('type')?.value === 'StockIn' && stockForm.get('unitCost')?.value > 0">
                                                <span class="preview-label">Total Cost</span>
                                                <span class="preview-value cost">{{
                                                    formatCurrency(getTotalCostPreview()) }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <button mat-stroked-button type="button" (click)="resetForm()" [disabled]="saving"
                                    class="action-btn secondary">
                                    <mat-icon>refresh</mat-icon>
                                    <span>Reset Form</span>
                                </button>

                                <button mat-raised-button color="primary" type="submit" [disabled]="!canSubmit"
                                    class="action-btn primary">
                                    <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
                                    <mat-icon *ngIf="!saving" [style.color]="selectedMutationType.color">
                                        {{ selectedMutationType.icon }}
                                    </mat-icon>
                                    <span>Update Stock</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </mat-tab>

                <!-- History Tab -->
                <mat-tab label="History">
                    <ng-template mat-tab-label>
                        <mat-icon>history</mat-icon>
                        Mutation History
                    </ng-template>

                    <div class="tab-content">

                        <!-- History Filters -->
                        <div class="history-filters">
                            <form [formGroup]="historyFilterForm" class="filter-form">
                                <mat-form-field appearance="outline">
                                    <mat-label>Start Date</mat-label>
                                    <input matInput [matDatepicker]="startPicker" formControlName="startDate"
                                        placeholder="Select start date">
                                    <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #startPicker></mat-datepicker>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>End Date</mat-label>
                                    <input matInput [matDatepicker]="endPicker" formControlName="endDate"
                                        placeholder="Select end date">
                                    <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #endPicker></mat-datepicker>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Mutation Type</mat-label>
                                    <mat-select formControlName="type">
                                        <mat-option value="">All Types</mat-option>
                                        <mat-option *ngFor="let type of mutationTypes" [value]="type.value">
                                            <div class="mutation-option">
                                                <mat-icon [style.color]="type.color">{{ type.icon }}</mat-icon>
                                                <span>{{ type.label }}</span>
                                            </div>
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </form>
                        </div>

                        <!-- History Table -->
                        <div class="history-table-container">

                            <!-- Loading State -->
                            <div *ngIf="loadingHistory" class="loading-state">
                                <mat-spinner diameter="40"></mat-spinner>
                                <p>Loading mutation history...</p>
                            </div>

                            <!-- History Table -->
                            <div *ngIf="!loadingHistory" class="table-wrapper">
                                <table mat-table [dataSource]="historyDataSource" matSort class="history-table">

                                    <!-- Date Column -->
                                    <ng-container matColumnDef="date">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
                                        <td mat-cell *matCellDef="let mutation">
                                            <div class="date-cell">
                                                {{ formatDate(mutation.createdAt) }}
                                            </div>
                                        </td>
                                    </ng-container>

                                    <!-- Type Column -->
                                    <ng-container matColumnDef="type">
                                        <th mat-header-cell *matHeaderCellDef>Type</th>
                                        <td mat-cell *matCellDef="let mutation">
                                            <mat-chip [style.background-color]="getMutationTypeColor(mutation.type)"
                                                [style.color]="'white'" class="type-chip">
                                                <mat-icon matChipAvatar>{{ getMutationTypeIcon(mutation.type)
                                                    }}</mat-icon>
                                                {{ getMutationTypeLabel(mutation.type) }}
                                            </mat-chip>
                                        </td>
                                    </ng-container>

                                    <!-- Quantity Column -->
                                    <ng-container matColumnDef="quantity">
                                        <th mat-header-cell *matHeaderCellDef>Quantity</th>
                                        <td mat-cell *matCellDef="let mutation">
                                            <div class="quantity-cell">
                                                <span [class.positive]="getActualQuantityChange(mutation) > 0"
                                                    [class.negative]="getActualQuantityChange(mutation) < 0">
                                                    {{ formatQuantityChange(mutation) }}
                                                </span>
                                            </div>
                                        </td>
                                    </ng-container>

                                    <!-- Stock Before Column -->
                                    <ng-container matColumnDef="stockBefore">
                                        <th mat-header-cell *matHeaderCellDef>Before</th>
                                        <td mat-cell *matCellDef="let mutation">
                                            {{ formatNumber(mutation.stockBefore) }}
                                        </td>
                                    </ng-container>

                                    <!-- Stock After Column -->
                                    <ng-container matColumnDef="stockAfter">
                                        <th mat-header-cell *matHeaderCellDef>After</th>
                                        <td mat-cell *matCellDef="let mutation">
                                            {{ formatNumber(mutation.stockAfter) }}
                                        </td>
                                    </ng-container>

                                    <!-- Notes Column -->
                                    <ng-container matColumnDef="notes">
                                        <th mat-header-cell *matHeaderCellDef>Notes</th>
                                        <td mat-cell *matCellDef="let mutation">
                                            <div class="notes-cell" [matTooltip]="mutation.notes">
                                                {{ mutation.notes | slice:0:50 }}{{ mutation.notes.length > 50 ? '...' :
                                                '' }}
                                            </div>
                                        </td>
                                    </ng-container>

                                    <!-- Reference Column -->
                                    <ng-container matColumnDef="reference">
                                        <th mat-header-cell *matHeaderCellDef>Reference</th>
                                        <td mat-cell *matCellDef="let mutation">
                                            <span class="reference-cell">{{ mutation.referenceNumber || '-' }}</span>
                                        </td>
                                    </ng-container>

                                    <!-- Created By Column -->
                                    <ng-container matColumnDef="createdBy">
                                        <th mat-header-cell *matHeaderCellDef>Created By</th>
                                        <td mat-cell *matCellDef="let mutation">
                                            <span class="created-by-cell">{{ mutation.createdBy || 'System' }}</span>
                                        </td>
                                    </ng-container>

                                    <!-- Header and Row Definitions -->
                                    <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
                                    <tr mat-row *matRowDef="let row; columns: historyColumns;" class="history-row"></tr>
                                </table>
                            </div>

                            <!-- Empty State -->
                            <div *ngIf="!loadingHistory && historyDataSource.data.length === 0" class="empty-state">
                                <mat-icon class="empty-icon">history</mat-icon>
                                <h3>No History Found</h3>
                                <p>No stock mutations recorded for this product yet.</p>
                            </div>

                            <!-- Pagination -->
                            <mat-paginator *ngIf="historyDataSource.data.length > 0" [pageSizeOptions]="[10, 25, 50]"
                                showFirstLastButtons class="history-paginator">
                            </mat-paginator>
                        </div>
                    </div>
                </mat-tab>
            </mat-tab-group>
        </div>
    </div>
</div>