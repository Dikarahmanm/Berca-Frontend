<!-- --- src/app/modules/inventory/stock-adjustment/stock-adjustment.component.html --- -->
<app-topbar [pageTitle]="'Penyesuaian Stok'" [username]="currentUser.username" [role]="currentUser.role">
</app-topbar>

<div class="stock-adjustment-container">
    <mat-tab-group class="adjustment-tabs" dynamicHeight>

        <!-- Adjustment Form Tab -->
        <mat-tab label="Penyesuaian Stok">
            <div class="tab-content">
                <!-- Current Stock Overview -->
                <mat-card class="current-stock-card" *ngIf="selectedProduct">
                    <mat-card-header>
                        <mat-card-title>
                            <mat-icon>inventory</mat-icon>
                            Stok Saat Ini: {{ selectedProduct.name }}
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="stock-overview">
                            <div class="stock-item">
                                <span class="label">Stok Tersedia:</span>
                                <span class="value current-stock">{{ selectedProduct.stock }} {{ selectedProduct.unit
                                    }}</span>
                            </div>
                            <div class="stock-item">
                                <span class="label">Stok Minimum:</span>
                                <span class="value min-stock">{{ selectedProduct.minStock }} {{ selectedProduct.unit
                                    }}</span>
                            </div>
                            <div class="stock-item">
                                <span class="label">Status:</span>
                                <mat-chip
                                    [class]="selectedProduct.stock <= selectedProduct.minStock ? 'status-low' : 'status-good'">
                                    {{ selectedProduct.stock <= selectedProduct.minStock ? 'Stok Menipis' : 'Stok Aman'
                                        }} </mat-chip>
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>

                <!-- Adjustment Form -->
                <mat-card class="adjustment-form-card">
                    <mat-card-header>
                        <mat-card-title>
                            <mat-icon>tune</mat-icon>
                            Form Penyesuaian Stok
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <form [formGroup]="adjustmentForm" (ngSubmit)="onSubmit()" class="adjustment-form">
                            <div class="form-section">
                                <div class="form-row">
                                    <mat-form-field appearance="outline" class="product-field">
                                        <mat-label>Pilih Produk</mat-label>
                                        <mat-select formControlName="productId" placeholder="Cari dan pilih produk">
                                            <mat-option>
                                                <input matInput [formControl]="productSearchCtrl"
                                                    placeholder="Ketik untuk mencari produk..."
                                                    (click)="$event.stopPropagation()">
                                            </mat-option>
                                            <mat-option *ngFor="let product of filteredProducts" [value]="product.id">
                                                {{ product.name }} ({{ product.sku }}) - Stok: {{ product.stock }}
                                            </mat-option>
                                        </mat-select>
                                        <mat-error *ngIf="adjustmentForm.get('productId')?.hasError('required')">
                                            Produk wajib dipilih
                                        </mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline">
                                        <mat-label>Jenis Penyesuaian</mat-label>
                                        <mat-select formControlName="adjustmentType">
                                            <mat-option value="increase">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <mat-icon>add</mat-icon>
                                                    Tambah Stok
                                                </div>
                                            </mat-option>
                                            <mat-option value="decrease">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <mat-icon>remove</mat-icon>
                                                    Kurangi Stok
                                                </div>
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>

                                <div class="form-row">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Jumlah</mat-label>
                                        <input matInput type="number" formControlName="quantity"
                                            placeholder="Masukkan jumlah" min="1">
                                        <span matSuffix *ngIf="selectedProduct">{{ selectedProduct.unit }}</span>
                                        <mat-error *ngIf="adjustmentForm.get('quantity')?.hasError('required')">
                                            Jumlah wajib diisi
                                        </mat-error>
                                        <mat-error *ngIf="adjustmentForm.get('quantity')?.hasError('min')">
                                            Jumlah minimal 1
                                        </mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline">
                                        <mat-label>Alasan</mat-label>
                                        <mat-select formControlName="reason">
                                            <mat-option *ngFor="let reason of adjustmentReasons" [value]="reason.value">
                                                {{ reason.label }}
                                            </mat-option>
                                        </mat-select>
                                        <mat-error *ngIf="adjustmentForm.get('reason')?.hasError('required')">
                                            Alasan wajib dipilih
                                        </mat-error>
                                    </mat-form-field>
                                </div>

                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Catatan Tambahan</mat-label>
                                    <textarea matInput formControlName="notes" rows="3"
                                        placeholder="Catatan tambahan (opsional)"></textarea>
                                </mat-form-field>

                                <!-- Preview -->
                                <div class="adjustment-preview"
                                    *ngIf="selectedProduct && adjustmentForm.get('quantity')?.value">
                                    <h4>Preview Penyesuaian:</h4>
                                    <div class="preview-content">
                                        <div class="preview-item">
                                            <span>Stok Sekarang:</span>
                                            <span>{{ selectedProduct.stock }} {{ selectedProduct.unit }}</span>
                                        </div>
                                        <div class="preview-item">
                                            <span>{{ adjustmentForm.get('adjustmentType')?.value === 'increase' ?
                                                'Ditambah' : 'Dikurangi' }}:</span>
                                            <span class="adjustment-amount"
                                                [class]="getAdjustmentTypeClass(adjustmentForm.get('adjustmentType')?.value)">
                                                {{ adjustmentForm.get('adjustmentType')?.value === 'increase' ? '+' :
                                                '-' }}{{ adjustmentForm.get('quantity')?.value }} {{
                                                selectedProduct.unit }}
                                            </span>
                                        </div>
                                        <div class="preview-item total">
                                            <span>Stok Setelah Penyesuaian:</span>
                                            <span class="final-stock">
                                                {{ adjustmentForm.get('adjustmentType')?.value === 'increase'
                                                ? selectedProduct.stock + (adjustmentForm.get('quantity')?.value || 0)
                                                : selectedProduct.stock - (adjustmentForm.get('quantity')?.value || 0)
                                                }} {{ selectedProduct.unit }}
                                            </span>
                                        </div>

                                        <!-- Warning untuk stok negatif -->
                                        <div class="warning-message" *ngIf="adjustmentForm.get('adjustmentType')?.value === 'decrease' && 
                                (adjustmentForm.get('quantity')?.value || 0) > selectedProduct.stock">
                                            <mat-icon>warning</mat-icon>
                                            <span>Peringatan: Stok akan menjadi negatif!</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button mat-button type="button"
                                    (click)="adjustmentForm.reset({ adjustmentType: 'increase', quantity: 1 })"
                                    [disabled]="isSubmitting">
                                    <mat-icon>refresh</mat-icon>
                                    Reset
                                </button>
                                <button mat-raised-button color="primary" type="submit"
                                    [disabled]="adjustmentForm.invalid || isSubmitting">
                                    <mat-icon *ngIf="!isSubmitting">{{ adjustmentForm.get('adjustmentType')?.value ===
                                        'increase' ? 'add' : 'remove' }}</mat-icon>
                                    <mat-icon *ngIf="isSubmitting" class="spinning">refresh</mat-icon>
                                    {{ isSubmitting ? 'Memproses...' : 'Proses Penyesuaian' }}
                                </button>
                            </div>
                        </form>
                    </mat-card-content>
                </mat-card>
            </div>
        </mat-tab>

        <!-- History Tab -->
        <mat-tab label="Riwayat Penyesuaian">
            <div class="tab-content">
                <!-- Filters -->
                <mat-card class="filters-card">
                    <mat-card-content>
                        <form [formGroup]="searchForm" class="search-form">
                            <div class="form-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>Cari Produk</mat-label>
                                    <input matInput formControlName="productSearch" placeholder="Nama produk">
                                    <mat-icon matSuffix>search</mat-icon>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Dari Tanggal</mat-label>
                                    <input matInput [matDatepicker]="fromPicker" formControlName="dateFrom">
                                    <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #fromPicker></mat-datepicker>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Sampai Tanggal</mat-label>
                                    <input matInput [matDatepicker]="toPicker" formControlName="dateTo">
                                    <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #toPicker></mat-datepicker>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Jenis</mat-label>
                                    <mat-select formControlName="adjustmentType">
                                        <mat-option value="">Semua</mat-option>
                                        <mat-option value="increase">Tambah Stok</mat-option>
                                        <mat-option value="decrease">Kurangi Stok</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <button mat-icon-button (click)="resetFilters()" matTooltip="Reset Filter">
                                    <mat-icon>refresh</mat-icon>
                                </button>
                            </div>
                        </form>
                    </mat-card-content>
                </mat-card>

                <!-- History Table -->
                <mat-card class="history-table-card">
                    <mat-card-header>
                        <mat-card-title>
                            <mat-icon>history</mat-icon>
                            Riwayat Penyesuaian Stok
                        </mat-card-title>
                        <div class="header-actions">
                            <button mat-button (click)="exportAdjustments()">
                                <mat-icon>download</mat-icon>
                                Export
                            </button>
                        </div>
                    </mat-card-header>
                    <mat-card-content>
                        <!-- Loading State -->
                        <div class="loading-container" *ngIf="isLoading">
                            <mat-spinner diameter="40"></mat-spinner>
                            <p>Memuat riwayat penyesuaian...</p>
                        </div>

                        <div class="table-container" *ngIf="!isLoading">
                            <table mat-table [dataSource]="dataSource" matSort class="history-table">
                                <!-- Date Column -->
                                <ng-container matColumnDef="date">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Tanggal</th>
                                    <td mat-cell *matCellDef="let adjustment">
                                        {{ formatDate(adjustment.createdAt) }}
                                    </td>
                                </ng-container>

                                <!-- Product Column -->
                                <ng-container matColumnDef="product">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Produk</th>
                                    <td mat-cell *matCellDef="let adjustment">
                                        {{ adjustment.productName }}
                                    </td>
                                </ng-container>

                                <!-- Type Column -->
                                <ng-container matColumnDef="type">
                                    <th mat-header-cell *matHeaderCellDef>Jenis</th>
                                    <td mat-cell *matCellDef="let adjustment">
                                        <mat-chip [class]="getAdjustmentTypeClass(adjustment.adjustmentType)">
                                            <mat-icon>{{ getAdjustmentTypeIcon(adjustment.adjustmentType) }}</mat-icon>
                                            {{ getAdjustmentTypeText(adjustment.adjustmentType) }}
                                        </mat-chip>
                                    </td>
                                </ng-container>

                                <!-- Quantity Column -->
                                <ng-container matColumnDef="quantity">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Jumlah</th>
                                    <td mat-cell *matCellDef="let adjustment">
                                        <span [class]="getAdjustmentTypeClass(adjustment.adjustmentType)">
                                            {{ adjustment.adjustmentType === 'increase' ? '+' : '-' }}{{
                                            adjustment.quantity }}
                                        </span>
                                    </td>
                                </ng-container>

                                <!-- Reason Column -->
                                <ng-container matColumnDef="reason">
                                    <th mat-header-cell *matHeaderCellDef>Alasan</th>
                                    <td mat-cell *matCellDef="let adjustment">
                                        {{ adjustment.reason }}
                                    </td>
                                </ng-container>

                                <!-- Performed By Column -->
                                <ng-container matColumnDef="performedBy">
                                    <th mat-header-cell *matHeaderCellDef>Oleh</th>
                                    <td mat-cell *matCellDef="let adjustment">
                                        {{ adjustment.performedBy }}
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                                <!-- No Data Row -->
                                <tr class="mat-row" *matNoDataRow>
                                    <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                                        <div class="no-data">
                                            <mat-icon>history</mat-icon>
                                            <h3>Belum ada riwayat penyesuaian</h3>
                                            <p>Riwayat penyesuaian stok akan muncul di sini</p>
                                        </div>
                                    </td>
                                </tr>
                            </table>

                            <mat-paginator [length]="dataSource.data.length" [pageSize]="10"
                                [pageSizeOptions]="[5, 10, 25, 50]" showFirstLastButtons>
                            </mat-paginator>
                        </div>
                    </mat-card-content>
                </mat-card>
            </div>
        </mat-tab>
    </mat-tab-group>
</div>

<style>
    /* Additional inline styles for warning message */
    .warning-message {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: rgba(231, 76, 60, 0.1);
        border: 1px solid rgba(231, 76, 60, 0.3);
        border-radius: 8px;
        color: #e74c3c;
        font-size: 14px;
        font-weight: 500;
        margin-top: 12px;
    }

    .warning-message mat-icon {
        font-size: 18px;
        width: 18px;
        height: 18px;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;

        p {
            margin-top: 16px;
            color: #7f8c8d;
            font-weight: 500;
        }
    }
</style>