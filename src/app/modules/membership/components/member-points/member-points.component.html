<!-- ✅ REDESIGNED: Member Points - Clean Simple Design -->
<div class="member-points-container">

    <!-- Enhanced Header Section -->
    <div class="points-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="page-title">
                    <mat-icon>stars</mat-icon>
                    Points Management
                </h1>
                <p class="page-subtitle" *ngIf="member">
                    {{ member.name }} • {{ member.memberNumber }}
                </p>
            </div>

            <div class="header-actions">
                <button class="btn btn-outline" (click)="navigateBack()">
                    <mat-icon>arrow_back</mat-icon>
                    Back to Members
                </button>

                <button class="btn btn-primary" (click)="viewMember()">
                    <mat-icon>visibility</mat-icon>
                    View Member
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading$ | async" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading member points data...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error$ | async as error" class="error-container">
        <mat-icon>error</mat-icon>
        <p>{{ error }}</p>
        <button class="btn btn-primary" (click)="navigateBack()">
            <mat-icon>arrow_back</mat-icon>
            Go Back
        </button>
    </div>

    <!-- Points Content -->
    <div class="points-content" *ngIf="!(loading$ | async) && !(error$ | async)">

        <!-- Member Overview Card -->
        <div class="member-overview">
            <div class="member-info">
                <div class="member-avatar">
                    <mat-icon>person</mat-icon>
                </div>

                <div class="member-details">
                    <h3>{{ member?.name || 'Loading...' }}</h3>
                    <div class="member-meta">
                        <span class="member-number">{{ member?.memberNumber || 'N/A' }}</span>
                        <div class="badge tier-badge" *ngIf="member?.tier">
                            <mat-icon>{{ getTierInfo(member?.tier).icon }}</mat-icon>
                            {{ member?.tier }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Points Summary -->
            <div class="points-summary">
                <div class="points-grid">
                    <div class="points-item current-balance">
                        <div class="points-icon">
                            <mat-icon>account_balance_wallet</mat-icon>
                        </div>
                        <div class="points-content">
                            <div class="points-label">Available Points</div>
                            <div class="points-value">{{ formatNumber(member?.availablePoints || 0) }}</div>
                        </div>
                    </div>

                    <div class="points-item total-earned">
                        <div class="points-icon">
                            <mat-icon>trending_up</mat-icon>
                        </div>
                        <div class="points-content">
                            <div class="points-label">Total Earned</div>
                            <div class="points-value">{{ formatNumber(member?.totalPoints || 0) }}</div>
                        </div>
                    </div>

                    <div class="points-item total-used">
                        <div class="points-icon">
                            <mat-icon>shopping_cart</mat-icon>
                        </div>
                        <div class="points-content">
                            <div class="points-label">Total Used</div>
                            <div class="points-value">{{ formatNumber(member?.usedPoints || 0) }}</div>
                        </div>
                    </div>

                    <div class="points-item total-spent" *ngIf="memberStats">
                        <div class="points-icon">
                            <mat-icon>account_balance_wallet</mat-icon>
                        </div>
                        <div class="points-content">
                            <div class="points-label">Total Spent</div>
                            <div class="points-value">{{ formatCurrency(memberStats.totalSpent) }}</div>
                        </div>
                    </div>
                </div>

                <!-- Tier Progress -->
                <div class="tier-progress" *ngIf="memberStats">
                    <div class="progress-header">
                        <span class="current-tier">{{ memberStats.currentTier }}</span>
                        <span class="next-tier" *ngIf="getTierProgress().nextTier !== memberStats.currentTier">
                            Next: {{ getTierProgress().nextTier }}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="getTierProgress().progress"></div>
                    </div>
                    <div class="progress-info" *ngIf="getTierProgress().required > 0">
                        <span>{{ formatCurrency(getTierProgress().required) }} more to reach {{
                            getTierProgress().nextTier }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3>
                <mat-icon>flash_on</mat-icon>
                Quick Actions
            </h3>

            <div class="action-buttons">
                <button class="btn btn-primary" (click)="fillQuickAddPoints(100, 'Purchase bonus points')">
                    <mat-icon>add_circle</mat-icon>
                    Add 100 Points
                </button>

                <button class="btn btn-primary" (click)="fillQuickAddPoints(500, 'Special promotion points')">
                    <mat-icon>star</mat-icon>
                    Add 500 Points
                </button>

                <button class="btn btn-secondary"
                    (click)="fillQuickRedeemPoints(100, 'Product discount redemption')" [disabled]="!canRedeemPoints()">
                    <mat-icon>redeem</mat-icon>
                    Redeem 100 Points
                </button>

                <button class="btn btn-secondary"
                    (click)="fillQuickRedeemPoints(member?.availablePoints || 0, 'Full points redemption')"
                    [disabled]="!canRedeemPoints()">
                    <mat-icon>remove_circle</mat-icon>
                    Redeem All
                </button>
            </div>
        </div>

        <!-- Points Management Tabs -->
        <div class="points-tabs">
            <mat-tab-group [(selectedIndex)]="selectedTab" (selectedIndexChange)="onTabChange($event)" class="points-tab-group">

                <!-- Add Points Tab -->
                <mat-tab label="Add Points">
                    <div class="tab-content">
                        <div class="tab-header">
                            <h3>
                                <mat-icon>add_circle</mat-icon>
                                Add Points to Member
                            </h3>
                            <p>Award points to member for purchases, promotions, or special events.</p>
                        </div>

                        <form [formGroup]="addPointsForm" (ngSubmit)="onAddPoints()" class="points-form">
                            <div class="form-grid">
                                <div class="form-field">
                                    <label>Points to Add *</label>
                                    <input type="number" formControlName="points" min="1" max="100000"
                                        placeholder="Enter points amount">
                                    <div class="error-message" *ngIf="isFieldInvalid(addPointsForm, 'points')">
                                        {{ getFieldError(addPointsForm, 'points') }}
                                    </div>
                                </div>

                                <div class="form-field">
                                    <label>Reference Number *</label>
                                    <div style="position: relative; display: flex; align-items: center;">
                                        <input type="text" formControlName="referenceNumber" placeholder="REF-123456" style="padding-right: 50px;">
                                        <button type="button" style="position: absolute; right: 8px; background: none; border: none; cursor: pointer; padding: 4px;"
                                            (click)="addPointsForm.patchValue({referenceNumber: generateReferenceNumber()})">
                                            <mat-icon style="font-size: 18px; color: var(--text-secondary);">refresh</mat-icon>
                                        </button>
                                    </div>
                                    <div class="error-message" *ngIf="isFieldInvalid(addPointsForm, 'referenceNumber')">
                                        {{ getFieldError(addPointsForm, 'referenceNumber') }}
                                    </div>
                                </div>

                                <div class="form-field full-width">
                                    <label>Description *</label>
                                    <textarea formControlName="description" rows="3"
                                        placeholder="Describe the reason for adding points"></textarea>
                                    <div class="error-message" *ngIf="isFieldInvalid(addPointsForm, 'description')">
                                        {{ getFieldError(addPointsForm, 'description') }}
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-outline" type="button" (click)="addPointsForm.reset()">
                                    <mat-icon>clear</mat-icon>
                                    Clear Form
                                </button>

                                <button class="btn btn-primary" type="submit"
                                    [disabled]="addPointsForm.invalid || isAddingPoints">
                                    <div class="loading-spinner" *ngIf="isAddingPoints"></div>
                                    <mat-icon *ngIf="!isAddingPoints">add_circle</mat-icon>
                                    {{ isAddingPoints ? 'Adding Points...' : 'Add Points' }}
                                </button>
                            </div>
                        </form>
                    </div>
                </mat-tab>

                <!-- Redeem Points Tab -->
                <mat-tab label="Redeem Points">
                    <div class="tab-content">
                        <div class="tab-header">
                            <h3>
                                <mat-icon>redeem</mat-icon>
                                Redeem Points
                            </h3>
                            <p>Redeem member points for discounts, products, or special offers.</p>
                            <div class="available-balance" *ngIf="(member?.availablePoints ?? 0) > 0">
                                <div class="balance-chip available">
                                    <mat-icon>account_balance_wallet</mat-icon>
                                    {{ formatNumber(member?.availablePoints || 0) }} points available
                                </div>
                            </div>
                            <div class="no-balance" *ngIf="(member?.availablePoints ?? 0) === 0">
                                <div class="balance-chip no-balance">
                                    <mat-icon>warning</mat-icon>
                                    No points available for redemption
                                </div>
                            </div>
                        </div>

                        <form [formGroup]="redeemPointsForm" (ngSubmit)="onRedeemPoints()" class="points-form">
                            <div class="form-grid">
                                <div class="form-field">
                                    <label>Points to Redeem *</label>
                                    <input type="number" formControlName="points" min="1"
                                        [max]="member?.availablePoints || 0" placeholder="Enter points amount">
                                    <small style="color: var(--text-secondary); font-size: var(--text-xs); margin-top: var(--s1); display: block;">
                                        Maximum: {{ formatNumber(member?.availablePoints || 0) }} points
                                    </small>
                                    <div class="error-message" *ngIf="isFieldInvalid(redeemPointsForm, 'points')">
                                        {{ getFieldError(redeemPointsForm, 'points') }}
                                    </div>
                                </div>

                                <div class="form-field">
                                    <label>Reference Number *</label>
                                    <div style="position: relative; display: flex; align-items: center;">
                                        <input type="text" formControlName="referenceNumber" placeholder="REF-123456" style="padding-right: 50px;"
                                            [disabled]="!canRedeemPoints()">
                                        <button type="button" style="position: absolute; right: 8px; background: none; border: none; cursor: pointer; padding: 4px;"
                                            (click)="redeemPointsForm.patchValue({referenceNumber: generateReferenceNumber()})"
                                            [disabled]="!canRedeemPoints()">
                                            <mat-icon style="font-size: 18px; color: var(--text-secondary);">refresh</mat-icon>
                                        </button>
                                    </div>
                                    <div class="error-message" *ngIf="isFieldInvalid(redeemPointsForm, 'referenceNumber')">
                                        {{ getFieldError(redeemPointsForm, 'referenceNumber') }}
                                    </div>
                                </div>

                                <div class="form-field full-width">
                                    <label>Description *</label>
                                    <textarea formControlName="description" rows="3"
                                        placeholder="Describe what the points are being redeemed for"
                                        [disabled]="!canRedeemPoints()"></textarea>
                                    <div class="error-message" *ngIf="isFieldInvalid(redeemPointsForm, 'description')">
                                        {{ getFieldError(redeemPointsForm, 'description') }}
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-outline" type="button" (click)="redeemPointsForm.reset()"
                                    [disabled]="!canRedeemPoints()">
                                    <mat-icon>clear</mat-icon>
                                    Clear Form
                                </button>

                                <button class="btn btn-secondary" type="submit"
                                    [disabled]="redeemPointsForm.invalid || isRedeemingPoints || !canRedeemPoints()">
                                    <div class="loading-spinner" *ngIf="isRedeemingPoints"></div>
                                    <mat-icon *ngIf="!isRedeemingPoints">redeem</mat-icon>
                                    {{ isRedeemingPoints ? 'Redeeming Points...' : 'Redeem Points' }}
                                </button>
                            </div>
                        </form>
                    </div>
                </mat-tab>

                <!-- Points History Tab -->
                <mat-tab label="Points History">
                    <div class="tab-content">
                        <div class="tab-header">
                            <h3>
                                <mat-icon>history</mat-icon>
                                Points Transaction History
                            </h3>
                            <p>Complete history of all points transactions for this member.</p>
                        </div>

                        <!-- History Table -->
                        <div class="history-table-container">
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Points</th>
                                        <th>Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let transaction of historyDataSource; trackBy: trackByTransaction" class="history-row">
                                        <td>
                                            <div class="date-cell">
                                                <div class="date">{{ formatDate(transaction.createdAt) }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="badge" 
                                                [class.tier-badge]="isEarningTransaction(transaction.transactionType)"
                                                [style.background]="isEarningTransaction(transaction.transactionType) ? 'var(--primary-light)' : '#fef2f2'"
                                                [style.border-color]="isEarningTransaction(transaction.transactionType) ? 'var(--success)' : 'var(--error)'"
                                                [style.color]="isEarningTransaction(transaction.transactionType) ? 'var(--success)' : 'var(--error)'">
                                                <mat-icon>{{ getPointsTypeIcon(transaction.transactionType) }}</mat-icon>
                                                {{ transaction.transactionType }}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="description-cell">
                                                <div class="description">{{ transaction.description }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="points-cell">
                                                <span [class]="isEarningTransaction(transaction.transactionType) ? 'points-positive' : 'points-negative'">
                                                    {{ getPointsDisplayValue(transaction.pointsDelta, isEarningTransaction(transaction.transactionType)) }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="reference-cell">
                                                <code class="reference-number">{{ transaction.referenceNumber || 'N/A' }}</code>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Empty State -->
                            <div *ngIf="historyDataSource.length === 0" class="empty-history">
                                <mat-icon class="empty-icon">history</mat-icon>
                                <h4>No Points History</h4>
                                <p>This member hasn't had any points transactions yet.</p>
                            </div>

                            <!-- Simple Pagination -->
                            <div class="pagination-container" *ngIf="historyDataSource.length > 0">
                                <mat-paginator [length]="totalItems" [pageSize]="pageSize" [pageIndex]="currentPage - 1"
                                    [pageSizeOptions]="[10, 20, 50]" (page)="onPageChange($event)" showFirstLastButtons>
                                </mat-paginator>
                            </div>
                        </div>
                    </div>
                </mat-tab>

            </mat-tab-group>
        </div>
    </div>

</div>

<!-- Track by function for performance -->
<ng-template>
  <!-- This template is for trackBy functions only -->
</ng-template>