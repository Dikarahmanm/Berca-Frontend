<!-- membership-analytics.component.html -->
<!-- Clean Simple Analytics Design - Compatible with TypeScript Component -->
<div class="analytics-container">

    <!-- Header Section with Real-time Status -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <span class="title-icon">üìä</span>
                Membership Analytics
                <span class="realtime-indicator" [class.active]="realtimeConnected()">
                    <span class="indicator-dot"></span>
                    {{ realtimeConnected() ? 'Live' : 'Offline' }}
                </span>
            </h1>
            <p class="page-subtitle">
                Comprehensive insights into membership performance and growth
            </p>
        </div>

        <!-- Date Range Controls -->
        <div class="date-controls card">
            <form [formGroup]="dateRangeForm" class="date-form">
                <div class="form-field">
                    <label class="field-label">Period</label>
                    <div class="select-wrapper">
                        <select class="form-control" formControlName="preset" (change)="onPresetChange($event)">
                            <option value="last7Days">Last 7 Days</option>
                            <option value="last30Days">Last 30 Days</option>
                            <option value="thisMonth">This Month</option>
                            <option value="thisYear">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <span class="select-icon">‚ñº</span>
                    </div>
                </div>

                <div class="form-field">
                    <label class="field-label">Start Date</label>
                    <div class="input-wrapper">
                        <input type="date" class="form-control" formControlName="startDate">
                        <span class="field-icon">üìÖ</span>
                    </div>
                </div>

                <div class="form-field">
                    <label class="field-label">End Date</label>
                    <div class="input-wrapper">
                        <input type="date" class="form-control" formControlName="endDate">
                        <span class="field-icon">üìÖ</span>
                    </div>
                </div>

                <button class="btn btn-primary" (click)="exportAnalytics()">
                    <span class="btn-icon">üíæ</span>
                    Export
                </button>
            </form>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading$()" class="loading-container">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading analytics data...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error$() as error" class="error-container card">
        <div class="error-content">
            <span class="error-icon">‚ö†Ô∏è</span>
            <div class="error-message">
                <h3>Oops! Something went wrong</h3>
                <p>{{ error }}</p>
            </div>
            <button class="btn btn-primary" (click)="loadAnalyticsData()">
                <span class="btn-icon">üîÑ</span>
                Retry
            </button>
        </div>
    </div>

    <!-- Analytics Content -->
    <div class="content-section" *ngIf="!loading$() && !error$() && membershipKPIs">

        <!-- KPI Summary Cards -->
        <div class="kpi-summary">
            <div class="kpi-header">
                <h3 class="kpi-title">
                    <span class="kpi-icon">üìà</span>
                    Key Performance Indicators
                </h3>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card card">
                    <div class="kpi-header-content">
                        <span class="kpi-card-icon">üë•</span>
                        <div class="kpi-trend" [class]="getGrowthTrendClass()">
                            <span class="trend-icon">{{ getGrowthIcon() }}</span>
                            <span class="trend-value">{{ formatPercentage(getGrowthTrend().percentage) }}</span>
                        </div>
                    </div>
                    <div class="kpi-content">
                        <h3>Total Members</h3>
                        <div class="kpi-value">{{ formatNumber(membershipKPIs.totalMembers) }}</div>
                        <div class="kpi-detail">{{ formatNumber(membershipKPIs.activeMembers) }} active members</div>
                    </div>
                </div>

                <div class="kpi-card card">
                    <div class="kpi-header-content">
                        <span class="kpi-card-icon">‚ú®</span>
                        <div class="kpi-badge">
                            <span class="badge badge-primary">New</span>
                        </div>
                    </div>
                    <div class="kpi-content">
                        <h3>New Members</h3>
                        <div class="kpi-value">{{ formatNumber(membershipKPIs.newMembersThisMonth) }}</div>
                        <div class="kpi-detail">This month</div>
                    </div>
                </div>

                <div class="kpi-card card">
                    <div class="kpi-header-content">
                        <span class="kpi-card-icon">üí∞</span>
                    </div>
                    <div class="kpi-content">
                        <h3>Avg. Spending</h3>
                        <div class="kpi-value">{{ formatCurrency(membershipKPIs.averageSpendingPerMember) }}</div>
                        <div class="kpi-detail">Per member</div>
                    </div>
                </div>

                <div class="kpi-card card">
                    <div class="kpi-header-content">
                        <span class="kpi-card-icon">‚≠ê</span>
                    </div>
                    <div class="kpi-content">
                        <h3>Points Activity</h3>
                        <div class="kpi-value">{{ formatNumber(membershipKPIs.totalPointsAwarded) }}</div>
                        <div class="kpi-detail">{{ formatNumber(membershipKPIs.totalPointsRedeemed) }} redeemed</div>
                    </div>
                </div>

                <div class="kpi-card card featured">
                    <div class="kpi-header-content">
                        <span class="kpi-card-icon" [attr.data-tier]="membershipKPIs.topTier.toLowerCase()">
                            {{ getTierIcon(membershipKPIs.topTier) }}
                        </span>
                    </div>
                    <div class="kpi-content">
                        <h3>Top Tier</h3>
                        <div class="kpi-value">{{ membershipKPIs.topTier }}</div>
                        <div class="kpi-detail">Most common tier</div>
                    </div>
                </div>

                <div class="kpi-card card">
                    <div class="kpi-header-content">
                        <span class="kpi-card-icon">üìä</span>
                    </div>
                    <div class="kpi-content">
                        <h3>Growth Rate</h3>
                        <div class="kpi-value">{{ formatPercentage(membershipKPIs.membershipGrowthRate) }}</div>
                        <div class="kpi-detail">This period</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section card" *ngIf="generateInsights().length > 0">
            <div class="insights-header">
                <h3 class="insights-title">
                    <span class="insights-icon">üí°</span>
                    Key Insights
                </h3>
            </div>
            <div class="insights-list">
                <div class="insight-item" *ngFor="let insight of generateInsights(); trackBy: trackByInsight">
                    <span class="insight-bullet">‚Ä¢</span>
                    <span class="insight-text">{{ insight }}</span>
                </div>
            </div>
        </div>

        <!-- Analytics Charts -->
        <div class="analytics-charts">
            <div class="charts-header">
                <h3 class="charts-title">
                    <span class="charts-icon">üìà</span>
                    Analytics Charts
                </h3>
            </div>
            
            <div class="charts-container">
                <!-- Tier Distribution Chart -->
                <div class="chart-section card">
                    <div class="chart-header">
                        <h4 class="chart-title">
                            <span class="chart-icon">ü•á</span>
                            Member Tier Distribution
                        </h4>
                        <p class="chart-subtitle">Distribution of members across different tiers</p>
                    </div>

                    <div class="chart-content">
                        <div class="chart-wrapper">
                            <ngx-charts-pie-chart 
                                [results]="getTierChartData()" 
                                [view]="getChartSize()"
                                [scheme]="colorScheme" 
                                [legend]="false" 
                                [labels]="true" 
                                [doughnut]="true"
                                [gradient]="false" 
                                [tooltipDisabled]="false" 
                                (select)="onChartSelect($event)"
                                (activate)="onChartActivate($event)" 
                                (deactivate)="onChartDeactivate($event)">
                            </ngx-charts-pie-chart>
                        </div>

                        <div class="tier-stats">
                            <div class="tier-stat" *ngFor="let tier of tierDistribution; trackBy: trackByTier">
                                <div class="tier-color" [style.background-color]="tier.color"></div>
                                <div class="tier-info">
                                    <div class="tier-name">{{ tier.tier }}</div>
                                    <div class="tier-numbers">
                                        {{ formatNumber(tier.count) }} members ({{ formatPercentage(tier.percentage) }})
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Member Growth Chart -->
                <div class="chart-section card">
                    <div class="chart-header">
                        <h4 class="chart-title">
                            <span class="chart-icon">üìà</span>
                            Member Growth Trend
                        </h4>
                        <p class="chart-subtitle">Monthly new member acquisitions over the past year</p>
                    </div>

                    <div class="chart-content">
                        <div class="chart-wrapper">
                            <ngx-charts-line-chart 
                                [results]="[{name: 'New Members', series: getGrowthChartData()}]"
                                [view]="getChartSize()" 
                                [scheme]="colorScheme" 
                                [legend]="false"
                                [showXAxisLabel]="false" 
                                [showYAxisLabel]="false" 
                                [xAxis]="true"
                                [yAxis]="true" 
                                [gradient]="false" 
                                [curve]="'cardinalClosed'" 
                                [tooltipDisabled]="false"
                                (select)="onChartSelect($event)">
                            </ngx-charts-line-chart>
                        </div>
                    </div>
                </div>

                <!-- Spending Analysis Chart -->
                <div class="chart-section card">
                    <div class="chart-header">
                        <h4 class="chart-title">
                            <span class="chart-icon">üí≥</span>
                            Member Spending Segments
                        </h4>
                        <p class="chart-subtitle">Distribution of members by spending behavior</p>
                    </div>

                    <div class="chart-content">
                        <div class="chart-wrapper">
                            <ngx-charts-bar-vertical 
                                [results]="getSpendingChartData()" 
                                [view]="getChartSize()"
                                [scheme]="colorScheme" 
                                [legend]="false" 
                                [showXAxisLabel]="false"
                                [showYAxisLabel]="false" 
                                [xAxis]="true" 
                                [yAxis]="true"
                                [gradient]="false"
                                [tooltipDisabled]="false" 
                                (select)="onChartSelect($event)">
                            </ngx-charts-bar-vertical>
                        </div>
                    </div>
                </div>

                <!-- Points Analysis Chart -->
                <div class="chart-section card">
                    <div class="chart-header">
                        <h4 class="chart-title">
                            <span class="chart-icon">‚≠ê</span>
                            Points Usage Analysis
                        </h4>
                        <p class="chart-subtitle">Breakdown of points earned, redeemed, and available</p>
                    </div>

                    <div class="chart-content">
                        <div class="chart-wrapper">
                            <ngx-charts-pie-chart 
                                [results]="getPointsChartData()" 
                                [view]="getChartSize()"
                                [scheme]="colorScheme" 
                                [legend]="false" 
                                [labels]="true" 
                                [doughnut]="false"
                                [gradient]="false" 
                                [tooltipDisabled]="false" 
                                (select)="onChartSelect($event)">
                            </ngx-charts-pie-chart>
                        </div>

                        <div class="points-summary-stats">
                            <div class="points-stat">
                                <div class="stat-label">Redemption Rate</div>
                                <div class="stat-value">
                                    {{ formatPercentage((membershipKPIs.totalPointsRedeemed / membershipKPIs.totalPointsAwarded) * 100) }}
                                </div>
                            </div>

                            <div class="points-stat">
                                <div class="stat-label">Available Points</div>
                                <div class="stat-value">
                                    {{ formatNumber(membershipKPIs.totalPointsAwarded - membershipKPIs.totalPointsRedeemed) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Members Section -->
        <div class="top-members-section card">
            <div class="section-header">
                <h3 class="section-title">
                    <span class="section-icon">üèÜ</span>
                    Top Performing Members
                </h3>
                <p class="section-subtitle">Highest spending members in the selected period</p>
            </div>

            <div class="top-members-list" *ngIf="topMembers.length > 0">
                <div class="member-item" *ngFor="let member of topMembers; let i = index; trackBy: trackByMember"
                    (click)="navigateToMemberDetail(member)">
                    <div class="member-rank">
                        <div class="rank-number">{{ i + 1 }}</div>
                        <span class="rank-icon" *ngIf="i < 3" [class]="'rank-' + (i + 1)">
                            {{ i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â' }}
                        </span>
                    </div>

                    <div class="member-info">
                        <div class="member-name">{{ member.memberName }}</div>
                        <div class="member-number">{{ member.memberNumber }}</div>
                    </div>

                    <div class="member-stats">
                        <div class="stat-item">
                            <div class="stat-label">Total Spent</div>
                            <div class="stat-value">{{ formatCurrency(member.totalSpent) }}</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">Transactions</div>
                            <div class="stat-value">{{ formatNumber(member.transactionCount) }}</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">Avg. Transaction</div>
                            <div class="stat-value">{{ formatCurrency(member.averageTransaction) }}</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">Last Order</div>
                            <div class="stat-value">{{ formatDate(member.lastTransactionDate) }}</div>
                        </div>
                    </div>

                    <div class="member-actions">
                        <span class="action-icon">‚Ä∫</span>
                    </div>
                </div>
            </div>

            <div class="empty-members" *ngIf="topMembers.length === 0">
                <span class="empty-icon">üë•</span>
                <h4>No Member Data</h4>
                <p>No member transactions found for the selected period.</p>
            </div>
        </div>

    </div>

</div>

<!-- Real-time Update Toast Notifications -->
<div class="toast-container">
    <div class="toast" *ngFor="let toast of realtimeToasts(); trackBy: trackByToast" [class]="'toast-' + toast.type">
        <div class="toast-content">
            <span class="toast-icon">{{ getToastIcon(toast.type) }}</span>
            <div class="toast-message">
                <div class="toast-title">{{ toast.title }}</div>
                <div class="toast-text">{{ toast.message }}</div>
            </div>
        </div>
        <button class="toast-close" (click)="dismissToast(toast.id)">√ó</button>
    </div>
</div>