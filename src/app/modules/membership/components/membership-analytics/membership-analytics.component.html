<!-- src/app/modules/membership/components/membership-analytics/membership-analytics.component.html -->
<div class="membership-analytics">

    <!-- Header Section -->
    <div class="analytics-header">
        <div class="header-content">
            <h1 class="page-title">
                <mat-icon>analytics</mat-icon>
                Membership Analytics
            </h1>
            <p class="page-subtitle">
                Analisis mendalam performa membership dan loyalty program
            </p>
        </div>

        <!-- Date Range Controls -->
        <div class="date-controls glass-card">
            <form [formGroup]="dateRangeForm" class="date-form">
                <mat-form-field appearance="outline" class="preset-field">
                    <mat-label>Periode</mat-label>
                    <mat-select formControlName="preset" (selectionChange)="onPresetChange($event.value)">
                        <mat-option value="last7Days">7 Hari Terakhir</mat-option>
                        <mat-option value="last30Days">30 Hari Terakhir</mat-option>
                        <mat-option value="thisMonth">Bulan Ini</mat-option>
                        <mat-option value="thisYear">Tahun Ini</mat-option>
                        <mat-option value="custom">Custom</mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Tanggal Mulai</mat-label>
                    <input matInput [matDatepicker]="startPicker" formControlName="startDate">
                    <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                    <mat-datepicker #startPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Tanggal Selesai</mat-label>
                    <input matInput [matDatepicker]="endPicker" formControlName="endDate">
                    <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                    <mat-datepicker #endPicker></mat-datepicker>
                </mat-form-field>

                <button mat-raised-button color="primary" (click)="exportAnalytics()">
                    <mat-icon>download</mat-icon>
                    Export
                </button>
            </form>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading analytics data...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-container glass-card">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error }}</p>
        <button mat-raised-button color="primary" (click)="loadAnalyticsData()">
            <mat-icon>refresh</mat-icon>
            Retry
        </button>
    </div>

    <!-- Analytics Content -->
    <div class="analytics-content" *ngIf="!loading && !error && membershipKPIs">

        <!-- KPI Summary Cards -->
        <div class="kpi-summary">
            <div class="kpi-grid">
                <div class="kpi-card glass-card">
                    <div class="kpi-header">
                        <mat-icon>people</mat-icon>
                        <div class="kpi-trend">
                            <mat-icon [style.color]="getGrowthColor()">{{ getGrowthIcon() }}</mat-icon>
                            <span [style.color]="getGrowthColor()">{{ formatPercentage(getGrowthTrend().percentage)
                                }}</span>
                        </div>
                    </div>
                    <div class="kpi-content">
                        <h3>Total Members</h3>
                        <div class="kpi-value">{{ formatNumber(membershipKPIs.totalMembers) }}</div>
                        <div class="kpi-detail">{{ formatNumber(membershipKPIs.activeMembers) }} active members</div>
                    </div>
                </div>

                <div class="kpi-card glass-card">
                    <div class="kpi-header">
                        <mat-icon>person_add</mat-icon>
                        <div class="kpi-badge">
                            <mat-chip color="primary">New</mat-chip>
                        </div>
                    </div>
                    <div class="kpi-content">
                        <h3>New Members</h3>
                        <div class="kpi-value">{{ formatNumber(membershipKPIs.newMembersThisMonth) }}</div>
                        <div class="kpi-detail">This month</div>
                    </div>
                </div>

                <div class="kpi-card glass-card">
                    <div class="kpi-header">
                        <mat-icon>account_balance_wallet</mat-icon>
                    </div>
                    <div class="kpi-content">
                        <h3>Avg. Spending</h3>
                        <div class="kpi-value">{{ formatCurrency(membershipKPIs.averageSpendingPerMember) }}</div>
                        <div class="kpi-detail">Per member</div>
                    </div>
                </div>

                <div class="kpi-card glass-card">
                    <div class="kpi-header">
                        <mat-icon>stars</mat-icon>
                    </div>
                    <div class="kpi-content">
                        <h3>Points Activity</h3>
                        <div class="kpi-value">{{ formatNumber(membershipKPIs.totalPointsAwarded) }}</div>
                        <div class="kpi-detail">{{ formatNumber(membershipKPIs.totalPointsRedeemed) }} redeemed</div>
                    </div>
                </div>

                <div class="kpi-card glass-card featured">
                    <div class="kpi-header">
                        <mat-icon [style.color]="getTierInfo(membershipKPIs.topTier).color">
                            {{ getTierInfo(membershipKPIs.topTier).icon }}
                        </mat-icon>
                    </div>
                    <div class="kpi-content">
                        <h3>Top Tier</h3>
                        <div class="kpi-value">{{ membershipKPIs.topTier }}</div>
                        <div class="kpi-detail">Most common tier</div>
                    </div>
                </div>

                <div class="kpi-card glass-card">
                    <div class="kpi-header">
                        <mat-icon>trending_up</mat-icon>
                    </div>
                    <div class="kpi-content">
                        <h3>Growth Rate</h3>
                        <div class="kpi-value">{{ formatPercentage(membershipKPIs.membershipGrowthRate) }}</div>
                        <div class="kpi-detail">This period</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section glass-card" *ngIf="generateInsights().length > 0">
            <div class="insights-header">
                <h3>
                    <mat-icon>lightbulb</mat-icon>
                    Key Insights
                </h3>
            </div>
            <div class="insights-list">
                <div class="insight-item" *ngFor="let insight of generateInsights()">
                    <mat-icon>arrow_right</mat-icon>
                    <span>{{ insight }}</span>
                </div>
            </div>
        </div>

        <!-- Analytics Charts -->
        <div class="analytics-charts">
            <mat-tab-group [(selectedIndex)]="selectedTab" class="charts-tab-group">

                <!-- Tier Distribution Tab -->
                <mat-tab label="Tier Distribution">
                    <div class="chart-container glass-card">
                        <div class="chart-header">
                            <h3>
                                <mat-icon>donut_large</mat-icon>
                                Member Tier Distribution
                            </h3>
                            <p>Distribution of members across different tiers</p>
                        </div>

                        <div class="chart-content">
                            <div class="chart-wrapper">
                                <ngx-charts-pie-chart [results]="getTierChartData()" [view]="[700, 400]"
                                    [scheme]="colorScheme" [legend]="showLegend" [labels]="true" [doughnut]="true"
                                    [gradient]="gradient" [tooltipDisabled]="false" (select)="onChartSelect($event)"
                                    (activate)="onChartActivate($event)" (deactivate)="onChartDeactivate($event)">
                                </ngx-charts-pie-chart>
                            </div>

                            <div class="tier-stats">
                                <div class="tier-stat" *ngFor="let tier of tierDistribution">
                                    <div class="tier-color" [style.background-color]="tier.color"></div>
                                    <div class="tier-info">
                                        <div class="tier-name">{{ tier.tier }}</div>
                                        <div class="tier-numbers">
                                            {{ formatNumber(tier.count) }} members ({{ formatPercentage(tier.percentage)
                                            }})
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mat-tab>

                <!-- Member Growth Tab -->
                <mat-tab label="Member Growth">
                    <div class="chart-container glass-card">
                        <div class="chart-header">
                            <h3>
                                <mat-icon>show_chart</mat-icon>
                                Member Growth Trend
                            </h3>
                            <p>Monthly new member acquisitions over the past year</p>
                        </div>

                        <div class="chart-content">
                            <ngx-charts-line-chart [results]="[{name: 'New Members', series: getGrowthChartData()}]"
                                [view]="[700, 400]" [scheme]="colorScheme" [legend]="false"
                                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel" [xAxis]="showXAxis"
                                [yAxis]="showYAxis" [xAxisLabel]="'Month'" [yAxisLabel]="'New Members'"
                                [gradient]="gradient" [curve]="'cardinal'" [tooltipDisabled]="false"
                                (select)="onChartSelect($event)">
                            </ngx-charts-line-chart>
                        </div>
                    </div>
                </mat-tab>

                <!-- Spending Analysis Tab -->
                <mat-tab label="Spending Analysis">
                    <div class="chart-container glass-card">
                        <div class="chart-header">
                            <h3>
                                <mat-icon>account_balance</mat-icon>
                                Member Spending Segments
                            </h3>
                            <p>Distribution of members by spending behavior</p>
                        </div>

                        <div class="chart-content">
                            <ngx-charts-bar-vertical [results]="getSpendingChartData()" [view]="[700, 400]"
                                [scheme]="colorScheme" [legend]="false" [showXAxisLabel]="showXAxisLabel"
                                [showYAxisLabel]="showYAxisLabel" [xAxis]="showXAxis" [yAxis]="showYAxis"
                                [xAxisLabel]="'Spending Segments'" [yAxisLabel]="'Percentage'" [gradient]="gradient"
                                [tooltipDisabled]="false" (select)="onChartSelect($event)">
                            </ngx-charts-bar-vertical>
                        </div>
                    </div>
                </mat-tab>

                <!-- Points Analysis Tab -->
                <mat-tab label="Points Analysis">
                    <div class="chart-container glass-card">
                        <div class="chart-header">
                            <h3>
                                <mat-icon>stars</mat-icon>
                                Points Usage Analysis
                            </h3>
                            <p>Breakdown of points earned, redeemed, and available</p>
                        </div>

                        <div class="chart-content">
                            <div class="chart-wrapper">
                                <ngx-charts-pie-chart [results]="getPointsChartData()" [view]="[700, 400]"
                                    [scheme]="colorScheme" [legend]="showLegend" [labels]="true" [doughnut]="false"
                                    [gradient]="gradient" [tooltipDisabled]="false" (select)="onChartSelect($event)">
                                </ngx-charts-pie-chart>
                            </div>

                            <div class="points-summary-stats">
                                <div class="points-stat">
                                    <div class="stat-label">Redemption Rate</div>
                                    <div class="stat-value">
                                        {{ formatPercentage((membershipKPIs.totalPointsRedeemed /
                                        membershipKPIs.totalPointsAwarded) * 100) }}
                                    </div>
                                </div>

                                <div class="points-stat">
                                    <div class="stat-label">Available Points</div>
                                    <div class="stat-value">
                                        {{ formatNumber(membershipKPIs.totalPointsAwarded -
                                        membershipKPIs.totalPointsRedeemed) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </mat-tab>

            </mat-tab-group>
        </div>

        <!-- Top Members Section -->
        <div class="top-members-section glass-card">
            <div class="section-header">
                <h3>
                    <mat-icon>star</mat-icon>
                    Top Performing Members
                </h3>
                <p>Highest spending members in the selected period</p>
            </div>

            <div class="top-members-list" *ngIf="topMembers.length > 0">
                <div class="member-item" *ngFor="let member of topMembers; let i = index"
                    (click)="navigateToMemberDetail(member)">
                    <div class="member-rank">
                        <div class="rank-number">{{ i + 1 }}</div>
                        <mat-icon *ngIf="i < 3" class="rank-icon" [class]="'rank-' + (i + 1)">
                            {{ i === 0 ? 'emoji_events' : i === 1 ? 'military_tech' : 'workspace_premium' }}
                        </mat-icon>
                    </div>

                    <div class="member-info">
                        <div class="member-name">{{ member.memberName }}</div>
                        <div class="member-number">{{ member.memberNumber }}</div>
                    </div>

                    <div class="member-stats">
                        <div class="stat-item">
                            <div class="stat-label">Total Spent</div>
                            <div class="stat-value">{{ formatCurrency(member.totalSpent) }}</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">Transactions</div>
                            <div class="stat-value">{{ formatNumber(member.transactionCount) }}</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">Avg. Transaction</div>
                            <div class="stat-value">{{ formatCurrency(member.averageTransaction) }}</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">Last Order</div>
                            <div class="stat-value">{{ formatDate(member.lastTransactionDate) }}</div>
                        </div>
                    </div>

                    <div class="member-actions">
                        <mat-icon>chevron_right</mat-icon>
                    </div>
                </div>
            </div>

            <div class="empty-members" *ngIf="topMembers.length === 0">
                <mat-icon class="empty-icon">people_outline</mat-icon>
                <h4>No Member Data</h4>
                <p>No member transactions found for the selected period.</p>
            </div>
        </div>

    </div>

</div>