<!-- src/app/modules/pos/barcode-tools/barcode-tools.component.html -->
<div class="barcode-scanner">
    <!-- Header -->
    <div class="scanner-header">
        <h2 class="scanner-title">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M3 5v4h2V7h2V5H3zm2 10H3v4h4v-2H5v-2zm14 4h-4v2h6v-4h-2v2zm0-16h-2v2h2v2h2V5h-2V3zM6 17h1.5v-6H6v6zm3.5 0H11v-6H9.5v6zm2.5 0h1.5v-6H12v6zm3.5 0H17v-6h-1.5v6z" />
            </svg>
            Scanner Barcode
        </h2>

        <button class="close-btn" (click)="closeBarcodeScanner()" title="Tutup Scanner">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 
                         10.59 12 5 17.59 6.41 19 12 13.41 
                         17.59 19 19 17.59 13.41 12z" />
            </svg>
        </button>
    </div>

    <!-- Camera Section -->
    <div class="camera-section">
        <!-- Camera Container -->
        <div class="camera-container" *ngIf="isCameraActive">
            <!-- Scanner Target -->
            <div id="barcode-scanner" class="scanner-target"></div>

            <!-- Scanning Overlay -->
            <div class="scanning-overlay">
                <div class="scan-frame">
                    <div class="scan-corners">
                        <div class="corner top-left"></div>
                        <div class="corner top-right"></div>
                        <div class="corner bottom-left"></div>
                        <div class="corner bottom-right"></div>
                    </div>
                    <div class="scan-line" [class.active]="isScanning"></div>
                </div>
                <p class="scan-instruction">Arahkan barcode ke dalam frame</p>
            </div>
        </div>

        <!-- Error Message -->
        <div class="camera-error" *ngIf="errorMessage && !isCameraActive">
            <svg class="error-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 
                         2 12s4.48 10 10 10 
                         10-4.48 10-10S17.52 2 12 2zm-2 
                         15l-5-5 1.41-1.41L10 
                         14.17l7.59-7.59L19 
                         8l-9 9z" />
            </svg>
            <p>{{errorMessage}}</p>
            <button class="retry-btn" (click)="startCamera()">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 
                             12 4c-4.42 0-7.99 3.58-7.99 
                             8s3.57 8 7.99 8c3.73 0 6.84-2.55 
                             7.73-6h-2.08c-.82 2.33-3.04 4-5.65 
                             4-3.31 0-6-2.69-6-6s2.69-6 
                             6-6c1.66 0 3.14.69 4.22 
                             1.78L13 11h7V4l-2.35 2.35z" />
                </svg>
                Coba Lagi
            </button>
        </div>

        <!-- Camera Not Available -->
        <div class="camera-placeholder" *ngIf="!isCameraActive && !errorMessage && !isRetrying">
            <svg class="placeholder-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M4,4H7L9,2H15L17,4H20A2,2 
                         0 0,1 22,6V18A2,2 0 0,1 
                         20,20H4A2,2 0 0,1 
                         2,18V6A2,2 0 0,1 4,4M12,7A5,5 
                         0 0,0 7,12A5,5 0 0,0 12,17A5,5 
                         0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 
                         0 0,1 15,12A3,3 0 0,1 12,15A3,3 
                         0 0,1 9,12A3,3 0 0,1 12,9Z" />
            </svg>
            <p>Mengakses kamera...</p>
            <button class="activate-btn" (click)="startCamera()">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z" />
                </svg>
                Aktifkan Kamera
            </button>
        </div>

        <!-- Loading/Retry State -->
        <div class="camera-placeholder" *ngIf="isRetrying">
            <div class="spinner-ring"></div>
            <p>Memuat scanner...</p>
            <small>Menunggu elemen scanner siap</small>
        </div>
    </div>

    <!-- Controls -->
    <div class="scanner-controls">
        <div class="control-buttons">
            <button class="primary-button" (click)="toggleScanning()" [disabled]="!isCameraActive"
                [class.scanning]="isScanning">
                <svg class="icon" *ngIf="!isScanning" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z" />
                </svg>
                <svg class="icon" *ngIf="isScanning" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                </svg>
                {{isScanning ? 'Stop Scanning' : 'Start Scanning'}}
            </button>

            <button class="secondary-button" (click)="focusManualInput()">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 
                             9.94l-3.75-3.75L3 
                             17.25zM20.71 7.04c.39-.39.39-1.02 
                             0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 
                             0l-1.83 1.83 3.75 3.75 
                             1.83-1.83z" />
                </svg>
                Manual Entry
            </button>
        </div>

        <!-- Manual Input -->
        <div class="manual-input-section">
            <div class="input-group">
                <label for="manualBarcode">Enter Barcode or Product Name:</label>
                <div class="input-wrapper">
                    <input #manualInput id="manualBarcode" type="text" [(ngModel)]="manualBarcode"
                        (keypress)="onManualKeyPress($event)" (input)="onBarcodeInput($event)"
                        (focus)="showSuggestions = true" (blur)="onInputBlur()"
                        placeholder="Type barcode or product name..." class="manual-input">

                    <button class="submit-btn" (click)="onManualSubmit()" [disabled]="!manualBarcode.trim()"
                        title="Search Product">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 
                                     12.59 16 11.11 16 9.5 16 5.91 
                                     13.09 3 9.5 3S3 5.91 3 
                                     9.5 5.91 16 9.5 16c1.61 0 
                                     3.09-.59 4.23-1.57l.27.28v.79l5 
                                     4.99L20.49 19l-4.99-5zm-6 
                                     0C7.01 14 5 11.99 5 
                                     9.5S7.01 5 9.5 5 14 7.01 
                                     14 9.5 11.99 14 9.5 14z" />
                        </svg>
                    </button>
                </div>

                <!-- Product Suggestions -->
                <div class="product-suggestions" *ngIf="showSuggestions && filteredProducts.length > 0">
                    <div class="suggestion-item" *ngFor="let product of filteredProducts"
                        (mousedown)="selectProduct(product)" [title]="'Stock: ' + product.stock">
                        <div class="suggestion-info">
                            <div class="product-name">{{product.name}}</div>
                            <div class="product-details">
                                <span class="barcode">{{product.barcode}}</span>
                                <span class="price">{{formatPrice(product.sellPrice)}}</span>
                                <span class="category" *ngIf="product.categoryName">{{product.categoryName}}</span>
                                <span class="stock" [class.low-stock]="product.stock < product.minStock">
                                    Stock: {{product.stock}}
                                </span>
                            </div>
                        </div>
                        <div class="suggestion-action">Select</div>
                    </div>
                </div>

                <!-- Loading state -->
                <div class="product-suggestions" *ngIf="isLoading && manualBarcode.length > 2">
                    <div class="loading-item">
                        <div class="loading-spinner"></div>
                        <span>Mencari produk...</span>
                    </div>
                </div>

                <!-- No suggestions message -->
                <div class="product-suggestions"
                    *ngIf="showSuggestions && manualBarcode.length > 2 && filteredProducts.length === 0">
                    <div class="no-suggestions">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor"
                            style="width: 1.5rem; height: 1.5rem; margin-bottom: 0.5rem; opacity: 0.5;">
                            <path d="M9.5,3A6.5,6.5 0 0,1 
                                     16,9.5C16,11.11 15.41,12.59 
                                     14.44,13.73L14.71,14H15.5L20.5,19L19,20.5 
                                     L14,15.5V14.71L13.73,14.44C12.59,15.41 
                                     11.11,16 9.5,16A6.5,6.5 0 
                                     0,1 3,9.5A6.5,6.5 0 
                                     0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 
                                     7,14 9.5,14C12,14 14,12 
                                     14,9.5C14,7 12,5 9.5,5Z" />
                        </svg>
                        <div>Produk tidak ditemukan</div>
                        <small>Coba kata kunci lain atau scan barcode</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status -->
    <div class="scanner-status">
        <div class="status-indicator" [class.active]="isCameraActive" [class.scanning]="isScanning">
            <div class="status-dot"></div>
            <span class="status-text">
                {{!isCameraActive ? 'Kamera tidak aktif' : (isScanning ? 'Sedang scanning...' : 'Kamera siap')}}
            </span>
        </div>
    </div>

    <!-- Instructions -->
    <div class="scanner-instructions">
        <h3>Cara Menggunakan:</h3>
        <ul>
            <li>Klik "Aktifkan Kamera" untuk mengakses kamera</li>
            <li>Izinkan akses kamera saat diminta browser</li>
            <li>Arahkan barcode ke dalam frame putih</li>
            <li>Klik "Mulai Scan" untuk memulai deteksi</li>
            <li>Atau ketik barcode manual di kolom input</li>
        </ul>
    </div>
</div>