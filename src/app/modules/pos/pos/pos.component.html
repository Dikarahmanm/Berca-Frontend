<!-- src/app/modules/pos/pos/pos.component.html -->
<!-- âœ… FIXED - Corrected form controls and Angular template syntax -->

<div class="pos-container" (keydown)="onKeyDown($event)">

    <!-- Header -->
    <div class="pos-header">
        <div class="header-content">
            <h1 class="pos-title">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M7 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2z" />
                </svg>
                POS Kasir
            </h1>

            <div class="header-actions">
                <button class="icon-button" (click)="showBarcodeScanner = true" title="Scan Barcode (F1)">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M3 5v4h2V7h2V5H3zm2 10H3v4h4v-2H5v-2zm14 4h-4v2h6v-4h-2v2zm0-16h-2v2h2v2h2V5h-2V3zM6 17h1.5v-6H6v6zm3.5 0H11v-6H9.5v6zm2.5 0h1.5v-6H12v6zm3.5 0H17v-6h-1.5v6z" />
                    </svg>
                </button>

                <button class="secondary-button" (click)="clearCart()" [disabled]="cart.length === 0"
                    title="Clear Cart (F12)">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                    </svg>
                    Clear
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="pos-stats">
            <div class="stat-card">
                <span class="stat-value">{{getCartItemCount()}}</span>
                <span class="stat-label">Items</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{formatCurrency(getCartTotalValue())}}</span>
                <span class="stat-label">Total</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pos-main">

        <!-- Left Panel: Product Search & List -->
        <div class="left-panel">

            <!-- Product Search -->
            <div class="search-section">
                <div class="search-input-wrapper">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                    <input #productSearchInput type="text" placeholder="Cari produk (nama/barcode)... (F2)"
                        [(ngModel)]="searchQuery" (input)="onSearchInput($event)" class="search-input">
                </div>
            </div>

            <!-- Product List -->
            <div class="product-list">
                <div class="loading-spinner" *ngIf="isLoading">
                    <div class="spinner-ring"></div>
                    <span>Memuat produk...</span>
                </div>

                <div class="product-grid" *ngIf="!isLoading">
                    <div *ngFor="let product of getFilteredProducts()" class="product-card"
                        [class.out-of-stock]="product.stock === 0" [class.in-cart]="isProductInCart(product.id)"
                        (click)="addToCart(product)">

                        <div class="product-info">
                            <h3 class="product-name">{{product.name}}</h3>
                            <p class="product-category">{{product.category}}</p>
                            <p class="product-price">{{formatCurrency(product.price)}}</p>
                        </div>

                        <div class="product-meta">
                            <span class="product-stock" [class.low-stock]="product.stock > 0 && product.stock < 5"
                                [class.out-of-stock]="product.stock === 0">
                                Stok: {{product.stock}}
                            </span>
                            <span class="product-barcode">{{product.barcode}}</span>
                        </div>

                        <div class="product-actions" *ngIf="product.stock > 0">
                            <span class="cart-quantity" *ngIf="isProductInCart(product.id)">
                                Qty: {{getProductQuantityInCart(product.id)}}
                            </span>
                            <button class="add-btn" (click)="addToCart(product, 1); $event.stopPropagation()">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                                </svg>
                            </button>
                        </div>

                        <div class="out-of-stock-overlay" *ngIf="product.stock === 0">
                            <span>Stok Habis</span>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" *ngIf="!isLoading && getFilteredProducts().length === 0">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                        </svg>
                    </div>
                    <h3>Produk tidak ditemukan</h3>
                    <p>Coba ubah kata kunci pencarian</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Cart & Checkout -->
        <div class="right-panel">

            <!-- Cart Header -->
            <div class="cart-header">
                <h2 class="cart-title">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M7 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1z" />
                    </svg>
                    Keranjang ({{cart.length}})
                </h2>
            </div>

            <!-- Cart Items -->
            <div class="cart-items">
                <div class="empty-cart" *ngIf="cart.length === 0">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M7 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1z" />
                    </svg>
                    <p>Keranjang kosong</p>
                    <small>Pilih produk untuk memulai transaksi</small>
                </div>

                <div class="cart-item" *ngFor="let item of cart; let i = index">
                    <div class="item-info">
                        <h4 class="item-name">{{item.product.name}}</h4>
                        <p class="item-price">{{formatCurrency(item.product.price)}}</p>
                    </div>

                    <div class="item-controls">
                        <div class="quantity-control">
                            <button class="qty-btn" (click)="updateCartItemQuantity(i, item.quantity - 1)">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13H5v-2h14v2z" />
                                </svg>
                            </button>
                            <input type="number" [value]="item.quantity"
                                (input)="updateCartItemQuantity(i, +($event.target as HTMLInputElement).value)"
                                class="qty-input" min="1" [max]="item.product.stock">
                            <button class="qty-btn" (click)="updateCartItemQuantity(i, item.quantity + 1)">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                                </svg>
                            </button>
                        </div>

                        <div class="discount-control">
                            <label>Diskon %</label>
                            <input type="number" [value]="item.discount"
                                (input)="updateCartItemDiscount(i, +($event.target as HTMLInputElement).value)"
                                class="discount-input" min="0" max="100">
                        </div>
                    </div>

                    <div class="item-total">
                        <span class="subtotal">{{formatCurrency(item.subtotal)}}</span>
                        <button class="remove-btn" (click)="removeFromCart(i)" title="Hapus item">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary" *ngIf="cart.length > 0">
                <div class="global-discount">
                    <label for="globalDiscount">Diskon Global (%)</label>
                    <input id="globalDiscount" type="number" [(ngModel)]="globalDiscount"
                        (input)="onGlobalDiscountChange()" class="discount-input" min="0" max="100">
                </div>

                <div class="summary-lines">
                    <div class="summary-line">
                        <span>Subtotal</span>
                        <span>{{formatCurrency(getCartTotals().subtotal)}}</span>
                    </div>
                    <div class="summary-line" *ngIf="getCartTotals().discountAmount > 0">
                        <span>Diskon ({{getCartTotals().globalDiscount}}%)</span>
                        <span class="discount-amount">-{{formatCurrency(getCartTotals().discountAmount)}}</span>
                    </div>
                    <div class="summary-line">
                        <span>Pajak (10%)</span>
                        <span>{{formatCurrency(getCartTotals().tax)}}</span>
                    </div>
                    <div class="summary-line total-line">
                        <span>TOTAL</span>
                        <span class="total-amount">{{formatCurrency(getCartTotals().grandTotal)}}</span>
                    </div>
                </div>

                <!-- Checkout Button -->
                <button class="checkout-btn" (click)="processPayment()" [disabled]="cart.length === 0"
                    title="Process Payment (F9)">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M11 9h2V6h3V4h-3V1h-2v3H8v2h3v3zm-4 9c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zm-9.83-3.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25z" />
                    </svg>
                    Bayar (F9)
                </button>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="modal-overlay" *ngIf="showBarcodeScanner" (click)="showBarcodeScanner = false">
        <div class="modal-content barcode-modal" (click)="$event.stopPropagation()">
            <app-barcode-tools (barcodeScanned)="onBarcodeScanned($event)" (scannerClosed)="showBarcodeScanner = false">
            </app-barcode-tools>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" *ngIf="showPaymentModal" (click)="showPaymentModal = false">
        <div class="modal-content payment-modal" (click)="$event.stopPropagation()">
            <app-payment-modal [totalAmount]="getCartTotals().grandTotal" [isVisible]="showPaymentModal"
                (paymentComplete)="onPaymentComplete($event)" (paymentCancelled)="onPaymentCancelled()">
            </app-payment-modal>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div class="shortcuts-help">
        <small>
            <strong>Shortcuts:</strong>
            F1: Scan | F2: Search | F9: Bayar | F12: Clear
        </small>
    </div>
</div>