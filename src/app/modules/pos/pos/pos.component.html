<!-- POS System - Improved Layout -->
<div class="main">
  
  <!-- Mobile Layout: Floating Panels Design -->
  <div class="mobile-layout mobile-only">
    
    <!-- Fixed Header: Search + Quick Actions -->
    <header class="mobile-header">
      <div class="mobile-search-bar">
        <div class="search-input-wrapper">
          <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
          </svg>
          <input 
            #productSearchInput 
            type="text" 
            class="search-input"
            placeholder="Search products..." 
            [ngModel]="searchQuery()" 
            (ngModelChange)="searchQuery.set($event)" 
            (input)="onSearchInput($event)"
          >
        </div>
        
        <!-- Quick Action Buttons -->
        <div class="quick-actions">
          <button class="quick-btn products-btn" (click)="toggleMobileProducts()" title="Browse Products">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
            </svg>
            <span>Products</span>
          </button>
          
          <button class="quick-btn scan-btn" (click)="showBarcodeScanner.set(true)" title="Scan Barcode">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 5v4h2V7h2V5H3zm2 10H3v4h4v-2H5v-2zm14 4h-4v2h6v-4h-2v2zm0-16h-2v2h2v2h2V5h-2V3zM6 17h1.5v-6H6v6zm3.5 0H11v-6H9.5v6zm2.5 0h1.5v-6H12v6zm3.5 0H17v-6h-1.5v6z" />
            </svg>
            <span>Scan</span>
          </button>
          
          <button class="quick-btn summary-btn" (click)="toggleMobileSummary()" title="Order Summary">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.5c0-.97.68-1.81 1.6-2.02C8.32 16.17 10.14 16 12 16s3.68.17 5.4.48c.92.21 1.6 1.05 1.6 2.02V19z"/>
            </svg>
            <span>Summary</span>
            @if (cartItemCount() > 0) {
              <span class="cart-badge">{{cartItemCount()}}</span>
            }
          </button>
        </div>
      </div>
    </header>
    
    <!-- Main Content: Cart Items (Scrollable) -->
    <main class="mobile-cart-main">
      <div class="cart-content-wrapper" [class.empty]="cartItemCount() === 0">
        @if (cartItemCount() === 0) {
          <div class="empty-cart-state">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
              </svg>
            </div>
            <h3>Cart is Empty</h3>
            <p>Tap "Products" to browse and add items</p>
          </div>
        } @else {
          <div class="cart-items-list">
            @for (item of cart(); track item.product.id) {
              <div class="mobile-cart-item">
                <div class="item-image">
                  <img 
                    [src]="'/assets/images/placeholder-product.png'" 
                    [alt]="item.product.name"
                    loading="lazy"
                  >
                </div>
                
                <div class="item-details">
                  <h4 class="item-name">{{item.product.name}}</h4>
                  <div class="item-price">{{formatCurrency(item.product.sellPrice)}}</div>
                  
                  <div class="item-controls">
                    <!-- Quantity Controls -->
                    <div class="quantity-section">
                      <button 
                        class="qty-btn minus"
                        (click)="decreaseQuantity($index)"
                        [disabled]="item.quantity <= 1"
                      >
                        <svg viewBox="0 0 24 24" fill="currentColor">
                          <path d="M19 13H5v-2h14v2z"/>
                        </svg>
                      </button>
                      
                      <span class="qty-display">{{item.quantity}}</span>
                      
                      <button 
                        class="qty-btn plus"
                        (click)="increaseQuantity($index)"
                        [disabled]="item.quantity >= item.product.stock"
                      >
                        <svg viewBox="0 0 24 24" fill="currentColor">
                          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                      </button>
                    </div>
                    
                    <!-- Item Discount -->
                    <div class="discount-section">
                      <label>Disc:</label>
                      <input 
                        type="number" 
                        class="discount-input"
                        [ngModel]="item.discount || 0"
                        (ngModelChange)="setItemDiscount($index, $event)"
                        min="0"
                        [max]="item.product.sellPrice * item.quantity"
                        placeholder="0"
                      >
                    </div>
                    
                    <!-- Remove Button -->
                    <button 
                      class="remove-btn"
                      (click)="removeFromCart($index)"
                      title="Remove item"
                    >
                      <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  </div>
                  
                  <div class="item-total">
                    @if (item.discount && item.discount > 0) {
                      <div class="original-total">{{formatCurrency(item.product.sellPrice * item.quantity)}}</div>
                    }
                    <div class="final-total">{{formatCurrency((item.product.sellPrice * item.quantity) - (item.discount || 0))}}</div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </main>
    
    <!-- Floating Summary Panel -->
    <div class="mobile-summary-panel" [class.open]="showMobileSummary()">
      <div class="summary-handle" (click)="toggleMobileSummary()">
        <div class="handle-bar"></div>
        <div class="summary-preview">
          <span class="item-count">{{cartItemCount()}} items</span>
          <span class="total-amount">{{formatCurrency(cartTotal())}}</span>
        </div>
      </div>
      
      <div class="summary-content">
        <!-- Member Info (No Auto Discount) -->
        <!-- ‚úÖ FIX: Mobile Member Search Section - Replace yang lama -->
        @if (selectedMember()) {
        <div class="member-display">
          <div class="member-info">
            <svg class="member-icon" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <div class="member-details">
              <span class="member-name">{{selectedMember()!.name}}</span>
              <span class="member-meta">{{selectedMember()!.tier}} ‚Ä¢ {{selectedMember()!.availablePoints}} pts</span>
            </div>
          </div>
          <button class="clear-member" (click)="clearMember()">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
            </svg>
          </button>
        </div>
        } @else {
        <!-- ‚úÖ FIX: Mobile member search with proper toggle -->
        @if (!showMemberInput()) {
        <button class="add-member-btn" (click)="toggleMemberInput()">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
          </svg>
          <span>Add Member</span>
        </button>
        } @else {
          <!-- ‚úÖ FIX: Member search input field -->
          <div class="mobile-member-search">
            <div class="member-input-wrapper">
              <input type="text" class="mobile-member-input" placeholder="Search member by name or phone"
                [ngModel]="memberPhone()" (ngModelChange)="memberPhone.set($event)" (input)="onMemberSearch($event)"
                (keyup.enter)="searchMember()">
              <button class="search-member-btn" (click)="searchMember()" [disabled]="!memberPhone()">
                @if (isSearchingMembers()) {
                <div class="loading-spinner-small"></div>
                } @else {
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                </svg>
                }
              </button>
              <button class="cancel-member-btn" (click)="toggleMemberInput()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
              </button>
            </div>
          
            <!-- ‚úÖ FIX: Member suggestions for mobile -->
            @if (showMemberSuggestions && searchedMembers().length > 0) {
            <div class="mobile-member-suggestions">
              @for (member of searchedMembers(); track member.id) {
              <div class="mobile-member-item" (click)="selectMember(member)">
                <div class="mobile-member-info">
                  <div class="mobile-member-name">{{member.name}}</div>
                  <div class="mobile-member-details">
                    <span class="mobile-member-number">{{member.memberNumber}}</span>
                    <span class="mobile-member-tier">{{member.tier}}</span>
                  </div>
                </div>
                <div class="mobile-member-points">{{member.availablePoints}} pts</div>
              </div>
              }
            </div>
            }
          </div>
          }
        }
        
        <!-- Global Discount -->
        <div class="global-discount">
          <label for="globalDisc">Global Discount (%):</label>
          <input 
            type="number" 
            id="globalDisc"
            class="discount-input"
            [ngModel]="globalDiscount()"
            (ngModelChange)="globalDiscount.set($event)"
            min="0"
            max="100"
            placeholder="0"
          >
        </div>
        
        <!-- Totals -->
        <div class="order-totals">
          <div class="total-line">
            <span>Subtotal:</span>
            <span>{{formatCurrency(cartSubtotal())}}</span>
          </div>
          
          @if (cartDiscountAmount() > 0) {
            <div class="total-line discount">
              <span>Discount:</span>
              <span>-{{formatCurrency(cartDiscountAmount())}}</span>
            </div>
          }
          
          <div class="total-line final">
            <span>Total:</span>
            <span>{{formatCurrency(cartTotal())}}</span>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <button 
            class="clear-cart-btn"
            (click)="clearCart()"
            [disabled]="cartItemCount() === 0"
          >
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            Clear Cart
          </button>
          
          <button 
            class="checkout-btn"
            (click)="showPaymentModal.set(true)"
            [disabled]="cartItemCount() === 0"
          >
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
            </svg>
            Process Payment
          </button>
        </div>
      </div>
    </div>
    
    <!-- Floating Products Panel -->
    <div class="mobile-products-panel" [class.open]="showMobileProducts()">
      <div class="products-header">
        <h3>Products</h3>
        <button class="close-products" (click)="toggleMobileProducts()">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      
      <div class="products-content">
        <!-- Filter Tabs -->
        <div class="filter-tabs">
          <button 
            class="filter-tab" 
            [class.active]="selectedFilter() === 'all'"
            (click)="setFilter('all')"
          >
            All
          </button>
          <button 
            class="filter-tab" 
            [class.active]="selectedFilter() === 'category'"
            (click)="setFilter('category')"
          >
            Category
          </button>
          <button 
            class="filter-tab" 
            [class.active]="selectedFilter() === 'hot'"
            (click)="setFilter('hot')"
          >
            Hot
          </button>
        </div>
        
        <!-- Product Grid -->
        <div class="mobile-product-grid">
          @for (product of filteredProducts(); track product.id) {
            <div 
              class="product-card"
              [class.out-of-stock]="product.stock === 0"
              [class.in-cart]="isProductInCart(product.id)"
              (click)="addToCart(product)"
            >
              <div class="product-info">
                <h4 class="product-name">{{product.name}}</h4>
                <div class="product-price">{{formatCurrency(product.sellPrice)}}</div>
                <div class="product-stock" [class.low]="product.stock <= (product.minStock || 5)">
                  Stock: {{product.stock}}
                </div>
              </div>
              
              @if (product.stock > 0) {
                <button class="add-product-btn" type="button">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                  </svg>
                </button>
              } @else {
                <div class="out-of-stock-label">Out of Stock</div>
              }
            </div>
          }
        </div>
      </div>
    </div>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" 
         [class.active]="showMobileProducts() || showMobileSummary()"
         (click)="closeMobilePanels()">
    </div>
  </div>
  
  <!-- Desktop Layout: 4:5:3 Grid -->
  <div class="desktop-layout desktop-only">
    
    <!-- Left Panel: Products (4fr) -->
    <section class="left-panel">
      <!-- NEW: Branch Context Header -->
      @if (activeBranch()) {
        <div class="branch-context-header">
          <div class="branch-info">
            <span class="branch-icon">üè™</span>
            <div class="branch-details">
              <span class="branch-name">{{ activeBranch()!.branchName }}</span>
              <span class="branch-code">{{ activeBranch()!.branchCode }}</span>
            </div>
          </div>
          <div class="branch-status" [class.active]="canProcessTransaction()">
            @if (canProcessTransaction()) {
              <span class="status-indicator success">‚úì Active</span>
            } @else {
              <span class="status-indicator warning">‚ö† Read Only</span>
            }
          </div>
        </div>
      }
      
      <!-- Search Section -->
      <div class="search-section">
        <div class="search-input-wrapper">
          <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
          </svg>
          <input 
            #productSearchInput 
            type="text" 
            class="search-input"
            placeholder="Search products by name or barcode..." 
            [ngModel]="searchQuery()" 
            (ngModelChange)="searchQuery.set($event)" 
            (input)="onSearchInput($event)"
          >
        </div>
        
        <!-- Filter Section -->
        <div class="filter-section">
          <div class="filter-tabs">
            <button 
              class="filter-tab" 
              [class.active]="selectedFilter() === 'all'"
              (click)="setFilter('all')"
            >
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
              </svg>
              All
            </button>
            
            <button 
              class="filter-tab" 
              [class.active]="selectedFilter() === 'category'"
              (click)="setFilter('category')"
            >
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Category
            </button>
            
            <button 
              class="filter-tab" 
              [class.active]="selectedFilter() === 'hot'"
              (click)="setFilter('hot')"
            >
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67z"/>
              </svg>
              Hot
            </button>
          </div>
          
          <!-- Category Dropdown -->
          @if (selectedFilter() === 'category') {
            <div class="category-dropdown">
              <select 
                class="category-select"
                [ngModel]="selectedCategoryId()" 
                (ngModelChange)="setSelectedCategory($event)"
              >
                <option value="">All Categories</option>
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{category.name}}</option>
                }
              </select>
            </div>
          }
        </div>
      </div>

      <!-- Product List (Full Height) -->
      <div class="product-list">
        @if (isSearching()) {
          <div class="loading-spinner">
            <div class="spinner-ring"></div>
            <span>Searching products...</span>
          </div>
        } @else {
          <div class="product-grid">
            @for (product of filteredProducts(); track product.id) {
              <div 
                class="product-card"
                [class.out-of-stock]="product.stock === 0"
                [class.in-cart]="isProductInCart(product.id)"
                (click)="addToCart(product)"
              >
                <div class="product-info">
                  <h3 class="product-name">{{product.name}}</h3>
                  <p class="product-category">{{product.categoryName}}</p>
                  <p class="product-price">{{formatCurrency(product.sellPrice)}}</p>
                </div>
                
                <div class="product-meta">
                  <span 
                    class="product-stock"
                    [class.low-stock]="product.stock > 0 && product.stock <= (product.minStock || 5)"
                    [class.out-of-stock]="product.stock === 0"
                  >
                    Stock: {{product.stock}}
                  </span>
                </div>
              </div>
            }
          </div>
        }
        
        @if (!isSearching() && filteredProducts().length === 0) {
          <div class="empty-state">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
              </svg>
            </div>
            <h3>No products found</h3>
            <p>Try adjusting your search keywords</p>
          </div>
        }
      </div>
    </section>

    <!-- Middle Panel: Shopping Cart (5fr) -->
    <section class="middle-panel">
      <!-- Cart Header with Actions -->
      <div class="cart-header">
        <h2 class="cart-title">Shopping Cart</h2>
        
        <!-- Scanner and Clear buttons BELOW title -->
        <div class="cart-actions">
          <button class="action-btn scanner-btn" (click)="showBarcodeScanner.set(true)" title="Scan Barcode">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 5v4h2V7h2V5H3zm2 10H3v4h4v-2H5v-2zm14 4h-4v2h6v-4h-2v2zm0-16h-2v2h2v2h2V5h-2V3zM6 17h1.5v-6H6v6zm3.5 0H11v-6H9.5v6zm2.5 0h1.5v-6H12v6zm3.5 0H17v-6h-1.5v6z"/>
            </svg>
            Scan
          </button>
          
          <button class="action-btn clear-btn" (click)="clearCart()" [disabled]="cartItemCount() === 0" title="Clear Cart">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            Clear
          </button>
          
          <!-- DEBUG: Test toast button -->
          <button class="action-btn test-btn" (click)="testToast()" title="Test Toast" style="background: #FF914D; color: white;">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            Test
          </button>
        </div>
      </div>

      <!-- Cart Content -->
      <div class="cart-content">
        @if (cartItemCount() === 0) {
          <div class="empty-cart">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2z" />
            </svg>
            <p class="empty-message">Cart is empty</p>
            <p class="empty-hint">Select products to start a transaction</p>
          </div>
        } @else {
          <div class="cart-items">
            @for (item of cart(); track item.product.id; let i = $index) {
              <div class="cart-item">
                <div class="item-header">
                  <h4 class="item-name">{{item.product.name}}</h4>
                  <button 
                    class="remove-item"
                    (click)="removeFromCart(i)"
                    aria-label="Remove item"
                  >
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                    </svg>
                  </button>
                </div>
                
                <div class="item-details">
                  <div class="price-section">
                    <div class="item-price">{{formatCurrency(item.product.sellPrice)}}</div>
                    <div class="discount-controls">
                      <span class="discount-label">Item Disc:</span>
                      <input 
                        type="number" 
                        class="item-discount-input"
                        [ngModel]="item.discount || 0"
                        (ngModelChange)="setItemDiscount(i, $event)"
                        min="0"
                        [max]="item.product.sellPrice * item.quantity"
                        placeholder="0"
                      >
                    </div>
                  </div>
                  
                  <div class="quantity-controls">
                    <button 
                      class="qty-btn"
                      (click)="decreaseQuantity(i)"
                      [disabled]="item.quantity <= 1"
                    >
                      ‚àí
                    </button>
                    
                    <input 
                      type="number" 
                      class="qty-input"
                      [(ngModel)]="item.quantity" 
                      (ngModelChange)="onQuantityChange(i, $event)"
                      min="1" 
                      [max]="item.product.stock"
                    >
                    
                    <button 
                      class="qty-btn"
                      (click)="increaseQuantity(i)"
                      [disabled]="item.quantity >= item.product.stock"
                    >
                      +
                    </button>
                  </div>
                  
                  <div class="subtotal-section">
                    @if (item.discount && item.discount > 0) {
                      <div class="original-subtotal">
                        {{formatCurrency(item.product.sellPrice * item.quantity)}}
                      </div>
                    }
                    <div class="item-subtotal">
                      {{formatCurrency((item.product.sellPrice * item.quantity) - (item.discount || 0))}}
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </section>

    <!-- Right Panel: Summary (3fr) -->
    <aside class="right-panel">
      <!-- Summary Content -->
      <div class="summary-content">
        <!-- Member Section (No Auto Discount) -->
        <div class="member-section">
          <h4 class="section-title">Member Info</h4>
          @if (!selectedMember()) {
            <div class="member-search">
              <div class="member-input-wrapper">
                <input 
                  type="text" 
                  class="member-input"
                  placeholder="Search member by name or phone"
                  [ngModel]="memberPhone()"
                  (ngModelChange)="memberPhone.set($event)"
                  (input)="onMemberSearch($event)"
                  (keyup.enter)="searchMember()"
                  (focus)="showMemberSuggestions = true"
                  (blur)="onMemberInputBlur()"
                >
                <button class="search-member-btn" (click)="searchMember()" [disabled]="!memberPhone()">
                  @if (isSearchingMembers()) {
                    <div class="loading-spinner-small"></div>
                  } @else {
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                  }
                </button>
                
                <!-- Member Suggestions -->
                @if (showMemberSuggestions && searchedMembers().length > 0) {
                  <div class="member-suggestions">
                    @for (member of searchedMembers(); track member.id) {
                      <div class="member-suggestion-item" (mousedown)="selectMember(member)">
                        <div class="member-suggestion-info">
                          <div class="member-suggestion-name">{{member.name}}</div>
                          <div class="member-suggestion-details">
                            <span class="member-number">{{member.memberNumber}}</span>
                            <span class="member-tier">{{member.tier}}</span>
                            <span class="member-phone">{{member.phone}}</span>
                          </div>
                        </div>
                        <div class="member-suggestion-points">{{member.availablePoints}} pts</div>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
            <div class="no-member-msg">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
              </svg>
              <span>No member selected</span>
            </div>
          } @else {
            <div class="member-info">
              <div class="member-avatar">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                </svg>
              </div>
              <div class="member-details">
                <div class="member-name">{{selectedMember()!.name}}</div>
                <div class="member-phone">{{selectedMember()!.phone}}</div>
                <div class="member-stats">
                  <div class="member-points">{{selectedMember()!.availablePoints.toLocaleString()}} points</div>
                  <div class="member-tier">{{selectedMember()!.tier}} member</div>
                </div>
              </div>
              <button class="clear-member-btn" (click)="clearMember()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
              </button>
            </div>
          }
        </div>

        <!-- Global Discount Section -->
        @if (cartItemCount() > 0) {
          <div class="discount-section">
            <h4 class="section-title">Global Discount</h4>
            <div class="discount-input-group">
              <input 
                type="number" 
                class="discount-input"
                [ngModel]="globalDiscount()"
                (ngModelChange)="globalDiscount.set($event)"
                min="0"
                max="100"
                placeholder="0"
              >
              <span class="percent-symbol">%</span>
            </div>
            @if (globalDiscount() > 0) {
              <div class="discount-amount">
                Discount: -{{formatCurrency(cartDiscountAmount())}}
              </div>
            }
          </div>

          <!-- Cart Summary -->
          <div class="cart-summary">
            <div class="summary-line">
              <span class="label">Items:</span>
              <span class="value">{{cartItemCount()}}</span>
            </div>
            
            <div class="summary-line">
              <span class="label">Subtotal:</span>
              <span class="value">{{formatCurrency(cartSubtotal())}}</span>
            </div>
            
            @if (cartDiscountAmount() > 0) {
              <div class="summary-line discount">
                <span class="label">Global Discount:</span>
                <span class="value">-{{formatCurrency(cartDiscountAmount())}}</span>
              </div>
            }
            
            <div class="summary-line total">
              <span class="label">Total:</span>
              <span class="value">{{formatCurrency(cartTotal())}}</span>
            </div>
          </div>

          <!-- Checkout Button -->
          <button 
            class="btn-checkout"
            (click)="proceedToCheckout()"
            [disabled]="cartItemCount() === 0 || isProcessingPayment()"
          >
            @if (isProcessingPayment()) {
              Processing...
            } @else {
              Checkout {{formatCurrency(cartTotal())}}
            }
          </button>
        } @else {
          <div class="empty-summary">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2z"/>
            </svg>
            <p>Cart is empty</p>
          </div>
        }
      </div>
    </aside>
  </div>
</div>

<!-- Barcode Scanner Modal -->
@if (showBarcodeScanner()) {
  <div class="backdrop" (click)="showBarcodeScanner.set(false)">
    <div class="modal-dialog barcode-modal" (click)="$event.stopPropagation()">
      <app-barcode-tools
        [isOpen]="showBarcodeScanner()"
        (barcodeScanned)="onBarcodeScanned($event)"
        (scannerClosed)="showBarcodeScanner.set(false)"
      />
    </div>
  </div>
}

<!-- Payment Modal -->
@if (showPaymentModal()) {
  <div class="backdrop" (click)="onPaymentCancelled()">
    <div class="modal-dialog payment-modal-wrapper" (click)="$event.stopPropagation()">
      <app-payment-modal
        [totalAmount]="cartTotal()"
        [isVisible]="showPaymentModal()"
        [hasMember]="!!selectedMember()"
        [memberId]="selectedMember()?.id"
        [memberCreditData]="memberCreditData()"
        [branchContext]="branchContext()"
        (paymentComplete)="onPaymentComplete($event)"
        (paymentCancelled)="onPaymentCancelled()"
      />
    </div>
  </div>
}

<!-- Product Registration Modal -->
@if (showProductRegistrationModal()) {
  <div class="backdrop" (click)="onProductRegistrationCancelled()">
    <div class="modal-dialog product-registration-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">
          <svg class="modal-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          Register New Product
        </h3>
        <button class="close-btn" (click)="onProductRegistrationCancelled()" type="button">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-message">
          Barcode <strong>{{scannedBarcodeForRegistration()}}</strong> not found in system. 
          Please fill in the product information below.
        </div>

        <form #productForm="ngForm" (ngSubmit)="submitNewProduct(productForm)">
          <div class="form-grid">
            <div class="form-group">
              <label for="productName">Product Name *</label>
              <input 
                type="text" 
                id="productName"
                name="productName"
                class="form-input"
                placeholder="Enter product name"
                [ngModel]="newProduct().name"
                (ngModelChange)="updateNewProduct('name', $event)"
                required
              >
            </div>

            <div class="form-group">
              <label for="productBarcode">Barcode</label>
              <input 
                type="text" 
                id="productBarcode"
                name="productBarcode"
                class="form-input"
                [value]="scannedBarcodeForRegistration()"
                readonly
              >
            </div>

            <div class="form-group">
              <label for="productCategory">Category *</label>
              <select 
                id="productCategory"
                name="productCategory"
                class="form-select"
                [ngModel]="newProduct().categoryId"
                (ngModelChange)="updateNewProduct('categoryId', $event)"
                required
              >
                <option value="" disabled>Select category</option>
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{category.name}}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="productUnit">Unit</label>
              <input 
                type="text" 
                id="productUnit"
                name="productUnit"
                class="form-input"
                placeholder="pcs"
                [ngModel]="newProduct().unit"
                (ngModelChange)="updateNewProduct('unit', $event)"
              >
            </div>

            <div class="form-group">
              <label for="productStock">Current Stock *</label>
              <input 
                type="number" 
                id="productStock"
                name="productStock"
                class="form-input"
                placeholder="0"
                min="0"
                [ngModel]="newProduct().stock"
                (ngModelChange)="updateNewProduct('stock', $event)"
                required
              >
            </div>

            <div class="form-group">
              <label for="productMinStock">Minimum Stock *</label>
              <input 
                type="number" 
                id="productMinStock"
                name="productMinStock"
                class="form-input"
                placeholder="5"
                min="0"
                [ngModel]="newProduct().minimumStock"
                (ngModelChange)="updateNewProduct('minimumStock', $event)"
                required
              >
            </div>

            <div class="form-group">
              <label for="productBuyPrice">Buy Price *</label>
              <input 
                type="number" 
                id="productBuyPrice"
                name="productBuyPrice"
                class="form-input"
                placeholder="0"
                min="0"
                step="1000"
                [ngModel]="newProduct().buyPrice"
                (ngModelChange)="updateNewProduct('buyPrice', $event)"
                required
              >
            </div>

            <div class="form-group">
              <label for="productSellPrice">Sell Price *</label>
              <input 
                type="number" 
                id="productSellPrice"
                name="productSellPrice"
                class="form-input"
                placeholder="0"
                min="0"
                step="1000"
                [ngModel]="newProduct().sellPrice"
                (ngModelChange)="updateNewProduct('sellPrice', $event)"
                required
              >
            </div>

            <div class="form-group full-width">
              <label for="productDescription">Description</label>
              <textarea 
                id="productDescription"
                name="productDescription"
                class="form-textarea"
                placeholder="Product description (optional)"
                rows="3"
                [ngModel]="newProduct().description"
                (ngModelChange)="updateNewProduct('description', $event)"
              ></textarea>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-actions">
        <button 
          type="button"
          class="modal-btn btn-cancel" 
          (click)="onProductRegistrationCancelled()"
        >
          Cancel
        </button>
        <button 
          type="submit"
          class="modal-btn btn-confirm" 
          (click)="submitNewProduct(productForm)"
          [disabled]="isLoading() || !newProduct().name || !newProduct().sellPrice"
        >
          @if (isLoading()) {
            <svg class="spinner" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
            </svg>
            Saving...
          } @else {
            Save & Add to Cart
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Clear Cart Confirmation Modal -->
@if (showClearCartModal()) {
  <div class="backdrop" (click)="cancelClearCart()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <svg class="modal-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
      </svg>
      <h3 class="modal-title">Clear Shopping Cart?</h3>
      <p class="modal-message">This will remove all items from your cart. This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="modal-btn btn-cancel" (click)="cancelClearCart()">
          Cancel
        </button>
        <button class="modal-btn btn-confirm" (click)="confirmClearCart()">
          Clear Cart
        </button>
      </div>
    </div>
  </div>
}