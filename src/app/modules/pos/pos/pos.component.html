<!-- src/app/modules/pos/pos/pos.component.html - IMPROVED LAYOUT -->
<div class="pos-container">

    <!-- Header -->
    <div class="pos-header">
        <div class="header-content">
            <h1 class="pos-title">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M7 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2z" />
                </svg>
                POS Kasir
            </h1>

            <div class="header-actions">
                <button class="icon-button" (click)="showBarcodeScanner = true" title="Scan Barcode (F1)">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M3 5v4h2V7h2V5H3zm2 10H3v4h4v-2H5v-2zm14 4h-4v2h6v-4h-2v2zm0-16h-2v2h2v2h2V5h-2V3zM6 17h1.5v-6H6v6zm3.5 0H11v-6H9.5v6zm2.5 0h1.5v-6H12v6zm3.5 0H17v-6h-1.5v6z" />
                    </svg>
                    Scan Barcode
                </button>

                <button class="secondary-button" (click)="clearCart()" [disabled]="cart.length === 0"
                    title="Clear Cart (F12)">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                    </svg>
                    Clear Cart
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="pos-stats">
            <div class="stat-card">
                <span class="stat-value">{{getCartItemCount()}}</span>
                <span class="stat-label">Items in Cart</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{formatCurrency(getCartTotalValue())}}</span>
                <span class="stat-label">Cart Total</span>
            </div>
            <div class="stat-card" *ngIf="selectedMember">
                <span class="stat-value">{{selectedMember.availablePoints.toLocaleString()}}</span>
                <span class="stat-label">Member Points</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pos-main">

        <!-- Left Panel: Product Search & List -->
        <div class="left-panel">

            <!-- Product Search -->
            <div class="search-section">
                <div class="search-input-wrapper">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                    <input #productSearchInput type="text" placeholder="Search products by name or barcode... (F2)"
                        [(ngModel)]="searchQuery" (input)="onSearchInput($event)" class="search-input">
                </div>
            </div>

            <!-- Product List -->
            <div class="product-list">
                <!-- Loading Spinner -->
                <div class="loading-spinner" *ngIf="isSearching">
                    <div class="spinner-ring"></div>
                    <span>Searching products...</span>
                </div>

                <!-- Product Grid -->
                <div class="product-grid" *ngIf="!isSearching">
                    <div *ngFor="let product of getFilteredProducts()" class="product-card"
                        [class.out-of-stock]="product.stock === 0" [class.in-cart]="isProductInCart(product.id)"
                        (click)="addToCart(product)">

                        <div class="product-info">
                            <h3 class="product-name">{{product.name}}</h3>
                            <p class="product-category">{{product.categoryName}}</p>
                            <p class="product-price">{{formatCurrency(product.sellPrice)}}</p>
                        </div>

                        <div class="product-meta">
                            <span class="product-stock"
                                [class.low-stock]="product.stock > 0 && product.stock <= product.minStock"
                                [class.out-of-stock]="product.stock === 0">
                                Stock: {{product.stock}}
                            </span>
                            <span class="product-barcode">{{product.barcode}}</span>
                        </div>

                        <div class="product-actions" *ngIf="product.stock > 0">
                            <span class="cart-quantity" *ngIf="isProductInCart(product.id)">
                                Qty: {{getProductQuantityInCart(product.id)}}
                            </span>
                            <button class="add-btn" (click)="addToCart(product, 1); $event.stopPropagation()">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                                </svg>
                            </button>
                        </div>

                        <div class="out-of-stock-overlay" *ngIf="product.stock === 0">
                            <span>Out of Stock</span>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" *ngIf="!isSearching && getFilteredProducts().length === 0">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                        </svg>
                    </div>
                    <h3>No products found</h3>
                    <p>Try adjusting your search keywords</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Cart & Checkout -->
        <div class="right-panel">

            <!-- Cart Header -->
            <div class="cart-header">
                <h2 class="cart-title">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M7 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1z" />
                    </svg>
                    Shopping Cart ({{cart.length}})
                </h2>
            </div>

            <!-- Cart Items -->
            <div class="cart-items">
                <!-- Empty Cart -->
                <div class="empty-cart" *ngIf="cart.length === 0">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M7 18c0 1.1.9 2 2 2s2-.9 2-2-.9-2-2-2-2 .9-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1z" />
                    </svg>
                    <p>Cart is empty</p>
                    <small>Select products to start a transaction</small>
                </div>

                <!-- Cart Item List -->
                <!-- ALTERNATIVE APPROACH: Two-way binding dengan temporary properties -->
                <!-- src/app/modules/pos/pos/pos.component.html - CART ITEMS SECTION -->
                
                <!-- Cart Item List dengan Two-way Binding -->
                <div class="cart-item" *ngFor="let item of cart; let i = index">
                    <div class="item-info">
                        <h4 class="item-name">{{item.product.name}}</h4>
                        <p class="item-price">{{formatCurrency(item.product.sellPrice)}}</p>
                    </div>
                
                    <div class="item-controls">
                        <div class="quantity-control">
                            <button class="qty-btn" (click)="decreaseQuantity(i)" [disabled]="item.quantity <= 1">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13H5v-2h14v2z" />
                                </svg>
                            </button>
                
                            <!-- FIXED: Simple two-way binding -->
                            <input type="number" [(ngModel)]="item.quantity" (ngModelChange)="onQuantityChange(i, $event)"
                                class="qty-input" min="1" [max]="item.product.stock">
                
                            <button class="qty-btn" (click)="increaseQuantity(i)" [disabled]="item.quantity >= item.product.stock">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                                </svg>
                            </button>
                        </div>
                
                        <div class="discount-control">
                            <label>Diskon %</label>
                            <!-- FIXED: Simple two-way binding -->
                            <input type="number" [(ngModel)]="item.discount" (ngModelChange)="onDiscountChange(i, $event)"
                                class="discount-input" min="0" max="100" step="0.1">
                        </div>
                    </div>
                
                    <div class="item-total">
                        <span class="subtotal">{{formatCurrency(item.subtotal)}}</span>
                        <button class="remove-btn" (click)="removeFromCart(i)" title="Hapus item">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary" *ngIf="cart.length > 0">
                <!-- Customer Info -->
                <div class="customer-info-section">
                    <h3 class="section-title">
                        <mat-icon>person</mat-icon>
                        Informasi Pelanggan
                    </h3>
                    
                    <div class="customer-fields">
                        <div class="input-group modern-input">
                            <mat-icon class="input-icon">person</mat-icon>
                            <input id="customerName" type="text" [(ngModel)]="customerName" 
                                   class="modern-input-field" placeholder="Nama Pelanggan (Opsional)">
                            <label for="customerName" class="floating-label">Nama Pelanggan</label>
                        </div>

                        <div class="input-group modern-input">
                            <mat-icon class="input-icon">phone</mat-icon>
                            <input id="customerPhone" type="tel" [(ngModel)]="customerPhone" 
                                   class="modern-input-field" placeholder="No. Telepon (Opsional)">
                            <label for="customerPhone" class="floating-label">No. Telepon</label>
                        </div>
                    </div>
                </div>

                <!-- Membership Integration -->
                <div class="membership-section">
                    <h3 class="section-title">
                        <mat-icon>card_membership</mat-icon>
                        Member
                    </h3>
                    
                    <div class="membership-fields">
                        <!-- Selected Member Display -->
                        <div class="selected-member" *ngIf="selectedMember">
                            <div class="member-info">
                                <div class="member-details">
                                    <span class="member-name">{{ selectedMember.name }}</span>
                                    <span class="member-number">{{ selectedMember.memberNumber }}</span>
                                    <span class="member-tier" [class]="'tier-' + selectedMember.tier.toLowerCase()">
                                        {{ selectedMember.tier }}
                                    </span>
                                </div>
                                <div class="member-points">
                                    <span class="points-label">Poin:</span>
                                    <span class="points-value">{{ selectedMember.availablePoints.toLocaleString() }}</span>
                                </div>
                            </div>
                            <button type="button" class="clear-member-btn" (click)="clearMember()">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>

                        <!-- Member Search -->
                        <div class="member-search" *ngIf="!selectedMember">
                            <div class="input-group modern-input">
                                <mat-icon class="input-icon">search</mat-icon>
                                <input 
                                    type="text" 
                                    [(ngModel)]="memberSearchQuery"
                                    (input)="searchMembers($event.target.value)"
                                    class="modern-input-field" 
                                    placeholder="Cari member (nama/nomor)">
                                <label class="floating-label">Cari Member</label>
                            </div>
                            
                            <!-- Search Results -->
                            <div class="member-dropdown" *ngIf="searchedMembers.length > 0">
                                <div 
                                    class="member-option" 
                                    *ngFor="let member of searchedMembers"
                                    (click)="selectMember(member)">
                                    <div class="member-option-details">
                                        <span class="member-option-name">{{ member.name }}</span>
                                        <span class="member-option-number">{{ member.memberNumber }}</span>
                                    </div>
                                    <span class="member-option-tier" [class]="'tier-' + member.tier.toLowerCase()">
                                        {{ member.tier }}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Loading State -->
                            <div class="member-loading" *ngIf="isSearchingMembers">
                                <span>Mencari member...</span>
                            </div>
                        </div>

                        <!-- Points Earned Preview -->
                        <div class="points-preview" *ngIf="selectedMember && (cartTotals$ | async)?.total > 0">
                            <div class="points-info">
                                <mat-icon>star</mat-icon>
                                <span>Poin yang akan didapat: <strong>{{ calculateEarnedPoints((cartTotals$ | async)?.total || 0) }}</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Discount -->
                <div class="global-discount-section">
                    <h4 class="section-title small">
                        <mat-icon>local_offer</mat-icon>
                        Diskon Transaksi
                    </h4>
                    <div class="discount-input-wrapper">
                        <input id="globalDiscount" type="number" [(ngModel)]="globalDiscount"
                               (input)="onGlobalDiscountChange()" class="modern-discount-input" 
                               min="0" max="100" placeholder="0">
                        <span class="discount-unit">%</span>
                        <label for="globalDiscount" class="discount-label">Diskon Global</label>
                    </div>
                </div>

                <!-- Notes -->
                <div class="notes-section">
                    <h4 class="section-title small">
                        <mat-icon>note</mat-icon>
                        Catatan Transaksi
                    </h4>
                    <div class="modern-textarea">
                        <mat-icon class="textarea-icon">edit_note</mat-icon>
                        <textarea id="notes" [(ngModel)]="notes" class="modern-textarea-field" 
                                  placeholder="Tambahkan catatan untuk transaksi ini..." rows="3"></textarea>
                        <label for="notes" class="floating-label">Catatan Tambahan</label>
                    </div>
                </div>

                <!-- Summary Lines -->
                <div class="summary-lines">
                    <div class="summary-line">
                        <span>Subtotal</span>
                        <span>{{formatCurrency(getCartTotals().subtotal)}}</span>
                    </div>
                    <div class="summary-line" *ngIf="getCartTotals().discountAmount > 0">
                        <span>Diskon ({{getCartTotals().globalDiscount}}%)</span>
                        <span class="discount-amount">-{{formatCurrency(getCartTotals().discountAmount)}}</span>
                    </div>
                    <!-- ✅ HIDDEN: Tax line removed as tax calculation is disabled -->
                    <!-- <div class="summary-line">
                        <span>Pajak (11%)</span>
                        <span>{{formatCurrency(getCartTotals().taxAmount)}}</span>
                    </div> -->
                    <div class="summary-line total-line">
                        <span>TOTAL</span>
                        <span class="total-amount">{{formatCurrency(getCartTotals().total)}}</span>
                    </div>
                </div>

                <!-- Checkout Button -->
                <button class="checkout-btn" (click)="processPayment()" [disabled]="cart.length === 0 || isLoading"
                    title="Process Payment (F9)">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor" *ngIf="!isLoading">
                        <path
                            d="M11 9h2V6h3V4h-3V1h-2v3H8v2h3v3zm-4 9c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zm-9.83-3.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25z" />
                    </svg>
                    <div class="spinner" *ngIf="isLoading"></div>
                    {{isLoading ? 'Memproses...' : 'Bayar (F9)'}}
                </button>
            </div>
        </div>
    </div>

    <!-- Error/Success Messages -->
    <div class="message-overlay" *ngIf="errorMessage || successMessage">
        <div class="message error" *ngIf="errorMessage">
            <svg class="message-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z" />
            </svg>
            {{errorMessage}}
        </div>

        <div class="message success" *ngIf="successMessage">
            <svg class="message-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.08L11,13.67L7.91,10.58L6.5,12L11,16.5Z" />
            </svg>
            {{successMessage}}
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="modal-overlay" *ngIf="showBarcodeScanner" (click)="showBarcodeScanner = false">
        <div class="modal-content barcode-modal" (click)="$event.stopPropagation()">
            <app-barcode-tools (barcodeScanned)="onBarcodeScanned($event)" (scannerClosed)="showBarcodeScanner = false">
            </app-barcode-tools>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" *ngIf="showPaymentModal" (click)="showPaymentModal = false">
        <div class="modal-content payment-modal" (click)="$event.stopPropagation()">
            <app-payment-modal [totalAmount]="getCartTotals().total" [isVisible]="showPaymentModal"
                (paymentComplete)="onPaymentComplete($event)" (paymentCancelled)="onPaymentCancelled()">
            </app-payment-modal>
        </div>
    </div>

    <!-- Product Registration Modal -->
    <div class="modal-overlay" *ngIf="showProductRegistrationModal" (click)="onProductRegistrationCancelled()">
        <div class="modal-content product-registration-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">
                    <mat-icon class="icon">add_shopping_cart</mat-icon>
                    Daftarkan Produk Baru
                </h3>
                <button class="close-btn" (click)="onProductRegistrationCancelled()" title="Tutup Modal">
                    <mat-icon class="icon">close</mat-icon>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="barcode-display">
                    <mat-icon class="barcode-icon">qr_code_scanner</mat-icon>
                    <div class="barcode-info">
                        <p class="barcode-label">Barcode yang dipindai:</p>
                        <p class="barcode-value">{{scannedBarcodeForRegistration}}</p>
                    </div>
                </div>

                <form #productForm="ngForm" (ngSubmit)="submitNewProduct(productForm)" class="product-form">
                    <!-- Product Name -->
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="productName" class="required">Nama Produk</label>
                            <input 
                                type="text" 
                                id="productName" 
                                name="productName"
                                [(ngModel)]="newProduct.name"
                                class="form-input" 
                                placeholder="Masukkan nama produk"
                                maxlength="200"
                                required>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-row full-width">
                        <div class="form-group">
                            <label for="productDescription">Deskripsi</label>
                            <textarea 
                                id="productDescription" 
                                name="productDescription"
                                [(ngModel)]="newProduct.description"
                                class="form-input form-textarea" 
                                placeholder="Deskripsi produk (opsional)"
                                rows="3"
                                maxlength="500"></textarea>
                        </div>
                    </div>

                    <!-- Pricing -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productBuyPrice" class="required">Harga Modal</label>
                            <input 
                                type="number" 
                                id="productBuyPrice" 
                                name="productBuyPrice"
                                [(ngModel)]="newProduct.buyPrice"
                                class="form-input" 
                                placeholder="0"
                                min="0"
                                step="0.01"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="productPrice" class="required">Harga Jual</label>
                            <input 
                                type="number" 
                                id="productPrice" 
                                name="productPrice"
                                [(ngModel)]="newProduct.sellPrice"
                                class="form-input" 
                                placeholder="0"
                                min="0"
                                step="0.01"
                                required>
                        </div>
                    </div>

                    <!-- Stock Information -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productStock" class="required">Stok Awal</label>
                            <input 
                                type="number" 
                                id="productStock" 
                                name="productStock"
                                [(ngModel)]="newProduct.stock"
                                class="form-input" 
                                placeholder="0"
                                min="0"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="productMinStock" class="required">Minimal Stok</label>
                            <input 
                                type="number" 
                                id="productMinStock" 
                                name="productMinStock"
                                [(ngModel)]="newProduct.minimumStock"
                                class="form-input" 
                                placeholder="5"
                                min="0"
                                required>
                        </div>
                    </div>

                    <!-- Category and Unit -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productCategory" class="required">Kategori</label>
                            <select 
                                id="productCategory" 
                                name="productCategory"
                                [(ngModel)]="newProduct.categoryId"
                                class="form-select"
                                required>
                                <option value="">Pilih Kategori</option>
                                <option *ngFor="let category of categories" [value]="category.id">
                                    {{category.name}}
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="productUnit" class="required">Satuan</label>
                            <input 
                                type="text" 
                                id="productUnit" 
                                name="productUnit"
                                [(ngModel)]="newProduct.unit"
                                class="form-input" 
                                placeholder="pcs, kg, liter, dll"
                                maxlength="20"
                                required>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="onProductRegistrationCancelled()">
                    <mat-icon class="icon">cancel</mat-icon>
                    Batal
                </button>
                <button type="submit" class="btn btn-primary" (click)="submitNewProduct(productForm)" [disabled]="!productForm.form.valid || isLoading">
                    <span *ngIf="!isLoading">
                        <mat-icon class="icon">add_shopping_cart</mat-icon>
                        Daftar & Tambah
                    </span>
                    <span *ngIf="isLoading">
                        <div class="spinner"></div>
                        Mendaftarkan...
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div class="shortcuts-help">
        <small>
            <strong>Shortcuts:</strong>
            F1: Scan | F2: Search | F9: Bayar | F12: Clear | ESC: Close
        </small>
    </div>
</div>