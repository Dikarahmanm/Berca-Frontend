<div class="receipt-preview-container">
  <!-- Receipt Header Configuration Panel -->
  <div class="receipt-header-config">
    <div class="config-header">
      <button class="btn btn-outline back-button" (click)="goBackToPOS()">
        ‚Üê Kembali ke POS
      </button>
      
      <h2 class="config-title">üìÑ Preview & Konfigurasi Struk</h2>

      <div class="quick-actions">
        <!-- Regular Receipt Actions -->
        <button 
          class="btn btn-primary" 
          (click)="printReceipt()" 
          [disabled]="!canPrint()">
          üñ®Ô∏è Print
        </button>
        <button 
          class="btn btn-outline" 
          (click)="downloadPDF()" 
          [disabled]="!canPrint()">
          üì• PDF
        </button>
        <button 
          class="btn btn-outline" 
          (click)="shareReceipt()" 
          [disabled]="!canPrint()">
          üì§ Share
        </button>

        <!-- Branch-Aware Receipt Actions -->
        <div class="action-divider"></div>
        <button 
          class="btn btn-branch" 
          (click)="printBranchReceipt()" 
          [disabled]="!canPrint()"
          title="Print dengan format branch-specific">
          üè¢ Branch Print
        </button>
        <button 
          class="btn btn-branch-outline" 
          (click)="downloadBranchPDF()" 
          [disabled]="!canPrint()"
          title="Download PDF dengan branding branch">
          üè™ Branch PDF
        </button>
      </div>
    </div>

    <!-- Receipt Header Settings -->
    <div class="header-settings">
      <div class="settings-grid">
        <!-- Store Information -->
        <div class="setting-group">
          <h3>Informasi Toko</h3>
          <div class="form-field">
            <label>Nama Toko</label>
            <input 
              type="text" 
              [value]="receiptHeader().storeName"
              (input)="updateReceiptHeader({ storeName: $any($event.target).value })"
              class="form-control">
          </div>
          <div class="form-field">
            <label>Alamat</label>
            <textarea 
              [value]="receiptHeader().storeAddress"
              (input)="updateReceiptHeader({ storeAddress: $any($event.target).value })"
              class="form-control" 
              rows="2"></textarea>
          </div>
          <div class="form-field">
            <label>Telepon</label>
            <input 
              type="text" 
              [value]="receiptHeader().storePhone"
              (input)="updateReceiptHeader({ storePhone: $any($event.target).value })"
              class="form-control">
          </div>
          <div class="form-field">
            <label>Email</label>
            <input 
              type="email" 
              [value]="receiptHeader().storeEmail || ''"
              (input)="updateReceiptHeader({ storeEmail: $any($event.target).value })"
              class="form-control">
          </div>
        </div>

        <!-- Display Options -->
        <div class="setting-group">
          <h3>Opsi Tampilan</h3>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input 
                type="checkbox" 
                [checked]="receiptHeader().showDateTime"
                (change)="updateReceiptHeader({ showDateTime: $any($event.target).checked })">
              <span>Tampilkan Tanggal & Waktu</span>
            </label>
            <label class="checkbox-item">
              <input 
                type="checkbox" 
                [checked]="receiptHeader().showTransactionNumber"
                (change)="updateReceiptHeader({ showTransactionNumber: $any($event.target).checked })">
              <span>Tampilkan No. Transaksi</span>
            </label>
            <label class="checkbox-item">
              <input 
                type="checkbox" 
                [checked]="receiptHeader().showCashier"
                (change)="updateReceiptHeader({ showCashier: $any($event.target).checked })">
              <span>Tampilkan Nama Kasir</span>
            </label>
          </div>

          <div class="form-field">
            <label>Theme Struk</label>
            <select 
              [value]="receiptHeader().theme"
              (change)="previewReceiptTheme($any($event.target).value)"
              class="form-control">
              <option value="classic">Classic</option>
              <option value="modern">Modern</option>
              <option value="minimal">Minimal</option>
            </select>
          </div>

          <div class="form-field">
            <label>Ukuran Font</label>
            <select 
              [value]="receiptHeader().fontSize"
              (change)="adjustReceiptFontSize($any($event.target).value)"
              class="form-control">
              <option value="small">Kecil</option>
              <option value="medium">Sedang</option>
              <option value="large">Besar</option>
            </select>
          </div>
        </div>

        <!-- Print Options -->
        <div class="setting-group">
          <h3>Opsi Cetak</h3>
          <div class="form-field">
            <label>Jumlah Salinan</label>
            <input 
              type="number" 
              min="1" 
              max="5"
              [value]="printOptions().copies"
              (input)="updatePrintOptions({ copies: +$any($event.target).value })"
              class="form-control">
          </div>
          
          <div class="form-field">
            <label>Ukuran Kertas</label>
            <select 
              [value]="printOptions().paperSize"
              (change)="updatePrintOptions({ paperSize: $any($event.target).value })"
              class="form-control">
              <option value="58mm">58mm (Thermal)</option>
              <option value="80mm">80mm (Thermal)</option>
              <option value="A4">A4 (Laser)</option>
            </select>
          </div>

          <div class="checkbox-group">
            <label class="checkbox-item">
              <input 
                type="checkbox" 
                [checked]="printOptions().includeFooter"
                (change)="updatePrintOptions({ includeFooter: $any($event.target).checked })">
              <span>Sertakan Footer</span>
            </label>
            <label class="checkbox-item">
              <input 
                type="checkbox" 
                [checked]="printOptions().includeQR"
                (change)="updatePrintOptions({ includeQR: $any($event.target).checked })">
              <span>Sertakan QR Code</span>
            </label>
          </div>

          <button class="btn btn-outline btn-sm" (click)="resetReceiptHeader()">
            üîÑ Reset ke Default
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <h3>Memuat data transaksi...</h3>
    <p>Mohon tunggu sebentar</p>
  </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
  <div class="error-container">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Gagal Memuat Struk</h3>
    <p>{{ error() }}</p>
    <button class="btn btn-primary" (click)="retryLoadSale()">
      üîÑ Coba Lagi
    </button>
  </div>
  }

  <!-- Receipt Preview -->
  @if (sale() && !loading() && !error()) {
  <div class="receipt-preview" [class]="receiptThemeClass()">
    <div class="receipt-paper">
      <!-- Enhanced Store Header -->
      <div class="store-header">
        @if (receiptHeader().logoUrl) {
        <div class="store-logo">
          <img [src]="receiptHeader().logoUrl" [alt]="receiptHeader().storeName">
        </div>
        }
        
        <h1 class="store-name">{{ receiptHeader().storeName }}</h1>
        <p class="store-address">{{ receiptHeader().storeAddress }}</p>
        <p class="store-contact">{{ receiptHeader().storePhone }}</p>
        
        @if (receiptHeader().storeEmail) {
        <p class="store-email">{{ receiptHeader().storeEmail }}</p>
        }
      </div>

      <!-- Divider -->
      <div class="divider">================================</div>

      <!-- Transaction Info -->
      <div class="transaction-info">
        @if (receiptHeader().showTransactionNumber) {
        <div class="info-row">
          <span class="label">No. Transaksi:</span>
          <span class="value">{{ sale()!.saleNumber || 'N/A' }}</span>
        </div>
        }
        
        @if (receiptHeader().showDateTime) {
        <div class="info-row">
          <span class="label">Tanggal:</span>
          <span class="value">{{ sale()!.saleDate ? formatDate(sale()!.saleDate!) : 'N/A' }}</span>
        </div>
        <div class="info-row">
          <span class="label">Waktu:</span>
          <span class="value">{{ sale()!.saleDate ? formatTime(sale()!.saleDate!) : 'N/A' }}</span>
        </div>
        }
        
        @if (receiptHeader().showCashier) {
        <div class="info-row">
          <span class="label">Kasir:</span>
          <span class="value">{{ sale()!.cashierName || 'N/A' }}</span>
        </div>
        }
        
        @if (sale()!.customerName) {
        <div class="info-row">
          <span class="label">Pelanggan:</span>
          <span class="value">{{ sale()!.customerName }}</span>
        </div>
        }
        
        @if (sale()!.memberName) {
        <div class="info-row">
          <span class="label">Member:</span>
          <span class="value">{{ sale()!.memberName }} ({{ sale()!.memberNumber }})</span>
        </div>
        }
      </div>

      <!-- Divider -->
      <div class="divider">================================</div>

      <!-- Items Section -->
      <div class="items-section">
        <div class="items-header">
          <span class="col-name">Item</span>
          <span class="col-qty">Qty</span>
          <span class="col-price">Harga</span>
          <span class="col-total">Total</span>
        </div>

        @for (item of sale()!.items; track trackByItem($index, item)) {
        <div class="item-row">
          <div class="item-main">
            <span class="item-name">{{ item.productName || 'Unknown Product' }}</span>
            <span class="item-qty">{{ getItemQuantity(item) }}</span>
            <span class="item-price">{{ formatCurrency(getItemPrice(item)) }}</span>
            <span class="item-total">{{ formatCurrency(getItemSubtotal(item)) }}</span>
          </div>

          @if (getItemDiscount(item) > 0) {
          <div class="item-details">
            <span class="discount-info">
              Diskon {{ getItemDiscount(item) }}%
            </span>
          </div>
          }
        </div>
        }

        @if (!sale()!.items || sale()!.items.length === 0) {
        <div class="no-items">
          <p>Tidak ada item ditemukan dalam transaksi ini</p>
        </div>
        }
      </div>

      <!-- Divider -->
      <div class="divider">================================</div>

      <!-- Summary Section -->
      <div class="summary-section">
        <div class="summary-row">
          <span class="label">Subtotal ({{ getTotalItems() }} item):</span>
          <span class="value">{{ formatCurrency(sale()!.subtotal) }}</span>
        </div>

        @if (toNumber(sale()!.discountAmount) > 0) {
        <div class="summary-row">
          <span class="label">Diskon:</span>
          <span class="value">-{{ formatCurrency(sale()!.discountAmount) }}</span>
        </div>
        }

        <div class="summary-row total-row">
          <span class="label">TOTAL:</span>
          <span class="value">{{ formatCurrency(sale()!.total) }}</span>
        </div>
      </div>

      <!-- Divider -->
      <div class="divider">================================</div>

      <!-- Payment Info -->
      <div class="payment-section">
        <div class="payment-row">
          <span class="label">Metode Bayar:</span>
          <span class="value">{{ getPaymentMethodLabel(sale()!.paymentMethod) }}</span>
        </div>
        <div class="payment-row">
          <span class="label">Jumlah Bayar:</span>
          <span class="value">{{ formatCurrency(sale()!.amountPaid) }}</span>
        </div>
        
        @if (toNumber(sale()!.changeAmount) > 0) {
        <div class="payment-row">
          <span class="label">Kembalian:</span>
          <span class="value">{{ formatCurrency(sale()!.changeAmount) }}</span>
        </div>
        }
        
        @if (sale()!.paymentReference) {
        <div class="payment-row">
          <span class="label">Ref. Number:</span>
          <span class="value">{{ sale()!.paymentReference }}</span>
        </div>
        }
      </div>

      <!-- Loyalty Points -->
      @if (sale()!.memberId) {
      <div class="loyalty-section">
        <div class="divider">================================</div>
        <div class="loyalty-info">
          @if (getPointsEarned() > 0) {
          <div class="points-earned">
            <span class="label">Poin Diperoleh:</span>
            <span class="value">+{{ getPointsEarned() }} poin</span>
          </div>
          }
          
          @if (toNumber(sale()!.redeemedPoints) > 0) {
          <div class="points-redeemed">
            <span class="label">Poin Digunakan:</span>
            <span class="value">-{{ sale()!.redeemedPoints }} poin</span>
          </div>
          }
        </div>
      </div>
      }

      <!-- Enhanced Footer -->
      @if (printOptions().includeFooter) {
      <div class="receipt-footer">
        <div class="divider">================================</div>
        <p class="thank-you">{{ receiptHeader().footerMessage }}</p>
        <p class="footer-note">Barang yang sudah dibeli tidak dapat dikembalikan</p>

        @if (printOptions().includeQR && digitalReceiptUrl()) {
        <div class="qr-section">
          <p class="qr-label">Scan untuk struk digital:</p>
          <div class="qr-placeholder">
            <span class="qr-text">QR Code</span>
            <small>{{ digitalReceiptUrl() }}</small>
          </div>
        </div>
        }
      </div>
      }
    </div>
  </div>
  }

  <!-- Success Message -->
  @if (successMessage()) {
  <div class="success-message">
    <span class="success-icon">‚úÖ</span>
    {{ successMessage() }}
  </div>
  }
</div>