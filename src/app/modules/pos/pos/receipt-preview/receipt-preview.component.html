<!-- âœ… CLEAN VERSION: src/app/modules/pos/pos/receipt-preview/receipt-preview.component.html -->

<div class="receipt-preview">
    <!-- Header -->
    <div class="receipt-header">
        <button class="back-btn" (click)="goBackToPOS()">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
            </svg>
            Kembali ke POS
        </button>

        <h2 class="receipt-title">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M3,22L4.5,20.5L6,22L7.5,20.5L9,22L10.5,20.5L12,22L13.5,20.5L15,22L16.5,20.5L18,22L19.5,20.5L21,22V2L19.5,3.5L18,2L16.5,3.5L15,2L13.5,3.5L12,2L10.5,3.5L9,2L7.5,3.5L6,2L4.5,3.5L3,2V22M5,5H19V7H5V5M5,9H19V11H5V9M5,13H19V15H5V13M5,17H19V19H5V17Z" />
            </svg>
            Struk Pembelian
        </h2>

        <div class="receipt-actions">
            <button class="action-btn" (click)="printReceipt()" [disabled]="isLoading || !sale">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M18,3H6V7H18M19,12A1,1 0 0,1 18,11A1,1 0 0,1 19,10A1,1 0 0,1 20,11A1,1 0 0,1 19,12M16,19H8V14H16M19,8H5A3,3 0 0,0 2,11V17H6V21H18V17H22V11A3,3 0 0,0 19,8Z" />
                </svg>
                Print
            </button>

            <button class="action-btn" (click)="downloadPDF()" [disabled]="isLoading || !sale">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                </svg>
                Download PDF
            </button>

            <button class="action-btn share-btn" (click)="shareReceipt()" [disabled]="isLoading || !sale">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L15.96,7.19C16.5,7.69 17.21,8 18,8A3,3 0 0,0 21,5A3,3 0 0,0 18,2A3,3 0 0,0 15,5C15,5.24 15.04,5.47 15.09,5.7L8.04,9.81C7.5,9.31 6.79,9 6,9A3,3 0 0,0 3,12A3,3 0 0,0 6,15C6.79,15 7.5,14.69 8.04,14.19L15.16,18.34C15.11,18.55 15.08,18.77 15.08,19C15.08,20.61 16.39,21.91 18,21.91C19.61,21.91 20.92,20.61 20.92,19A2,2 0 0,0 18.92,17A2,2 0 0,0 16.92,19C16.92,18.77 16.95,18.55 17,18.34L9.88,14.19C9.56,14.69 9,15 8.32,15C7.65,15 7.09,14.69 6.77,14.19L13.91,10.3C13.96,10.53 14,10.76 14,11C14,11.24 13.96,11.47 13.91,11.7L6.96,15.81C6.5,15.31 5.79,15 5,15A3,3 0 0,0 2,18A3,3 0 0,0 5,21C5.79,21 6.5,20.69 7.04,20.19L14.16,16.34C14.11,16.55 14.08,16.77 14.08,17C14.08,18.61 15.39,19.91 17,19.91C18.61,19.91 19.92,18.61 19.92,17A2,2 0 0,0 17.92,15A2,2 0 0,0 15.92,17" />
                </svg>
                Share
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
        <div class="spinner-container">
            <svg class="spinner" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-dasharray="31.416" stroke-dashoffset="31.416">
                    <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416"
                        repeatCount="indefinite" />
                    <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416"
                        repeatCount="indefinite" />
                </circle>
            </svg>
            <span>Memuat struk...</span>
        </div>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="errorMessage && !isLoading">
        <div class="error-content">
            <svg class="error-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z" />
            </svg>
            <h3>Gagal Memuat Struk</h3>
            <p>{{errorMessage}}</p>
            <button class="retry-btn" (click)="loadSale()">Coba Lagi</button>
        </div>
    </div>

    <!-- Receipt Content -->
    <div class="receipt-content" *ngIf="sale && !isLoading">
        <div class="receipt-paper">
            <!-- Store Header -->
            <div class="store-header">
                <h1 class="store-name">{{storeInfo.storeName}}</h1>
                <p class="store-address">{{storeInfo.storeAddress}}</p>
                <p class="store-contact">{{storeInfo.storePhone}}</p>
                <p class="store-email" *ngIf="storeInfo.storeEmail">{{storeInfo.storeEmail}}</p>
            </div>

            <!-- Divider -->
            <div class="divider">================================</div>

            <!-- Transaction Info -->
            <div class="transaction-info">
                <div class="info-row">
                    <span class="label">No. Transaksi:</span>
                    <span class="value">{{sale.saleNumber || 'N/A'}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Tanggal:</span>
                    <span class="value">{{formatDate(sale.saleDate)}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Waktu:</span>
                    <span class="value">{{formatTime(sale.saleDate)}}</span>
                </div>
                <div class="info-row">
                    <span class="label">Kasir:</span>
                    <span class="value">{{sale.cashierName || 'N/A'}}</span>
                </div>
                <div class="info-row" *ngIf="sale.customerName">
                    <span class="label">Pelanggan:</span>
                    <span class="value">{{sale.customerName}}</span>
                </div>
                <div class="info-row" *ngIf="sale.memberName">
                    <span class="label">Member:</span>
                    <span class="value">{{sale.memberName}} ({{sale.memberNumber}})</span>
                </div>
            </div>

            <!-- Divider -->
            <div class="divider">================================</div>

            <!-- Items -->
            <div class="items-section">
                <div class="items-header">
                    <span class="col-name">Item</span>
                    <span class="col-qty">Qty</span>
                    <span class="col-price">Harga</span>
                    <span class="col-total">Total</span>
                </div>

                <!-- Items List -->
                <div class="item-row" *ngFor="let item of sale.items; let i = index">
                    <div class="item-main">
                        <span class="item-name">{{item.productName || 'Unknown Product'}}</span>
                        <span class="item-qty">{{getItemQuantity(item)}}</span>
                        <span class="item-price">{{formatCurrency(getItemPrice(item))}}</span>
                        <span class="item-total">{{formatCurrency(getItemSubtotal(item))}}</span>
                    </div>

                    <!-- Discount Info -->
                    <div class="item-details" *ngIf="getItemDiscount(item) > 0">
                        <span class="discount-info">
                            Diskon {{getItemDiscount(item)}}%
                        </span>
                    </div>
                </div>

                <!-- No Items Found -->
                <div class="no-items" *ngIf="!sale.items || sale.items.length === 0">
                    <p>Tidak ada item ditemukan dalam transaksi ini</p>
                </div>
            </div>

            <!-- Divider -->
            <div class="divider">================================</div>

            <!-- Summary -->
            <div class="summary-section">
                <div class="summary-row">
                    <span class="label">Subtotal ({{getTotalItems()}} item):</span>
                    <span class="value">{{formatCurrency(sale.subtotal)}}</span>
                </div>

                <div class="summary-row" *ngIf="toNumber(sale.discountAmount) > 0">
                    <span class="label">Diskon:</span>
                    <span class="value">-{{formatCurrency(sale.discountAmount)}}</span>
                </div>

                <div class="summary-row" *ngIf="toNumber(sale.taxAmount) > 0">
                    <span class="label">PPN (11%):</span>
                    <span class="value">{{formatCurrency(sale.taxAmount)}}</span>
                </div>

                <div class="summary-row total-row">
                    <span class="label">TOTAL:</span>
                    <span class="value">{{formatCurrency(sale.total)}}</span>
                </div>
            </div>

            <!-- Divider -->
            <div class="divider">================================</div>

            <!-- Payment Info -->
            <div class="payment-section">
                <div class="payment-row">
                    <span class="label">Metode Bayar:</span>
                    <span class="value">{{getPaymentMethodLabel(sale.paymentMethod)}}</span>
                </div>

                <div class="payment-row">
                    <span class="label">Jumlah Bayar:</span>
                    <span class="value">{{formatCurrency(sale.amountPaid)}}</span>
                </div>

                <div class="payment-row" *ngIf="toNumber(sale.changeAmount) > 0">
                    <span class="label">Kembalian:</span>
                    <span class="value">{{formatCurrency(sale.changeAmount)}}</span>
                </div>

                <div class="payment-row" *ngIf="sale.paymentReference">
                    <span class="label">Ref. Number:</span>
                    <span class="value">{{sale.paymentReference}}</span>
                </div>
            </div>

            <!-- Loyalty Points -->
            <div class="loyalty-section" *ngIf="sale.memberId">
                <div class="divider">================================</div>
                <div class="loyalty-info">
                    <div class="points-earned" *ngIf="getPointsEarned() > 0">
                        <span class="label">Poin Diperoleh:</span>
                        <span class="value">+{{getPointsEarned()}} poin</span>
                    </div>
                    <div class="points-redeemed" *ngIf="toNumber(sale.redeemedPoints) > 0">
                        <span class="label">Poin Digunakan:</span>
                        <span class="value">-{{sale.redeemedPoints}} poin</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="receipt-footer">
                <div class="divider">================================</div>
                <p class="footer-message">{{storeInfo.footerMessage}}</p>
                <p class="thank-you">Terima kasih atas kunjungan Anda!</p>
                <p class="footer-note">Barang yang sudah dibeli tidak dapat dikembalikan</p>

                <!-- QR Code for digital receipt -->
                <div class="qr-section" *ngIf="digitalReceiptUrl">
                    <p class="qr-label">Scan untuk struk digital:</p>
                    <div class="qr-placeholder">
                        <span class="qr-text">QR Code</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div class="success-message" *ngIf="successMessage">
        <svg class="success-icon" viewBox="0 0 24 24" fill="currentColor">
            <path
                d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.08L11,13.67L7.91,10.58L6.5,12L11,16.5Z" />
        </svg>
        {{successMessage}}
    </div>
</div>