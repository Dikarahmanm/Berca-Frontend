<div class="transaction-detail-container">
  <!-- Loading State -->
  @if (loading()) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <h3>Memuat Detail Transaksi</h3>
    <p>Mengambil informasi transaksi...</p>
  </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
  <div class="error-container">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Terjadi Kesalahan</h3>
    <p>{{ error() }}</p>
    <button class="btn btn-primary" (click)="goBack()">
      ‚Üê Kembali ke POS
    </button>
  </div>
  }

  <!-- Transaction Detail Content -->
  @if (transaction() && !loading() && !error()) {
  <div class="detail-content">
    <!-- Header -->
    <div class="detail-header">
      <div class="header-left">
        <button class="btn btn-outline back-button" (click)="goBack()">
          ‚Üê Kembali
        </button>
        <div class="header-info">
          <h1>Detail Transaksi</h1>
          <p class="transaction-number">{{ transaction()!.saleNumber }}</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary print-button" (click)="onPrintReceipt()">
          üßæ Lihat Receipt
        </button>
      </div>
    </div>

    <!-- Status Section -->
    <div class="status-section">
      @let statusInfo = getStatusInfo(transaction()!.status);
      <div class="status-badge status-{{ statusInfo.color }}">
        <span class="status-icon">{{ statusInfo.icon }}</span>
        <span class="status-text">{{ statusInfo.text }}</span>
      </div>
      
      <!-- Credit transactions now use existing validation workflow -->
      
      @if (transaction()!.receiptPrinted) {
      <div class="status-badge status-info">
        <span class="status-icon">üñ®Ô∏è</span>
        <span class="status-text">Receipt Printed</span>
      </div>
      }
    </div>

    <!-- Manager approval now handled in payment modal using existing credit validation workflow -->

    <!-- Information Cards Grid -->
    <div class="info-grid">
      <!-- Basic Transaction Info -->
      <div class="card">
        <div class="card-header">
          <h3>Informasi Transaksi</h3>
        </div>
        <div class="card-content">
          <div class="info-list">
            <div class="info-item">
              <span class="label">Tanggal & Waktu:</span>
              <span class="value">{{ formatDate(transaction()!.saleDate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">Kasir:</span>
              <span class="value">{{ transaction()!.cashierName }}</span>
            </div>
            @if (transaction()!.customerName) {
            <div class="info-item">
              <span class="label">Customer:</span>
              <span class="value">{{ transaction()!.customerName }}</span>
            </div>
            }
            @if (transaction()!.memberName) {
            <div class="info-item">
              <span class="label">Member:</span>
              <span class="value">{{ transaction()!.memberName }} ({{ transaction()!.memberNumber }})</span>
            </div>
            }
            <div class="info-item">
              <span class="label">Metode Pembayaran:</span>
              <span class="value">{{ transaction()!.paymentMethod }}</span>
            </div>
            @if (transaction()!.paymentReference) {
            <div class="info-item">
              <span class="label">Referensi:</span>
              <span class="value">{{ transaction()!.paymentReference }}</span>
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Financial Summary -->
      <div class="card">
        <div class="card-header">
          <h3>Ringkasan Keuangan</h3>
        </div>
        <div class="card-content">
          <div class="info-list">
            <div class="info-item">
              <span class="label">Subtotal:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.subtotal) }}</span>
            </div>
            @if (totalDiscountAmount() > 0 || transaction()!.discountAmount > 0) {
            <div class="info-item discount">
              <span class="label">Total Diskon:</span>
              <span class="value currency">-{{ formatCurrency((totalDiscountAmount() + (transaction()!.discountAmount || 0))) }}</span>
            </div>
            <div class="info-item">
              <span class="label">% Diskon:</span>
              <span class="value secondary">{{ effectiveDiscountPercentage() | number:'1.1-1' }}%</span>
            </div>
            }
            @if (transaction()!.taxAmount > 0) {
            <div class="info-item">
              <span class="label">Pajak:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.taxAmount) }}</span>
            </div>
            }
            <div class="info-item total">
              <span class="label">Total:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.total) }}</span>
            </div>
            @if (transaction()!.amountPaid !== transaction()!.total) {
            <div class="info-item">
              <span class="label">Dibayar:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.amountPaid) }}</span>
            </div>
            <div class="info-item">
              <span class="label">Kembalian:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.changeAmount) }}</span>
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Profit Analysis -->
      @if (financialSummary()) {
      <div class="card profit-card">
        <div class="card-header">
          <h3>Analisis Keuntungan</h3>
        </div>
        <div class="card-content">
          <div class="info-list">
            <div class="info-item">
              <span class="label">HPP (Cost of Goods):</span>
              <span class="value currency">{{ formatCurrency(totalItemCost()) }}</span>
            </div>
            <div class="info-item profit">
              <span class="label">Keuntungan Kotor:</span>
              <span class="value currency profit-amount">{{ formatCurrency(totalProfit()) }}</span>
            </div>
            <div class="info-item">
              <span class="label">Margin Keuntungan:</span>
              <span class="value profit">{{ financialSummary()!.grossMargin | number:'1.1-1' }}%</span>
            </div>
            <div class="info-item">
              <span class="label">ROI (Return on Sales):</span>
              <span class="value">{{ financialSummary()!.returnOnSales | number:'1.1-1' }}%</span>
            </div>
            <div class="info-item">
              <span class="label">Net Margin:</span>
              <span class="value">{{ financialSummary()!.netMargin | number:'1.1-1' }}%</span>
            </div>
          </div>
        </div>
      </div>
      }
    </div>

    <!-- Items Detail -->
    <div class="card items-card">
      <div class="card-header">
        <h3>Detail Item ({{ transaction()!.items.length }})</h3>
      </div>
      
      <!-- Mobile Card View -->
      <div class="mobile-view">
        @for (item of profitPerItem(); track trackByItem($index, item)) {
        <div class="item-card">
          <div class="item-header">
            <div class="product-info">
              <h4 class="product-name">{{ item.productName }}</h4>
              @if (item.productBarcode) {
              <p class="product-barcode">{{ item.productBarcode }}</p>
              }
              @if (item.notes) {
              <p class="product-notes">{{ item.notes }}</p>
              }
              <!-- Profit indicator -->
              @if (item.profitPercentage > 0) {
              <div class="profit-indicator">
                <span class="profit-badge">{{ item.profitPercentage | number:'1.0-0' }}% profit</span>
              </div>
              }
            </div>
            <div class="item-quantity">
              <span class="qty">{{ item.quantity }}</span>
              <span class="unit">{{ item.unit }}</span>
            </div>
          </div>
          <div class="item-details">
            <div class="price-info">
              <div class="price-row">
                <span class="label">Harga Jual:</span>
                <span class="value">{{ formatCurrency(item.unitPrice) }}</span>
              </div>
              @if (item.unitCost > 0) {
              <div class="price-row">
                <span class="label">HPP:</span>
                <span class="value secondary">{{ formatCurrency(item.unitCost) }}</span>
              </div>
              <div class="price-row">
                <span class="label">Cost Ratio:</span>
                <span class="value secondary">{{ item.costRatio | number:'1.0-0' }}%</span>
              </div>
              }
              @if (item.discountAmount > 0) {
              <div class="price-row">
                <span class="label">Diskon Item:</span>
                <span class="value discount">-{{ formatCurrency(item.discountAmount) }}</span>
              </div>
              <div class="price-row">
                <span class="label">Harga Efektif:</span>
                <span class="value">{{ formatCurrency(item.effectivePrice) }}</span>
              </div>
              }
            </div>
            <div class="subtotal-info">
              <div class="subtotal-row total">
                <span class="label">Subtotal:</span>
                <span class="value">{{ formatCurrency(item.subtotal) }}</span>
              </div>
              @if (item.totalProfit > 0) {
              <div class="subtotal-row">
                <span class="label">Keuntungan:</span>
                <span class="value profit">{{ formatCurrency(item.totalProfit) }}</span>
              </div>
              <div class="subtotal-row">
                <span class="label">Margin Item:</span>
                <span class="value profit">{{ item.profitPercentage | number:'1.1-1' }}%</span>
              </div>
              }
            </div>
          </div>
        </div>
        }
      </div>

      <!-- Desktop Table View -->
      <div class="desktop-view">
        <table class="items-table">
          <thead>
            <tr>
              <th>Produk</th>
              <th style="width: 80px;">Qty</th>
              <th style="width: 120px;">Harga</th>
              <th style="width: 100px;">Diskon</th>
              <th style="width: 120px;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            @for (item of transaction()!.items; track trackByItem($index, item)) {
            <tr>
              <td class="product-cell">
                <div class="product-name">{{ item.productName }}</div>
                @if (item.productBarcode) {
                <div class="product-barcode">{{ item.productBarcode }}</div>
                }
                @if (item.notes) {
                <div class="product-notes">{{ item.notes }}</div>
                }
              </td>
              <td class="qty-cell">
                <span class="qty">{{ item.quantity }}</span>
                <span class="unit">{{ item.unit }}</span>
              </td>
              <td class="price-cell">
                <div class="selling-price">{{ formatCurrency(item.unitPrice) }}</div>
                @if (item.unitCost) {
                <div class="cost-price">Cost: {{ formatCurrency(item.unitCost) }}</div>
                }
                @if (item.discountAmount > 0) {
                <div class="discount-info">-{{ formatCurrency(item.discountAmount) }}</div>
                }
              </td>
              <td class="price-cell">
                @if (item.discountAmount > 0) {
                <span class="discount-info">-{{ formatCurrency(item.discountAmount) }}</span>
                } @else {
                <span class="no-discount">-</span>
                }
              </td>
              <td class="subtotal-cell">
                <div class="subtotal">{{ formatCurrency(item.subtotal) }}</div>
                @if (item.totalProfit) {
                <div class="profit">Profit: {{ formatCurrency(item.totalProfit) }}</div>
                }
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

  </div>
  }
</div>