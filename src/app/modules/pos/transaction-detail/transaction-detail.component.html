<div class="transaction-detail-container">
  <!-- Loading State -->
  @if (loading()) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <h3>Memuat Detail Transaksi</h3>
    <p>Mengambil informasi transaksi...</p>
  </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
  <div class="error-container">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Terjadi Kesalahan</h3>
    <p>{{ error() }}</p>
    <button class="btn btn-primary" (click)="goBack()">
      ‚Üê Kembali ke POS
    </button>
  </div>
  }

  <!-- Transaction Detail Content -->
  @if (transaction() && !loading() && !error()) {
  <div class="detail-content">
    <!-- Header -->
    <div class="detail-header">
      <div class="header-left">
        <button class="btn btn-outline back-button" (click)="goBack()">
          ‚Üê Kembali
        </button>
        <div class="header-info">
          <h1>Detail Transaksi</h1>
          <p class="transaction-number">{{ transaction()!.saleNumber }}</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary print-button" (click)="onPrintReceipt()">
          üßæ Lihat Receipt
        </button>
      </div>
    </div>

    <!-- Status Section -->
    <div class="status-section">
      @let statusInfo = getStatusInfo(transaction()!.status);
      <div class="status-badge status-{{ statusInfo.color }}">
        <span class="status-icon">{{ statusInfo.icon }}</span>
        <span class="status-text">{{ statusInfo.text }}</span>
      </div>
      
      <!-- Credit transactions now use existing validation workflow -->
      
      @if (transaction()!.receiptPrinted) {
      <div class="status-badge status-info">
        <span class="status-icon">üñ®Ô∏è</span>
        <span class="status-text">Receipt Printed</span>
      </div>
      }
    </div>

    <!-- Manager approval now handled in payment modal using existing credit validation workflow -->

    <!-- Information Cards Grid -->
    <div class="info-grid">
      <!-- Basic Transaction Info -->
      <div class="card">
        <div class="card-header">
          <h3>Informasi Transaksi</h3>
        </div>
        <div class="card-content">
          <div class="info-list">
            <div class="info-item">
              <span class="label">Tanggal & Waktu:</span>
              <span class="value">{{ formatDate(transaction()!.saleDate) }}</span>
            </div>
            <div class="info-item">
              <span class="label">Kasir:</span>
              <span class="value">{{ transaction()!.cashierName }}</span>
            </div>
            @if (transaction()!.customerName) {
            <div class="info-item">
              <span class="label">Customer:</span>
              <span class="value">{{ transaction()!.customerName }}</span>
            </div>
            }
            @if (transaction()!.memberName) {
            <div class="info-item">
              <span class="label">Member:</span>
              <span class="value">{{ transaction()!.memberName }} ({{ transaction()!.memberNumber }})</span>
            </div>
            }
            <div class="info-item">
              <span class="label">Metode Pembayaran:</span>
              <span class="value">{{ transaction()!.paymentMethod }}</span>
            </div>
            @if (transaction()!.paymentReference) {
            <div class="info-item">
              <span class="label">Referensi:</span>
              <span class="value">{{ transaction()!.paymentReference }}</span>
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Financial Summary -->
      <div class="card">
        <div class="card-header">
          <h3>Ringkasan Keuangan</h3>
        </div>
        <div class="card-content">
          <div class="info-list">
            <div class="info-item">
              <span class="label">Subtotal:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.subtotal) }}</span>
            </div>
            @if (transaction()!.discountAmount > 0) {
            <div class="info-item discount">
              <span class="label">Diskon:</span>
              <span class="value currency">-{{ formatCurrency(transaction()!.discountAmount) }}</span>
            </div>
            }
            @if (transaction()!.taxAmount > 0) {
            <div class="info-item">
              <span class="label">Pajak:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.taxAmount) }}</span>
            </div>
            }
            <div class="info-item total">
              <span class="label">Total:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.total) }}</span>
            </div>
            @if (transaction()!.amountPaid !== transaction()!.total) {
            <div class="info-item">
              <span class="label">Dibayar:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.amountPaid) }}</span>
            </div>
            <div class="info-item">
              <span class="label">Kembalian:</span>
              <span class="value currency">{{ formatCurrency(transaction()!.changeAmount) }}</span>
            </div>
            }
            @if (totalProfit() !== 0) {
            <div class="info-item profit">
              <span class="label">Keuntungan:</span>
              <span class="value currency profit-amount">{{ formatCurrency(totalProfit()) }}</span>
            </div>
            <div class="info-item">
              <span class="label">Margin:</span>
              <span class="value">{{ profitMargin() | number:'1.1-1' }}%</span>
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Items Detail -->
    <div class="card items-card">
      <div class="card-header">
        <h3>Detail Item ({{ transaction()!.items.length }})</h3>
      </div>
      <div class="card-content">
        <div class="items-table">
          <div class="table-header">
            <div class="col-name">Produk</div>
            <div class="col-quantity">Qty</div>
            <div class="col-price">Harga</div>
            <div class="col-discount">Diskon</div>
            <div class="col-subtotal">Subtotal</div>
          </div>
          
          @for (item of transaction()!.items; track trackByItem($index, item)) {
          <div class="table-row">
            <div class="col-name">
              <div class="product-info">
                <span class="product-name">{{ item.productName }}</span>
                @if (item.productBarcode) {
                <span class="product-code">{{ item.productBarcode }}</span>
                }
              </div>
            </div>
            <div class="col-quantity">
              <span class="quantity-badge">{{ item.quantity }}</span>
            </div>
            <div class="col-price">
              <span class="price">{{ formatCurrency(item.unitPrice) }}</span>
            </div>
            <div class="col-discount">
              @if (item.discountAmount > 0) {
              <span class="discount-amount">-{{ formatCurrency(item.discountAmount) }}</span>
              } @else {
              <span class="no-discount">-</span>
              }
            </div>
            <div class="col-subtotal">
              <span class="subtotal">{{ formatCurrency(item.subtotal) }}</span>
            </div>
          </div>
          }
        </div>
      </div>
    </div>

  </div>
  }
</div>