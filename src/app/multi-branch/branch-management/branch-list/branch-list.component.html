<div class="multi-branch-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>store</mat-icon>
        Branch Management
        <span class="realtime-indicator" [class.active]="!isLoading()">
          <span class="indicator-dot"></span>
          {{ isLoading() ? 'Updating' : 'Live' }}
        </span>
      </h1>
      <div class="subtitle-stats">
        <span class="stat-chip branches" *ngIf="branchStats()">{{ branchStats()!.total }} Branches</span>
        <span class="stat-chip active" *ngIf="branchStats() && branchStats()!.active > 0">{{ branchStats()!.active }} Active</span>
        <span class="stat-chip transfers" *ngIf="branchStats() && branchStats()!.pending > 0">{{ branchStats()!.pending }} Pending</span>
      </div>
    </div>

    <div class="header-actions">
      <button class="btn btn-primary" (click)="createNewBranch()">
        <mat-icon>add</mat-icon>
        Add New Branch
      </button>
      
      <button class="btn btn-secondary" (click)="exportBranches()" [disabled]="isLoading()">
        <mat-icon>download</mat-icon>
        <span class="hide-mobile">Export</span>
      </button>
      
      <button class="btn btn-outline" (click)="refreshBranches()" [disabled]="isLoading()">
        <mat-icon [class.spinning]="isLoading()">refresh</mat-icon>
        <span class="hide-mobile">Refresh</span>
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-cards" *ngIf="branchStats()">
    <div class="stat-card total-branches">
      <div class="stat-icon">
        <mat-icon>store</mat-icon>
      </div>
      <div class="stat-value">{{ branchStats()!.total }}</div>
      <p class="stat-label">Total Branches</p>
      <div class="stat-change positive" *ngIf="branchStats()!.active > 0">
        {{ branchStats()!.active }} currently active
      </div>
    </div>

    <div class="stat-card active-transfers">
      <div class="stat-icon">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="stat-value">{{ branchStats()!.active }}</div>
      <p class="stat-label">Active Branches</p>
      <div class="stat-change" [class.positive]="branchStats()!.inactive === 0" [class.negative]="branchStats()!.inactive > 0">
        {{ branchStats()!.inactive }} inactive
      </div>
    </div>

    <div class="stat-card pending-approvals">
      <div class="stat-icon">
        <mat-icon>pending</mat-icon>
      </div>
      <div class="stat-value">{{ branchStats()!.pending }}</div>
      <p class="stat-label">Pending Setup</p>
      <div class="stat-change" [class.positive]="branchStats()!.pending === 0" [class.negative]="branchStats()!.pending > 0">
        {{ branchStats()!.pending === 0 ? 'All configured' : 'Needs attention' }}
      </div>
    </div>

    <div class="stat-card system-alerts">
      <div class="stat-icon">
        <mat-icon>location_on</mat-icon>
      </div>
      <div class="stat-value">{{ getBranchRegions() }}</div>
      <p class="stat-label">Regions</p>
      <div class="stat-change positive">
        Geographic coverage
      </div>
    </div>
  </div>

  <!-- Filters and Controls -->
  <div class="controls-section">
    <div class="filters-row">
      <!-- Search -->
      <div class="search-box">
        <i class="icon-search"></i>
        <input 
          type="text"
          placeholder="Search branches, managers, or addresses..."
          [value]="filters().search"
          (input)="onSearchInput($event)"
        />
      </div>
      
      <!-- Status Filter -->
      <div class="filter-group">
        <label>Status:</label>
        <select 
          [value]="filters().status"
          (change)="updateFilters({ status: $any($event.target).value })"
        >
          <option value="all">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="pending">Pending</option>
          <option value="suspended">Suspended</option>
        </select>
      </div>
      
      <!-- Region Filter -->
      <div class="filter-group">
        <label>Region:</label>
        <select 
          [value]="filters().region"
          (change)="updateFilters({ region: $any($event.target).value })"
        >
          <option value="">All Regions</option>
          <option 
            *ngFor="let region of availableRegions()"
            [value]="region"
          >
            {{ region }}
          </option>
        </select>
      </div>
      
      <!-- Performance Filter -->
      <div class="filter-group">
        <label>Performance:</label>
        <select 
          [value]="filters().performanceRating"
          (change)="updateFilters({ performanceRating: $any($event.target).value })"
        >
          <option value="all">All Ratings</option>
          <option value="excellent">Excellent (90%+)</option>
          <option value="good">Good (75-89%)</option>
          <option value="fair">Fair (60-74%)</option>
          <option value="poor">Poor (<60%)</option>
        </select>
      </div>
      
      <!-- Compliance Filter -->
      <div class="filter-group">
        <label>Compliance:</label>
        <select 
          [value]="filters().complianceStatus"
          (change)="updateFilters({ complianceStatus: $any($event.target).value })"
        >
          <option value="all">All Status</option>
          <option value="compliant">Compliant</option>
          <option value="warning">Warning</option>
          <option value="violation">Violation</option>
        </select>
      </div>
      
      <button class="btn btn-outline btn-sm" (click)="clearFilters()">
        <i class="icon-x"></i>
        Clear
      </button>
    </div>
    
    <div class="view-controls">
      <!-- Bulk Actions -->
      <div class="bulk-actions" *ngIf="selectedBranches().length > 0">
        <span class="selected-count">{{ selectedBranches().length }} selected</span>
        <button class="btn btn-sm btn-warning" (click)="bulkAction('deactivate')">
          Deactivate
        </button>
        <button class="btn btn-sm btn-danger" (click)="bulkAction('delete')">
          Delete
        </button>
        <button class="btn btn-sm btn-outline" (click)="clearSelection()">
          Clear
        </button>
      </div>
      
      <!-- View Mode Toggle -->
      <div class="view-toggle">
        <button 
          class="view-btn"
          [class.active]="viewMode() === 'table'"
          (click)="setViewMode('table')"
          title="Table View"
        >
          <i class="icon-list"></i>
        </button>
        <button 
          class="view-btn"
          [class.active]="viewMode() === 'grid'"
          (click)="setViewMode('grid')"
          title="Grid View"
        >
          <i class="icon-grid"></i>
        </button>
      </div>
      
      <!-- Page Size -->
      <div class="page-size">
        <label>Show:</label>
        <select 
          [value]="pageSize()"
          (change)="setPageSize(+$any($event.target).value)"
        >
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading()">
    <div class="loading-spinner"></div>
    <p>Loading branches...</p>
  </div>

  <!-- Branch List Content -->
  <div class="branch-content" *ngIf="!isLoading()">
    
    <!-- Table View -->
    <div class="table-view" *ngIf="viewMode() === 'table'">
      <div class="table-container">
        <table class="branches-table">
          <thead>
            <tr>
              <th class="select-column">
                <input 
                  type="checkbox"
                  (change)="onSelectAllChange($event)"
                >
              </th>
              <th 
                class="sortable"
                [class.sorted]="sortBy() === 'branchName'"
                [class.asc]="sortDirection() === 'asc'"
                [class.desc]="sortDirection() === 'desc'"
                (click)="setSortBy('branchName')"
              >
                Branch Name
                <i class="sort-icon icon-chevron-up"></i>
              </th>
              <th 
                class="sortable"
                [class.sorted]="sortBy() === 'managerName'"
                (click)="setSortBy('managerName')"
              >
                Manager
                <i class="sort-icon icon-chevron-up"></i>
              </th>
              <th 
                class="sortable"
                [class.sorted]="sortBy() === 'region'"
                (click)="setSortBy('region')"
              >
                Region
                <i class="sort-icon icon-chevron-up"></i>
              </th>
              <th>Status</th>
              <th 
                class="sortable"
                [class.sorted]="sortBy() === 'performanceRating'"
                (click)="setSortBy('performanceRating')"
              >
                Performance
                <i class="sort-icon icon-chevron-up"></i>
              </th>
              <th>Compliance</th>
              <th 
                class="sortable"
                [class.sorted]="sortBy() === 'monthlyRevenue'"
                (click)="setSortBy('monthlyRevenue')"
              >
                Monthly Revenue
                <i class="sort-icon icon-chevron-up"></i>
              </th>
              <th 
                class="sortable"
                [class.sorted]="sortBy() === 'lastActivity'"
                (click)="setSortBy('lastActivity')"
              >
                Last Activity
                <i class="sort-icon icon-chevron-up"></i>
              </th>
              <th class="actions-column">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr 
              *ngFor="let branch of paginatedBranches(); trackBy: trackByBranchId"
              class="branch-row"
              [class.selected]="selectedBranches().includes(branch.branchId)"
            >
              <td class="select-column">
                <input 
                  type="checkbox"
                  [checked]="selectedBranches().includes(branch.branchId)"
                  (change)="toggleBranchSelection(branch.branchId)"
                >
              </td>
              
              <td class="branch-name">
                <div class="branch-info">
                  <strong>{{ branch.branchName }}</strong>
                  <small>{{ branch.address }}</small>
                </div>
              </td>
              
              <td>{{ branch.managerName }}</td>
              
              <td>
                <span class="region-badge">{{ branch.region }}</span>
              </td>
              
              <td>
                <span 
                  class="status-badge"
                  [class]="getStatusClass(branch)"
                >
                  {{ getBranchStatus(branch) | titlecase }}
                </span>
              </td>
              
              <td>
                <div class="performance-indicator">
                  <div 
                    class="performance-bar"
                    [class]="getPerformanceClass(branch.performanceRating)"
                  >
                    <div 
                      class="performance-fill"
                      [style.width.%]="branch.performanceRating"
                    ></div>
                  </div>
                  <span class="performance-value">{{ branch.performanceRating }}%</span>
                </div>
              </td>
              
              <td>
                <span 
                  class="compliance-badge"
                  [class]="getComplianceClass(branch.complianceStatus)"
                >
                  {{ branch.complianceStatus | titlecase }}
                </span>
              </td>
              
              <td>{{ formatCurrency(branch.monthlyRevenue) }}</td>
              
              <td>
                <span class="activity-time">{{ formatTimeAgo(branch.lastActivity) }}</span>
              </td>
              
              <td class="actions-column">
                <div class="action-buttons">
                  <button 
                    class="action-btn"
                    (click)="viewBranchDetails(branch.branchId)"
                    title="View Details"
                  >
                    <i class="icon-eye"></i>
                  </button>
                  
                  <button 
                    class="action-btn"
                    (click)="editBranch(branch.branchId)"
                    title="Edit Branch"
                  >
                    <i class="icon-edit"></i>
                  </button>
                  
                  <button 
                    class="action-btn danger"
                    (click)="deactivateBranch(branch.branchId)"
                    *ngIf="getBranchStatus(branch) === 'active'"
                    title="Deactivate Branch"
                  >
                    <i class="icon-power"></i>
                  </button>
                  
                  <button 
                    class="action-btn danger"
                    (click)="deleteBranch(branch.branchId)"
                    title="Delete Branch"
                  >
                    <i class="icon-trash-2"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Grid View -->
    <div class="grid-view" *ngIf="viewMode() === 'grid'">
      <div class="branches-grid">
        <div 
          *ngFor="let branch of paginatedBranches(); trackBy: trackByBranchId"
          class="branch-card"
          [class.selected]="selectedBranches().includes(branch.branchId)"
        >
          <div class="card-header">
            <div class="card-title">
              <input 
                type="checkbox"
                [checked]="selectedBranches().includes(branch.branchId)"
                (change)="toggleBranchSelection(branch.branchId)"
                class="card-checkbox"
              >
              <h3>{{ branch.branchName }}</h3>
            </div>
            
            <div class="card-actions">
              <button 
                class="action-btn"
                (click)="viewBranchDetails(branch.branchId)"
                title="View Details"
              >
                <i class="icon-eye"></i>
              </button>
              
              <button 
                class="action-btn"
                (click)="editBranch(branch.branchId)"
                title="Edit Branch"
              >
                <i class="icon-edit"></i>
              </button>
            </div>
          </div>
          
          <div class="card-content">
            <div class="branch-detail">
              <i class="icon-user"></i>
              <span>{{ branch.managerName }}</span>
            </div>
            
            <div class="branch-detail">
              <i class="icon-map-pin"></i>
              <span>{{ branch.region }}</span>
            </div>
            
            <div class="branch-detail">
              <i class="icon-home"></i>
              <span>{{ branch.address }}</span>
            </div>
            
            <div class="status-row">
              <span 
                class="status-badge"
                [class]="getStatusClass(branch)"
              >
                {{ getBranchStatus(branch) | titlecase }}
              </span>
              
              <span 
                class="compliance-badge"
                [class]="getComplianceClass(branch.complianceStatus)"
              >
                {{ branch.complianceStatus | titlecase }}
              </span>
            </div>
            
            <div class="metrics-row">
              <div class="metric">
                <label>Performance</label>
                <div class="performance-indicator">
                  <div 
                    class="performance-bar"
                    [class]="getPerformanceClass(branch.performanceRating)"
                  >
                    <div 
                      class="performance-fill"
                      [style.width.%]="branch.performanceRating"
                    ></div>
                  </div>
                  <span>{{ branch.performanceRating }}%</span>
                </div>
              </div>
              
              <div class="metric">
                <label>Monthly Revenue</label>
                <span class="revenue-value">{{ formatCurrency(branch.monthlyRevenue) }}</span>
              </div>
            </div>
            
            <div class="card-footer">
              <span class="activity-info">
                Last activity: {{ formatTimeAgo(branch.lastActivity) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredBranches().length === 0 && !isLoading()">
      <div class="empty-icon">
        <i class="icon-git-branch"></i>
      </div>
      <h3>No branches found</h3>
      <p>
        <ng-container *ngIf="filters().search || filters().status !== 'all' || filters().region">
          Try adjusting your filters or <button class="link-btn" (click)="clearFilters()">clear all filters</button>.
        </ng-container>
        <ng-container *ngIf="!filters().search && filters().status === 'all' && !filters().region">
          Get started by creating your first branch.
        </ng-container>
      </p>
      <button 
        class="btn btn-primary"
        (click)="createNewBranch()"
      >
        <i class="icon-plus"></i>
        Add New Branch
      </button>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-section" *ngIf="!isLoading() && totalPages() > 1">
    <div class="pagination-info">
      Showing {{ (currentPage() - 1) * pageSize() + 1 }} to 
      {{ Math.min(currentPage() * pageSize(), filteredBranches().length) }} 
      of {{ filteredBranches().length }} branches
    </div>
    
    <div class="pagination-controls">
      <button 
        class="page-btn"
        [disabled]="currentPage() === 1"
        (click)="setPage(currentPage() - 1)"
      >
        <i class="icon-chevron-left"></i>
      </button>
      
      <button 
        *ngFor="let page of [].constructor(totalPages()); let i = index"
        class="page-btn"
        [class.active]="currentPage() === i + 1"
        [class.hidden]="totalPages() > 10 && Math.abs((i + 1) - currentPage()) > 2 && (i + 1) !== 1 && (i + 1) !== totalPages()"
        (click)="setPage(i + 1)"
      >
        {{ i + 1 }}
      </button>
      
      <button 
        class="page-btn"
        [disabled]="currentPage() === totalPages()"
        (click)="setPage(currentPage() + 1)"
      >
        <i class="icon-chevron-right"></i>
      </button>
    </div>
  </div>
</div>