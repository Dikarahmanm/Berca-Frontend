<!-- Transfer Creation Dialog - Custom Style Following Facture Management -->
<div class="transfer-creation-container">
  <!-- Header -->
  <div class="creation-header">
    <div class="header-left">
      <div class="header-icon">üì¶</div>
      <div class="header-info">
        <h1 class="creation-title">
          {{ data.mode === 'emergency' ? 'Emergency Transfer' : 'Create Transfer' }}
        </h1>
        <p class="creation-subtitle">Create a new inventory transfer between branches</p>
      </div>
    </div>
    <div class="header-right">
      <button class="btn btn-outline btn-sm" (click)="onCancel()">
        ‚úï Close
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="text-secondary">Creating transfer...</p>
  </div>

  <!-- Form Content -->
  <div *ngIf="!loading()" class="creation-content">
    <form [formGroup]="transferForm" class="transfer-form">

      <!-- Basic Information Section -->
      <div class="info-section transfer-info-section">
        <h3 class="section-title">Transfer Information</h3>
        <div class="form-content">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Source Branch *</label>
              <select formControlName="sourceBranchId" class="form-select" required>
                <option value="">Select source branch...</option>
                <option *ngFor="let branch of branches(); trackBy: trackByBranch" [value]="branch.id">
                  {{ branch.branchName }}
                </option>
              </select>
              <div class="form-error" *ngIf="transferForm.get('sourceBranchId')?.touched && transferForm.get('sourceBranchId')?.errors?.['required']">
                Source branch is required
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Destination Branch *</label>
              <select formControlName="destinationBranchId" class="form-select" required>
                <option value="">Select destination branch...</option>
                <option *ngFor="let branch of branches(); trackBy: trackByBranch" [value]="branch.id">
                  {{ branch.branchName }}
                </option>
              </select>
              <div class="form-error" *ngIf="transferForm.get('destinationBranchId')?.touched && transferForm.get('destinationBranchId')?.errors?.['required']">
                Destination branch is required
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Priority *</label>
              <select formControlName="priority" class="form-select" required>
                <option [value]="TransferPriority.Low">üîΩ Low Priority</option>
                <option [value]="TransferPriority.Normal">‚ûñ Normal Priority</option>
                <option [value]="TransferPriority.High">üî¥ High Priority</option>
                <option [value]="TransferPriority.Emergency">‚ö†Ô∏è Emergency</option>
              </select>
              <div class="form-error" *ngIf="transferForm.get('priority')?.touched && transferForm.get('priority')?.errors?.['required']">
                Priority is required
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Expected Delivery Date</label>
              <input type="date" formControlName="estimatedDeliveryDate" class="form-input">
              <div class="form-hint">Leave empty for auto-calculation</div>
            </div>
          </div>

          <div class="form-group full-width">
            <label class="form-label">Notes</label>
            <textarea formControlName="notes" class="form-textarea" rows="3"
                      placeholder="Additional notes or special instructions..."></textarea>
          </div>
        </div>
      </div>

      <!-- Transfer Items Section -->
      <div class="info-section transfer-items-section">
        <div class="section-header">
          <h3 class="section-title">Transfer Items</h3>
          <div class="section-summary">
            Total Items: {{ totalItems() }} | Total Quantity: {{ totalQuantity() }}
          </div>
        </div>

        <div class="items-content">
          <!-- Add Item Controls -->
          <div class="add-item-section">
            <button type="button" class="btn btn-primary" (click)="addTransferItem()">
              ‚ûï Add Item
            </button>
          </div>

          <!-- Items List -->
          <div *ngIf="transferItemsArray.length > 0" class="items-list">
            <div *ngFor="let item of transferItemsArray.controls; let i = index; trackBy: trackByItemIndex"
                 class="item-row" [formGroup]="$any(item)">

              <div class="item-content">
                <!-- Product Selection -->
                <div class="item-field product-field">
                  <label class="field-label">Product *</label>
                  <div class="product-input-container">
                    <input type="text"
                           formControlName="productName"
                           class="form-input"
                           placeholder="Search product..."
                           [attr.data-dropdown-index]="i"
                           (input)="filterProducts($any($event.target).value)"
                           (focus)="showProductDropdownAt(i)"
                           (blur)="hideProductDropdown(i)"
                           readonly>
                    <div class="product-dropdown"
                         [attr.data-dropdown-for]="i"
                         *ngIf="showProductDropdown[i] && filteredProducts().length > 0">
                      <div *ngFor="let product of filteredProducts(); trackBy: trackByProduct"
                           class="product-option"
                           (mousedown)="selectProduct(product, i)">
                        <div class="product-name">{{ product.name }}</div>
                        <div class="product-code">{{ product.barcode }}</div>
                        <div class="product-stock">Stock: {{ product.stock }}</div>
                      </div>
                    </div>
                    <button type="button" class="product-search-btn" (click)="toggleProductDropdown(i)">
                      üîç
                    </button>
                  </div>
                  <div class="form-error" *ngIf="item.get('productName')?.touched && item.get('productName')?.errors?.['required']">
                    Product is required
                  </div>
                </div>

                <!-- Quantity -->
                <div class="item-field quantity-field">
                  <label class="field-label">Quantity *</label>
                  <input type="number"
                         formControlName="quantity"
                         class="form-input"
                         min="1"
                         placeholder="0">
                  <div class="form-error" *ngIf="item.get('quantity')?.touched && item.get('quantity')?.errors?.['min']">
                    Quantity must be at least 1
                  </div>
                </div>

                <!-- Available Stock -->
                <div class="item-field stock-field">
                  <label class="field-label">Available</label>
                  <div class="stock-info">
                    <span class="stock-value">{{ item.get('availableStock')?.value || 0 }}</span>
                    <button type="button"
                            class="btn btn-secondary btn-sm"
                            [disabled]="!item.get('productId')?.value"
                            (click)="checkAvailableSources(item.get('productId')?.value, item.get('quantity')?.value)"
                            title="Check available sources">
                      üîç
                    </button>
                  </div>
                </div>

                <!-- Actions -->
                <div class="item-field actions-field">
                  <button type="button"
                          class="btn btn-danger btn-sm"
                          (click)="removeTransferItem(i)"
                          title="Remove item">
                    üóëÔ∏è Remove
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- No Items State -->
          <div *ngIf="transferItemsArray.length === 0" class="no-items">
            <div class="no-items-icon">üì¶</div>
            <p class="no-items-text">No items added yet</p>
            <p class="no-items-subtitle">Click "Add Item" to start building your transfer</p>
          </div>
        </div>
      </div>

      <!-- Available Sources Section -->
      <div *ngIf="availableSources().length > 0" class="info-section">
        <h3 class="section-title">Available Source Branches</h3>
        <div class="form-content">
          <div class="sources-grid">
            <div *ngFor="let source of availableSources(); trackBy: trackBySource"
                 class="source-card"
                 [class.selected]="transferForm.get('sourceBranchId')?.value === source.branchId">
              <div class="source-header">
                <strong class="source-name">{{ source.branchName }}</strong>
                <span class="source-distance">{{ source.distance }}km</span>
              </div>
              <div class="source-details">
                <div class="source-stock">Stock: {{ source.availableQuantity }}</div>
                <div class="source-cost">Est. Cost: {{ formatCurrency(source.estimatedCost) }}</div>
              </div>
              <button type="button"
                      class="btn btn-primary btn-sm"
                      (click)="transferForm.patchValue({sourceBranchId: source.branchId})"
                      [disabled]="transferForm.get('sourceBranchId')?.value === source.branchId">
                {{ transferForm.get('sourceBranchId')?.value === source.branchId ? 'Selected' : 'Select' }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Cost Estimation Section -->
      <div *ngIf="estimatedCost() > 0 || estimatedDelivery()" class="info-section estimation-section">
        <h3 class="section-title">Transfer Estimation</h3>
        <div class="estimation-content">
          <div class="estimation-grid">
            <div *ngIf="estimatedCost() > 0" class="estimation-item">
              <div class="estimation-icon">üí∞</div>
              <div class="estimation-details">
                <span class="estimation-label">Estimated Cost</span>
                <span class="estimation-value">{{ formatCurrency(estimatedCost()) }}</span>
              </div>
              <div *ngIf="calculating()" class="estimation-loading">
                <div class="loading-spinner small"></div>
              </div>
            </div>

            <div *ngIf="estimatedDelivery()" class="estimation-item">
              <div class="estimation-icon">‚è∞</div>
              <div class="estimation-details">
                <span class="estimation-label">Estimated Delivery</span>
                <span class="estimation-value">{{ formatDate(estimatedDelivery()!) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Actions -->
  <div class="creation-actions">
    <button type="button" class="btn btn-outline" (click)="onCancel()" [disabled]="loading()">
      Cancel
    </button>

    <button type="submit"
            class="btn btn-primary"
            (click)="onSubmit()"
            [disabled]="loading() || transferForm.invalid || transferItemsArray.length === 0">
      <span *ngIf="loading()" class="btn-spinner">
        <div class="loading-spinner small"></div>
      </span>
      <span *ngIf="!loading()">
        {{ data.mode === 'emergency' ? 'Create Emergency Transfer' : 'Create Transfer' }}
      </span>
    </button>
  </div>
</div>