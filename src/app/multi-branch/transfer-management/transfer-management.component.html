<div class="transfer-management-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon>swap_horiz</mat-icon>
          Transfer Inventory
        </h1>
        <p class="page-subtitle">Multi-branch inventory transfer management</p>
      </div>

      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="onCreateTransfer()">
          <mat-icon>add</mat-icon>
          Buat Transfer
        </button>

        <button mat-icon-button (click)="onRefresh()" [disabled]="loading()" matTooltip="Refresh">
          <mat-icon [class.spinning]="loading()">refresh</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Analytics Cards -->
  @if (analytics(); as data) {
    <div class="analytics-cards">
      <div class="analytics-card">
        <div class="card-icon-section">
          <mat-icon class="card-icon total">inventory</mat-icon>
          <div class="card-content">
            <div class="card-value">{{ data.totalTransfers }}</div>
            <div class="card-label">Total Transfer</div>
          </div>
        </div>
      </div>

      <div class="analytics-card">
        <div class="card-icon-section">
          <mat-icon class="card-icon pending">schedule</mat-icon>
          <div class="card-content">
            <div class="card-value">{{ data.pendingTransfers }}</div>
            <div class="card-label">Menunggu Approval</div>
          </div>
        </div>
      </div>

      <div class="analytics-card">
        <div class="card-icon-section">
          <mat-icon class="card-icon in-transit">local_shipping</mat-icon>
          <div class="card-content">
            <div class="card-value">{{ data.inTransitTransfers }}</div>
            <div class="card-label">Dalam Perjalanan</div>
          </div>
        </div>
      </div>

      <div class="analytics-card">
        <div class="card-icon-section">
          <mat-icon class="card-icon completed">check_circle</mat-icon>
          <div class="card-content">
            <div class="card-value">{{ formatCurrency(data.totalTransferValue) }}</div>
            <div class="card-label">Total Nilai Transfer</div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Emergency Suggestions Alert -->
  @if (emergencySuggestions().length > 0) {
    <div class="emergency-alert">
      <div class="emergency-header">
        <div class="emergency-title">
          <mat-icon class="emergency-icon">warning</mat-icon>
          Transfer Darurat Diperlukan
        </div>
        <div class="emergency-subtitle">
          {{ emergencySuggestions().length }} produk memerlukan transfer darurat
        </div>
      </div>
      <div class="emergency-content">
        <div class="emergency-suggestions">
          @for (suggestion of emergencySuggestions().slice(0, 3); track suggestion.id) {
            <div class="emergency-item">
              <div class="suggestion-content">
                <div class="product-info">
                  <strong>{{ suggestion.productName }}</strong>
                  <span class="product-code">({{ suggestion.productCode }})</span>
                </div>
                <div class="branch-info">
                  <span class="branch-name">{{ suggestion.destinationBranchName }}</span>
                  <span [class]="getUrgencyClass(suggestion.urgencyLevel)" class="urgency-badge">
                    {{ suggestion.urgencyLevel }}
                  </span>
                </div>
                <div class="quantity-info">
                  Stock: {{ suggestion.currentStock }} / Min: {{ suggestion.minimumStock }}
                  <span class="suggested-qty">(Saran: {{ suggestion.suggestedQuantity }})</span>
                </div>
              </div>
              <div class="suggestion-actions">
                <button mat-raised-button color="warn" size="small"
                        (click)="onCreateEmergencyTransfer(suggestion)">
                  <mat-icon>flash_on</mat-icon>
                  Buat Transfer
                </button>
              </div>
            </div>
          }
        </div>
        @if (emergencySuggestions().length > 3) {
          <div class="more-suggestions">
            <button mat-button color="primary">
              Lihat {{ emergencySuggestions().length - 3 }} lainnya
            </button>
          </div>
        }
      </div>
    </div>
  }

  <!-- Search and Filters -->
  <div class="filters-section">
    <div class="search-filters">
      <!-- Search Input -->
      <form [formGroup]="searchForm">
        <mat-form-field class="search-field">
          <mat-label>Cari transfer...</mat-label>
          <input matInput formControlName="searchTerm"
                 placeholder="Nomor transfer, cabang, produk...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </form>

      <!-- Filter Form -->
      <form [formGroup]="filterForm" class="filter-form">
        <mat-form-field>
          <mat-label>Status</mat-label>
          <mat-select formControlName="status" multiple>
            <mat-option [value]="TransferStatus.Pending">{{ getStatusDisplayText(TransferStatus.Pending) }}</mat-option>
            <mat-option [value]="TransferStatus.Approved">{{ getStatusDisplayText(TransferStatus.Approved) }}</mat-option>
            <mat-option [value]="TransferStatus.InTransit">{{ getStatusDisplayText(TransferStatus.InTransit) }}</mat-option>
            <mat-option [value]="TransferStatus.Completed">{{ getStatusDisplayText(TransferStatus.Completed) }}</mat-option>
            <mat-option [value]="TransferStatus.Cancelled">{{ getStatusDisplayText(TransferStatus.Cancelled) }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Prioritas</mat-label>
          <mat-select formControlName="priority" multiple>
            <mat-option [value]="TransferPriority.Low">{{ getPriorityDisplayText(TransferPriority.Low) }}</mat-option>
            <mat-option [value]="TransferPriority.Normal">{{ getPriorityDisplayText(TransferPriority.Normal) }}</mat-option>
            <mat-option [value]="TransferPriority.High">{{ getPriorityDisplayText(TransferPriority.High) }}</mat-option>
            <mat-option [value]="TransferPriority.Emergency">{{ getPriorityDisplayText(TransferPriority.Emergency) }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Cabang Asal</mat-label>
          <mat-select formControlName="sourceBranchId">
            @for (branch of branches(); track branch.id) {
              <mat-option [value]="branch.id">{{ branch.branchName }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Cabang Tujuan</mat-label>
          <mat-select formControlName="destinationBranchId">
            @for (branch of branches(); track branch.id) {
              <mat-option [value]="branch.id">{{ branch.branchName }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Tanggal Mulai</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="dateFrom">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Tanggal Akhir</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="dateTo">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <div class="filter-toggles">
          <mat-slide-toggle formControlName="onlyOverdue">
            Hanya yang Terlambat
          </mat-slide-toggle>
          <mat-slide-toggle formControlName="onlyEmergency">
            Hanya Darurat
          </mat-slide-toggle>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Content with Tabs -->
  <div class="main-content">
    <mat-tab-group [selectedIndex]="selectedTab()" (selectedIndexChange)="onTabChange($event)">
      <!-- All Transfers Tab -->
      <mat-tab label="Semua Transfer">
        <ng-template mat-tab-label>
          <span>Semua Transfer</span>
          <span class="tab-count">{{ transfers().length }}</span>
        </ng-template>
      </mat-tab>

      <!-- Pending Tab -->
      <mat-tab label="Menunggu Approval">
        <ng-template mat-tab-label>
          <span>Menunggu Approval</span>
          @if (pendingCount() > 0) {
            <span class="tab-count pending">{{ pendingCount() }}</span>
          }
        </ng-template>
      </mat-tab>

      <!-- In Transit Tab -->
      <mat-tab label="Dalam Perjalanan">
        <ng-template mat-tab-label>
          <span>Dalam Perjalanan</span>
          @if (inTransitCount() > 0) {
            <span class="tab-count in-transit">{{ inTransitCount() }}</span>
          }
        </ng-template>
      </mat-tab>

      <!-- Completed Tab -->
      <mat-tab label="Selesai">
        <ng-template mat-tab-label>
          <span>Selesai</span>
          @if (completedCount() > 0) {
            <span class="tab-count completed">{{ completedCount() }}</span>
          }
        </ng-template>
      </mat-tab>

      <!-- Emergency Tab -->
      <mat-tab label="Darurat">
        <ng-template mat-tab-label>
          <span>Darurat</span>
          @if (emergencyCount() > 0) {
            <span class="tab-count emergency">{{ emergencyCount() }}</span>
          }
        </ng-template>
      </mat-tab>
    </mat-tab-group>

    <!-- Transfer Table -->
    <div class="table-container">
      @if (loading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Memuat data transfer...</p>
        </div>
      } @else if (error()) {
        <div class="error-container">
          <mat-icon class="error-icon">error</mat-icon>
          <p class="error-message">{{ error() }}</p>
          <button mat-raised-button color="primary" (click)="onRefresh()">
            <mat-icon>refresh</mat-icon>
            Coba Lagi
          </button>
        </div>
      } @else {
        <table mat-table [dataSource]="filteredTransfers()" matSort (matSortChange)="onSortChange($event)" class="transfer-table">
          <!-- Transfer Number Column -->
          <ng-container matColumnDef="transferNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Nomor Transfer</th>
            <td mat-cell *matCellDef="let transfer">
              <div class="transfer-number-cell">
                <strong>{{ transfer.transferNumber }}</strong>
                @if (isOverdue(transfer)) {
                  <mat-icon class="overdue-icon" matTooltip="Transfer terlambat">schedule</mat-icon>
                }
              </div>
            </td>
          </ng-container>

          <!-- Source Branch Column -->
          <ng-container matColumnDef="sourceBranch">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Cabang Asal</th>
            <td mat-cell *matCellDef="let transfer">
              <div class="branch-cell">
                <mat-icon class="branch-icon">store</mat-icon>
                {{ transfer.sourceBranchName }}
              </div>
            </td>
          </ng-container>

          <!-- Destination Branch Column -->
          <ng-container matColumnDef="destinationBranch">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Cabang Tujuan</th>
            <td mat-cell *matCellDef="let transfer">
              <div class="branch-cell">
                <mat-icon class="branch-icon">store</mat-icon>
                {{ transfer.destinationBranchName }}
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let transfer">
              <span [class]="getStatusBadgeClass(transfer.status)" class="status-badge">
                {{ getStatusDisplayText(transfer.status) }}
              </span>
            </td>
          </ng-container>

          <!-- Priority Column -->
          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Prioritas</th>
            <td mat-cell *matCellDef="let transfer">
              <span [class]="getPriorityBadgeClass(transfer.priority)" class="priority-badge">
                {{ getPriorityDisplayText(transfer.priority) }}
              </span>
            </td>
          </ng-container>

          <!-- Requested At Column -->
          <ng-container matColumnDef="requestedAt">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tanggal Permintaan</th>
            <td mat-cell *matCellDef="let transfer">
              <div class="date-cell">
                {{ formatDate(transfer.requestedAt) }}
                <div class="requester">oleh {{ transfer.requestedByName }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Total Items Column -->
          <ng-container matColumnDef="totalItems">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Jumlah Item</th>
            <td mat-cell *matCellDef="let transfer">
              <div class="items-cell">
                <mat-icon class="items-icon">inventory_2</mat-icon>
                {{ transfer.totalItems }} item
              </div>
            </td>
          </ng-container>

          <!-- Total Cost Column -->
          <ng-container matColumnDef="totalCost">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Total Biaya</th>
            <td mat-cell *matCellDef="let transfer">
              <div class="cost-cell">
                {{ formatCurrency(transfer.totalCost) }}
              </div>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Aksi</th>
            <td mat-cell *matCellDef="let transfer">
              <div class="actions-cell">
                <button mat-icon-button
                        [matMenuTriggerFor]="actionMenu"
                        aria-label="More actions">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #actionMenu="matMenu">
                  <button mat-menu-item (click)="onViewTransfer(transfer)">
                    <mat-icon>visibility</mat-icon>
                    <span>Lihat Detail</span>
                  </button>

                  @if (canPerformAction(transfer, 'approve')) {
                    <button mat-menu-item (click)="onApproveTransfer(transfer)">
                      <mat-icon>check_circle</mat-icon>
                      <span>Setujui</span>
                    </button>
                  }

                  @if (canPerformAction(transfer, 'cancel')) {
                    <button mat-menu-item (click)="onCancelTransfer(transfer)" class="warn-action">
                      <mat-icon>cancel</mat-icon>
                      <span>Batalkan</span>
                    </button>
                  }

                  <button mat-menu-item>
                    <mat-icon>print</mat-icon>
                    <span>Print</span>
                  </button>
                </mat-menu>

                <!-- Quick Action Buttons -->
                @if (canPerformAction(transfer, 'approve')) {
                  <button mat-mini-fab
                          color="primary"
                          (click)="onApproveTransfer(transfer)"
                          matTooltip="Setujui Transfer"
                          class="quick-action">
                    <mat-icon>check</mat-icon>
                  </button>
                }
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [class.overdue-row]="isOverdue(row)"
              [class.emergency-row]="row.priority === TransferPriority.Emergency">
          </tr>
        </table>

        <!-- No Data Message -->
        @if (filteredTransfers().length === 0) {
          <div class="no-data-container">
            <mat-icon class="no-data-icon">inventory</mat-icon>
            <h3>Tidak ada data transfer</h3>
            <p>Belum ada transfer yang sesuai dengan filter yang dipilih.</p>
            <button mat-raised-button color="primary" (click)="onCreateTransfer()">
              <mat-icon>add</mat-icon>
              Buat Transfer Baru
            </button>
          </div>
        }
      }
    </div>

    <!-- Pagination -->
    @if (totalCount() > 0) {
      <mat-paginator
        [length]="totalCount()"
        [pageSize]="queryParams().pageSize || 10"
        [pageIndex]="(queryParams().page || 1) - 1"
        [pageSizeOptions]="[5, 10, 25, 50]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    }
  </div>
</div>