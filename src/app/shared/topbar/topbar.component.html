<!-- Topbar Component - Clean Structure -->
<header class="topbar">
  <div class="topbar-container">
    
    <!-- Left Section - Brand and Mobile Menu -->
    <div class="topbar-left">
      <!-- Mobile Menu Toggle -->
      <button class="mobile-menu-toggle" 
              *ngIf="showMenuToggle || isMobile"
              (click)="menuToggleClicked.emit()"
              matTooltip="Toggle Menu"
              matTooltipPosition="below">
        <mat-icon>menu</mat-icon>
      </button>

      <div class="brand" (click)="navigateHome()">
        <div class="brand-logo">
          <mat-icon>store</mat-icon>
        </div>
        <span class="brand-text" [class.hidden-mobile]="isMobile">Toko Eniwan</span>
      </div>
    </div>

    <!-- Center Section - Page Title -->
    <div class="topbar-center">
      <h1 class="page-title">{{ pageTitle }}</h1>
    </div>

    <!-- Right Section - Actions -->
    <div class="topbar-right">
      
      <!-- ===== NEW: Branch Selector ===== -->
      <div class="branch-selector-wrapper" *ngIf="accessibleBranches().length > 0 && canSwitchBranches()">
        <button 
          class="branch-selector-btn"
          (click)="toggleBranchDropdown()"
          [class.active]="branchDropdownOpen()"
          [disabled]="branchLoading()"
          matTooltip="Switch Branch"
          matTooltipPosition="below">
          
          <div class="branch-selector-content">
            <mat-icon class="branch-icon">{{ getBranchIcon(activeBranch() || accessibleBranches()[0]) }}</mat-icon>
            
            <div class="branch-info" *ngIf="!isMobile">
              <span class="branch-name">{{ branchDisplayText() }}</span>
              <span class="branch-type" *ngIf="!isMultiSelectMode()">{{ activeBranch()?.branchType }}</span>
            </div>
            
            <mat-icon class="dropdown-arrow" *ngIf="!branchLoading()">expand_more</mat-icon>
            <mat-spinner *ngIf="branchLoading()" diameter="16"></mat-spinner>
          </div>
        </button>

        <!-- Branch Dropdown -->
        <div class="custom-dropdown branch-dropdown" *ngIf="branchDropdownOpen()" (click)="$event.stopPropagation()">
          
          <!-- Header -->
          <div class="dropdown-header">
            <div class="branch-header-content">
              <h3 class="dropdown-title">Select Branch</h3>
              <p class="dropdown-subtitle">Choose your working branch</p>
            </div>
            
            <!-- Multi-select toggle -->
            <button 
              class="multi-select-toggle"
              (click)="toggleMultiSelectMode()"
              *ngIf="!isMultiSelectMode() && accessibleBranches().length > 1"
              matTooltip="Enable multi-branch selection">
              <mat-icon>select_all</mat-icon>
            </button>
          </div>

          <!-- Search -->
          <div class="branch-search" *ngIf="accessibleBranches().length > 4">
            <div class="search-input-wrapper">
              <mat-icon class="search-icon">search</mat-icon>
              <input 
                type="text"
                class="search-input"
                placeholder="Search branches..."
                [value]="branchSearchQuery()"
                (input)="onBranchSearchChange($event)">
            </div>
          </div>

          <!-- Branch List -->
          <div class="branch-list">
            <div 
              *ngFor="let branch of filteredBranches(); trackBy: trackByBranch" 
              class="branch-item"
              [class.selected]="isBranchSelected(branch.branchId)"
              [class.head-office]="branch.isHeadOffice"
              [style.padding-left]="(branch.level * 16) + 'px'"
              (click)="selectBranch(branch.branchId)">
              
              <!-- Multi-select checkbox -->
              <input 
                *ngIf="isMultiSelectMode()" 
                type="checkbox"
                class="branch-checkbox"
                [checked]="isBranchSelected(branch.branchId)"
                (click)="toggleBranchSelection(branch.branchId, $event)">
              
              <!-- Branch Icon -->
              <mat-icon class="branch-item-icon">{{ getBranchIcon(branch) }}</mat-icon>
              
              <!-- Branch Info -->
              <div class="branch-info">
                <span class="branch-name">{{ branch.branchName }}</span>
                <div class="branch-meta">
                  <small class="branch-code">{{ branch.branchCode }}</small>
                  <span class="branch-separator">â€¢</span>
                  <small class="branch-type">{{ branch.branchType }}</small>
                </div>
              </div>

              <!-- Access Level Badge -->
              <div class="access-level-badge" 
                   [style.color]="getBranchAccessLevelColor(branch.accessLevel)">
                <mat-icon [matTooltip]="branch.accessLevel + ' Access'">{{ getBranchAccessLevelIcon(branch.accessLevel) }}</mat-icon>
              </div>

              <!-- Selection Indicator -->
              <div class="selection-indicator" *ngIf="isBranchSelected(branch.branchId)">
                <mat-icon>check_circle</mat-icon>
              </div>
            </div>
            
            <!-- Empty State -->
            <div class="empty-state" *ngIf="filteredBranches().length === 0">
              <mat-icon>search_off</mat-icon>
              <p>No branches found</p>
              <small>Try adjusting your search</small>
            </div>
          </div>

          <!-- Multi-select Footer -->
          <div class="dropdown-footer" *ngIf="isMultiSelectMode()">
            <div class="multi-select-summary">
              <span class="selected-count">{{ selectedBranchIds().length }} branches selected</span>
            </div>
            
            <div class="multi-select-actions">
              <button class="action-btn secondary" (click)="clearBranchSelection()">
                <mat-icon>clear</mat-icon>
                Clear
              </button>
              
              <button class="action-btn primary" (click)="branchDropdownOpen.set(false)">
                <mat-icon>done</mat-icon>
                Done
              </button>
            </div>
          </div>

          <!-- Refresh Action -->
          <div class="dropdown-refresh" *ngIf="!isMultiSelectMode()">
            <button class="refresh-btn" (click)="refreshBranchData()" [disabled]="branchLoading()">
              <mat-icon [class.spinning]="branchLoading()">refresh</mat-icon>
              <span>Refresh</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Enhanced Unified Notifications -->
      <app-unified-notification-center>
      </app-unified-notification-center>

      <!-- Profile -->
      <div class="profile-wrapper">
        <button 
          class="profile-btn"
          (click)="toggleProfileDropdown()"
          [class.active]="showProfileDropdown">
          
          <div class="profile-avatar">
            <img *ngIf="userPhoto; else avatarInitials" [src]="userPhoto" [alt]="username">
            <ng-template #avatarInitials>
              <span>{{ getInitials(username) }}</span>
            </ng-template>
          </div>
          
          <div class="profile-info" *ngIf="!isMobile">
            <span class="profile-name">{{ username }}</span>
            <span class="profile-role">{{ getRoleDisplay(role) }}</span>
          </div>
          
          <mat-icon class="profile-arrow" *ngIf="!isMobile">expand_more</mat-icon>
        </button>

        <!-- Custom Profile Dropdown -->
        <div class="custom-dropdown profile-dropdown" *ngIf="showProfileDropdown" (click)="$event.stopPropagation()">
          
          <!-- Header -->
          <div class="dropdown-header">
            <div class="profile-header-content">
              <div class="profile-avatar-large">
                <img *ngIf="userPhoto; else avatarInitialsLarge" [src]="userPhoto" [alt]="username">
                <ng-template #avatarInitialsLarge>
                  <span>{{ getInitials(username) }}</span>
                </ng-template>
              </div>
              <div class="profile-details">
                <h3 class="profile-name-large">{{ username || 'Guest User' }}</h3>
                <p class="profile-role-large">{{ getRoleDisplay(role) }}</p>
                <div class="status-indicator">
                  <div class="status-dot"></div>
                  <span>Online</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Content -->
          <div class="dropdown-body">
            <div class="menu-section">
              <h4 class="section-title">Account</h4>
              
              <div class="menu-item" (click)="navigateToProfile()">
                <div class="menu-item-icon">
                  <mat-icon>person</mat-icon>
                </div>
                <div class="menu-item-content">
                  <span class="menu-item-title">Edit Profile</span>
                </div>
                <mat-icon class="menu-item-arrow">chevron_right</mat-icon>
              </div>

              <div class="menu-item" (click)="navigateToSettings()">
                <div class="menu-item-icon">
                  <mat-icon>settings</mat-icon>
                </div>
                <div class="menu-item-content">
                  <span class="menu-item-title">Settings</span>
                </div>
                <mat-icon class="menu-item-arrow">chevron_right</mat-icon>
              </div>
            </div>

            <div class="menu-section">
              <h4 class="section-title">Preferences</h4>
              
              <div class="menu-item toggle-item" (click)="toggleTheme()">
                <div class="menu-item-icon">
                  <mat-icon>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</mat-icon>
                </div>
                <div class="menu-item-content">
                  <span class="menu-item-title">{{ isDarkMode ? 'Light Mode' : 'Dark Mode' }}</span>
                </div>
                <div class="toggle-switch" [class.active]="isDarkMode">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="dropdown-footer">
            <div class="menu-item logout-item" (click)="logout()" [class.disabled]="isLoggingOut">
              <div class="menu-item-icon">
                <mat-icon *ngIf="!isLoggingOut">logout</mat-icon>
                <mat-spinner *ngIf="isLoggingOut" diameter="20"></mat-spinner>
              </div>
              <div class="menu-item-content">
                <span class="menu-item-title">
                  {{ isLoggingOut ? 'Logging out...' : 'Logout' }}
                </span>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</header>