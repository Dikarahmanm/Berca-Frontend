<!-- src/app/shared/topbar/topbar.html -->
<!-- ✅ REAL DATA INTEGRATION: Template menggunakan data real dari backend -->
<!-- Menghilangkan semua mock data dan menggunakan NotificationService -->

<header class="topbar">
    <div class="topbar-container">

        <!-- ===== LEFT SECTION - BRAND ===== -->
        <div class="topbar-left">
            <div class="brand" (click)="navigateTo('/dashboard')" role="button" tabindex="0"
                (keydown.enter)="navigateTo('/dashboard')" (keydown.space)="navigateTo('/dashboard')">
                <div class="brand-logo">
                    <mat-icon>store</mat-icon>
                </div>
                <span class="brand-text">Toko Eniwan</span>
            </div>
        </div>

        <!-- ===== CENTER SECTION - PAGE TITLE ===== -->
        <div class="topbar-center">
            <h1 class="page-title">{{ pageTitle }}</h1>
        </div>

        <!-- ===== RIGHT SECTION - ACTIONS ===== -->
        <div class="topbar-right">

            <!-- ✅ REAL NOTIFICATION SECTION dengan Backend Data -->
            <div class="notification-section">
                <button class="notification-button" [matMenuTriggerFor]="notificationMenu" matTooltip="Notifikasi"
                    [matBadge]="notificationBadgeText" [matBadgeHidden]="!hasUnreadNotifications" matBadgeColor="warn"
                    matBadgeSize="small" [disabled]="isLoadingNotifications" aria-label="Open notifications">

                    <!-- Loading spinner atau icon notifikasi -->
                    <mat-icon *ngIf="!isLoadingNotifications">notifications</mat-icon>
                    <mat-icon *ngIf="isLoadingNotifications" class="spin">refresh</mat-icon>
                </button>

                <!-- ✅ REAL Notification Dropdown Menu dengan Backend Data -->
                <mat-menu #notificationMenu="matMenu" class="notification-dropdown" xPosition="before">

                    <!-- Header dengan real count -->
                    <div class="notification-header" (click)="$event.stopPropagation()">
                        <div class="notification-title">
                            <mat-icon>notifications</mat-icon>
                            <span>{{ notificationDropdownTitle }}</span>
                        </div>

                        <!-- Actions -->
                        <div class="notification-header-actions">
                            <!-- Refresh button -->
                            <button mat-icon-button (click)="refreshNotifications()" matTooltip="Refresh"
                                [disabled]="isLoadingNotifications">
                                <mat-icon [class.spin]="isLoadingNotifications">refresh</mat-icon>
                            </button>

                            <!-- Mark all read button -->
                            <button mat-icon-button (click)="markAllNotificationsAsRead()"
                                matTooltip="Tandai Semua Dibaca"
                                [disabled]="!hasUnreadNotifications || isLoadingNotifications">
                                <mat-icon>done_all</mat-icon>
                            </button>

                            <!-- View all button -->
                            <button mat-icon-button (click)="navigateToNotifications()" matTooltip="Lihat Semua">
                                <mat-icon>open_in_new</mat-icon>
                            </button>
                        </div>
                    </div>

                    <mat-divider></mat-divider>

                    <!-- ✅ REAL Notification Items dari Backend -->
                    <div class="notification-list" (click)="$event.stopPropagation()">

                        <!-- Loading state -->
                        <div *ngIf="isLoadingNotifications" class="notification-loading">
                            <mat-icon class="spin">refresh</mat-icon>
                            <p>Memuat notifikasi...</p>
                        </div>

                        <!-- Error state -->
                        <div *ngIf="shouldShowNotificationError" class="notification-error">
                            <mat-icon>error</mat-icon>
                            <p>{{ notificationError }}</p>
                            <button mat-button (click)="refreshNotifications()">
                                <mat-icon>refresh</mat-icon>
                                Coba Lagi
                            </button>
                        </div>

                        <!-- Real notification items dari backend -->
                        <div *ngFor="let notification of recentNotifications; trackBy: trackByNotificationId"
                            class="notification-item" [class.unread]="!notification.isRead"
                            [class]="getNotificationTypeClass(notification.type)"
                            (click)="onNotificationClick(notification)">

                            <div class="notification-icon" [class]="getNotificationTypeClass(notification.type)">
                                <mat-icon>{{ getNotificationIcon(notification.type) }}</mat-icon>
                            </div>

                            <div class="notification-content">
                                <div class="notification-text">
                                    <h4>{{ notification.title }}</h4>
                                    <p>{{ truncateText(notification.message, 80) }}</p>
                                </div>
                                <div class="notification-time">
                                    {{ getRelativeTime(notification.createdAt) }}
                                </div>
                            </div>

                            <!-- Unread indicator -->
                            <div *ngIf="!notification.isRead" class="unread-dot"></div>
                        </div>

                        <!-- Empty state - tidak ada notifikasi -->
                        <div *ngIf="!isLoadingNotifications && !shouldShowNotificationError && !hasNotifications"
                            class="notification-empty">
                            <mat-icon>notifications_none</mat-icon>
                            <p>Tidak ada notifikasi</p>
                        </div>
                    </div>

                    <mat-divider *ngIf="hasNotifications"></mat-divider>

                    <!-- Footer Action - View All -->
                    <div class="notification-footer" (click)="$event.stopPropagation()" *ngIf="hasNotifications">
                        <button mat-button class="view-all-button" (click)="navigateToNotifications()">
                            <mat-icon>visibility</mat-icon>
                            Lihat Semua Notifikasi
                        </button>
                    </div>
                </mat-menu>
            </div>

            <!-- ✅ PROFILE SECTION dengan User Data Real -->
            <div class="profile-section">
                <button class="profile-button" [matMenuTriggerFor]="profileMenu" matTooltip="Profile Menu"
                    aria-label="Open profile menu">

                    <div class="profile-avatar">
                        <img *ngIf="avatarUrl; else avatarInitials" [src]="avatarUrl" [alt]="username + ' avatar'"
                            (error)="avatarUrl = ''">

                        <ng-template #avatarInitials>
                            <div class="avatar-initials">
                                {{ getInitials(username) }}
                            </div>
                        </ng-template>
                    </div>
                </button>

                <!-- Profile Dropdown Menu -->
                <mat-menu #profileMenu="matMenu" class="profile-dropdown" xPosition="before">

                    <!-- Profile Header dengan Real User Data -->
                    <div class="profile-header" (click)="$event.stopPropagation()">
                        <div class="profile-avatar-large">
                            <img *ngIf="avatarUrl; else avatarInitialsLarge" [src]="avatarUrl"
                                [alt]="username + ' avatar'" (error)="avatarUrl = ''">

                            <ng-template #avatarInitialsLarge>
                                <div class="avatar-initials-large">
                                    {{ getInitials(username) }}
                                </div>
                            </ng-template>
                        </div>

                        <div class="profile-details">
                            <h4>{{ username || 'Guest User' }}</h4>
                            <p>{{ roleDisplayMap[role] || role || 'User' }}</p>
                        </div>
                    </div>

                    <mat-divider></mat-divider>

                    <!-- Profile Menu Items -->
                    <button mat-menu-item (click)="navigateToProfile()">
                        <mat-icon>person</mat-icon>
                        <span>Edit Profile</span>
                    </button>

                    <button mat-menu-item (click)="navigateToSettings()">
                        <mat-icon>settings</mat-icon>
                        <span>Pengaturan</span>
                    </button>

                    <button mat-menu-item (click)="showChangeUserDialog()">
                        <mat-icon>swap_horiz</mat-icon>
                        <span>Ganti User</span>
                    </button>

                    <mat-divider></mat-divider>

                    <!-- Logout dengan loading state -->
                    <button mat-menu-item class="logout-item" (click)="logout()" [disabled]="isLoading">
                        <mat-icon>logout</mat-icon>
                        <span>Logout</span>

                        <!-- Loading spinner saat logout -->
                        <div *ngIf="isLoading" class="loading-spinner">
                            <mat-icon class="spin">refresh</mat-icon>
                        </div>
                    </button>
                </mat-menu>
            </div>

        </div>
    </div>
</header>

<!-- ✅ REAL DATA DEBUG INFO (hanya untuk development) -->
<div *ngIf="false" class="debug-info">
    <p>Real Data Debug:</p>
    <p>Notification Count: {{ notificationCount }}</p>
    <p>Recent Notifications: {{ recentNotifications.length }}</p>
    <p>Loading: {{ isLoadingNotifications }}</p>
    <p>Error: {{ notificationError }}</p>
    <p>Username: {{ username }}</p>
    <p>Role: {{ role }}</p>
</div>